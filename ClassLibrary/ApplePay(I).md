

- **ApplePayå†…è´­é›†æˆ**
	- æ²™ç®±æµ‹è¯•è´¦å·åˆ›å»º
- **åè®°**
	- æ²™ç›’è´¦å·æ³¨æ„äº‹é¡¹
	- å…³äºè¯ä¹¦çš„é—®é¢˜
- **è‹¹æœå†…è´­ä¸¤ç§æ¨¡å¼**
	- æœåŠ¡å™¨æ¨¡å¼
	- æœ¬åœ°æ¨¡å¼
- **å…¶ä»–æ”¯ä»˜**
- **å‚è€ƒèµ„æ–™**




<br/>

***
<br/>

[Apple Pay å†…è´­å®˜æ–¹æ–‡æ¡£](https://help.apple.com/app-store-connect/#/devae49fb316)

># **ApplePayå†…è´­é›†æˆ**

![å†…è´­é…ç½®å›¾](https://upload-images.jianshu.io/upload_images/2959789-19fe47b5f5540bdd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

<br/>

&emsp;  åœ¨Apple å†…è´­ä¸­ï¼Œä¸€ä¸ªå†…è´­é¡¹ç›®éœ€è¦ç”³è¯·ä¸€ä¸ªï¼Œæ¯”å¦‚ï¼šæˆ‘ç”³è¯·æœˆã€å¹´ã€ç»ˆèº«VIPï¼Œå°±éœ€è¦å¢åŠ 3ä¸ªå†…è´­é¡¹ç›®ã€‚å¦‚ä¸‹å›¾ï¼š

![3ä¸ªå†…è´­é¡¹ç›®ç”³è¯·æœˆã€å¹´ã€ç»ˆèº«](https://upload-images.jianshu.io/upload_images/2959789-3eb73663fe9f234c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

&emsp;  åœ¨æ¯ä¸ªå†…è´­é¡¹ç›®ä¸­ï¼Œå…¶å®šä»·åªèƒ½æŒ‰ç…§è‹¹æœç»™çš„æ¥è¿›è¡Œè®¾å€¼ï¼Œè‡ªå·±ä¸èƒ½éšä¾¿è¿›è¡Œè®¾å€¼çš„ã€‚å¦‚ä¸‹å›¾ï¼š

![å†…è´­ä»·æ ¼è®¾å€¼](https://upload-images.jianshu.io/upload_images/2959789-43e4c55c7aac623f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)




<br/>
<br/>

- **æ²™ç®±æµ‹è¯•è´¦å·åˆ›å»º**

![é€‰æ‹©ç®­å¤´æ‰€æŒ‡çš„é€‰é¡¹](https://upload-images.jianshu.io/upload_images/2959789-057184762f6d01e5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![åˆ›å»ºæ²™ç®±è´¦å·](https://upload-images.jianshu.io/upload_images/2959789-819a980017a0e86f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


<br/>

> `æ²™ç›’è´¦å·ä½¿ç”¨æµç¨‹`

â‘   åœ¨iPhoneä¸Šå®‰è£…æµ‹è¯•åŒ…ï¼ˆå¿…é¡»æ˜¯adhocç­¾åè¯ä¹¦æˆ–è€…developç­¾åè¯ä¹¦æ‰“çš„åŒ…ï¼Œä¸èƒ½æ˜¯ä»App Storeä¸Šä¸‹è½½çš„ï¼‰ï¼›

â‘¡  é€€å‡ºè‡ªå·±iPhoneçš„App Storeè´¦å·ï¼ˆå› ä¸ºæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ²™ç›’è´¦å·ç™»å½•ï¼‰ï¼š

&emsp;  a.æ‰“å¼€App Storeåº”ç”¨é¦–é¡µæ»‘åˆ°æœ€ä¸‹æ–¹--é€‰ä¸­AppleID--æ³¨é”€;
      
&emsp;   b.è®¾ç½®--iTunes Storeä¸App Store--é€‰ä¸­AppleID--æ³¨é”€;

&emsp; &emsp;   åœ¨å•†åŸé€€å‡ºè‡ªå·±çš„Apple è´¦å·åï¼Œä¸è¦ä½¿ç”¨åˆšæ‰åœ¨æ²™ç›’ç”³è¯·çš„è´¦å·(æ²™ç›’è´¦å·æ˜¯ä¸€ä¸ªå‡çš„AppleIDè´¦å·ï¼Œä¸èƒ½ç›´æ¥ç™»å½•çš„ã€‚)ï¼Œé‚£æ ·æ˜¯ç™»å½•ä¸è¿›å»çš„ã€‚å¦åˆ™ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
![æ— æ³•ä½¿ç”¨æ²™ç›’æµ‹è¯•è´¦å·æµ‹è¯•](https://upload-images.jianshu.io/upload_images/2959789-97c7ad8e09466ef6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

&emsp;  `æ²™ç›’è´¦å·`æ˜¯åœ¨å®‰è£…æµ‹è¯•åŒ…å†…è´­ä¹°å•†å“æ—¶ï¼Œç³»ç»Ÿä¼šè®©ä½ è¿›è¡Œç™»å½•ï¼Œè¿™æ—¶æˆ‘ä»¬ç‚¹å‡»â€œä½¿ç”¨ç°æœ‰çš„AppleIDâ€å°±å¯ä»¥è¾“å…¥åˆšæ‰åˆ›å»ºå¥½çš„æ²™ç›’æµ‹è¯•è´¦å·è¿›è¡Œç™»å½•äº†ã€‚

> `æµ‹è¯•ä½¿ç”¨æ²™ç›’æµ‹è¯•è´¦å·ç™»å½•ä½¿ç”¨`

&emsp;  åœ¨æµ‹è¯•åŒ…é‡Œé¢è´­ä¹°å•†å“VIPæ—¶ï¼Œç³»ç»Ÿä¼šè®©ä½ è¿›è¡Œç™»å½•ï¼Œè¿™é‡Œæˆ‘ä»¬ç‚¹å‡»â€œä½¿ç”¨ç°æœ‰çš„AppleIDâ€å°±å¯ä»¥è¾“å…¥åˆšæ‰åˆ›å»ºå¥½çš„æ²™ç›’æµ‹è¯•è´¦å·è¿›è¡Œç™»å½•äº†ã€‚

![ä½¿ç”¨ç”³è¯·çš„æ²™ç›’è´¦å·ç™»å½•](https://upload-images.jianshu.io/upload_images/2959789-908bbae69d3f64a8.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


<br/>

&emsp;  è¾“å…¥è´¦å·ä¹‹åï¼Œæœ‰å¯èƒ½ä¼šå‡ºç°æç¤º`" æ­¤Apple ID åªèƒ½åœ¨iTunes Store ä¸­å›½åº—é¢è´­ä¹°ï¼Œæ‚¨å°†è¢«è·³è½¬è‡³è¯¥é¡µé¢"`ï¼Œç‚¹å‡»ç¡®å®šä¹‹åä¼šè·³è½¬åˆ°App Storeï¼Œå¯¼è‡´è¿™æ¬¡è´­ä¹°å¤±è´¥ã€‚æ²¡å…³ç³»ï¼Œæˆ‘ä»¬å†æ¬¡å›åˆ°æµ‹è¯•åŒ…ï¼Œç„¶åè´­ä¹°å•†å“å°±å¥½äº†ã€‚

&emsp;  åŸå› ï¼šå‡ºç°æç¤ºçš„åŸå› ï¼šå› ä¸ºAppleIDæ˜¯åˆ†åœ°åŒºçš„ã€‚ä¹‹å‰æˆ‘ä»¬åˆ›å»ºæ²™ç›’è´¦å·çš„æ—¶å€™å°±çœ‹åˆ°äº†ï¼Œéœ€è¦é€‰æ‹©åœ°åŒºã€‚App Storeä¹Ÿæ˜¯åˆ†åœ°åŒºçš„ï¼Œå¯¹åº”çš„AppleIDåªèƒ½åœ¨App Storeå¯¹åº”çš„åœ°åŒºè¿›è¡Œä¸‹è½½å’Œè´­ä¹°ä¸œè¥¿ã€‚æˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„[harleyTest@123.com](è¿™ä¸ªè´¦å·çš„åœ°åŒºæ˜¯ä¸­å›½ï¼Œæ‰€ä»¥åªèƒ½åœ¨ä¸­å›½åº—é¢ç™»å½•ã€‚ç”±äºæˆ‘ä¹‹å‰çš„ç™»å½•çš„è´¦å·è¶Šå—çš„ï¼Œæ‰€ä»¥æ­¤æ—¶AppStoreåº—é¢æ˜¯è¶Šå—åº—é¢ã€‚æ‰€ä»¥æˆ‘ä»¬è¿™æ¬¡ç™»å½•ï¼Œç³»ç»Ÿä¼šè·³è½¬åˆ°AppStoreåº”ç”¨å°†åº—é¢åˆ‡æ¢åˆ°ä¸­å›½ã€‚å¦å¤–ï¼ŒApp Storeåº”ç”¨åˆ‡æ¢åœ°åŒºçš„æ—¶å€™ï¼Œä¼šæŠ¥ã€Your request produced an errorã€‘ã€‚è¿™ä¸ªä¸éœ€è¦ç®¡ã€‚

<br/>

**`ç‚¹å‡»è´­ä¹°è§†é¢‘VIPä¹‹åï¼ŒæˆåŠŸçš„ä¼šå‡ºç°å¦‚ä¸‹ç›¸åº”æç¤º`**

![ä½¿ç”¨ç”³è¯·çš„æ²™ç›’è´¦å·å¯†ç è¿›è¡Œä»˜æ¬¾](https://upload-images.jianshu.io/upload_images/2959789-21350e55f0f0c6d1.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æ³¨æ„äº‹é¡¹ï¼šåœ¨App Store Connectä¸Šåˆ›å»ºå•†å“äº†ä¹‹åï¼Œé™¤äº†éœ€è¦å¡«å•†å“IDï¼Œå•†å“åç§°ï¼Œå•†å“æè¿°ï¼Œä»·æ ¼ç­‰ä¹‹å¤–ï¼Œè¿˜è¦ä¸Šä¼ ä¸€å¼ å›¾ç‰‡ï¼Œå›¾ç‰‡å°±æ˜¯ä¸Šé¢è¿™ä¸ªç•Œé¢ã€‚


<br/>

***
<br/>

># åè®°

<br/>

- **`æ²™ç›’è´¦å·æ³¨æ„äº‹é¡¹:`**
&emsp; a. BudleIDï¼Œè¯ä¹¦ï¼Œå•†å“IDç­‰å†…å®¹ä¸€è‡´ï¼Œæ‰èƒ½è¿›è¡Œæ¥ä¸‹æ¥çš„å‚¨å€¼æµ‹è¯•;

&emsp; b. æµ‹è¯•è®¾å¤‡éœ€è¦ä½¿ç”¨ä¸è¶Šç‹±çš„çœŸæœºï¼ˆè¶Šç‹±æœºä¸èƒ½è¿›è¡Œæ²™ç›’å‚¨å€¼ï¼Œæ¨¡æ‹Ÿå™¨ä¹Ÿä¸èƒ½è¿›è¡Œæ²™ç›’å‚¨å€¼ï¼‰

&emsp; c. æ²™ç›’è´¦å·æ˜¯ä¸èƒ½ç›´æ¥åœ¨App Storeè¿›è¡Œç™»å½•çš„ï¼Œåªèƒ½åœ¨ç‚¹å‡»äº†è´­ä¹°å•†å“ä¹‹åï¼Œåœ¨å¼¹å‡ºçš„ç™»å½•æ¡†è¿›è¡Œç™»å½•ã€‚

&emsp; d. çœŸå®çš„AppleIDä¸èƒ½åœ¨adhocè¯ä¹¦å’Œdevelopè¯ä¹¦æ‰“å‡ºæ¥çš„åŒ…è¿›è¡Œæ²™ç›’å‚¨å€¼æµ‹è¯•ï¼Œæ‰€ä»¥åœ¨æ²™ç›’æµ‹è¯•ä¹‹å‰ï¼Œéœ€è¦é€€å‡ºçœŸå®çš„AppleIDè´¦å·

&emsp; e. ä»App Storeä¸Šé¢ä¸‹è½½çš„åŒ…ä¸èƒ½ä½¿ç”¨æ²™ç›’è´¦å·è¿›è¡Œå‚¨å€¼


<br/>

- **`å…³äºè¯ä¹¦çš„é—®é¢˜ï¼š`**
&emsp; a .ä½¿ç”¨developç­¾åè¯ä¹¦å’Œadhocç­¾åè¯ä¹¦æ‰“çš„ipaåŒ…ï¼Œæˆ‘æŠŠä»–ä»¬å«åšæµ‹è¯•åŒ…ï¼Œæµ‹è¯•åŒ…åªèƒ½ä½¿ç”¨æ²™ç›’è´¦å·è¿›è¡Œå‚¨å€¼ï¼Œä¸èƒ½ä½¿ç”¨çœŸå®çš„AppleIDè¿›è¡Œå‚¨å€¼
&emsp; b.ä»App Storeåº”ç”¨ä¸‹è½½çš„åŒ…ï¼Œæˆ‘æŠŠä»–ä»¬å«åšçº¿ä¸ŠåŒ…ï¼Œçº¿ä¸ŠåŒ…åªèƒ½ä½¿ç”¨çœŸå®çš„AppleIDè¿›è¡Œå‚¨å€¼ï¼Œä¸èƒ½ä½¿ç”¨æ²™ç›’è´¦å·è¿›è¡Œå‚¨å€¼


<br/>

- **`å°çªé—¨ï¼š`**

&emsp; â‘  å¹³å¸¸æˆ‘ä»¬ä¸Šä¼ åŒ…çš„æ—¶å€™æ˜¯æ‰“åŒ…äº†ipaåŒ…ä¹‹åï¼Œä½¿ç”¨Xcodeé‡Œé¢çš„Application Loaderåº”ç”¨ä¸Šä¼ ipaåŒ…çš„ï¼›
&emsp; â‘  è™½ç„¶å¾ˆå¤šäººä¸Šä¼ åŒ…ä½¿ç”¨çš„æ˜¯appstoreçš„ç­¾åè¯ä¹¦ï¼Œä½†æ˜¯ï¼Œå…¶å®ä½¿ç”¨adhocçš„è¯ä¹¦æ‰“åŒ…çš„ipaåŒ…ä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸ä¸Šä¼ å¹¶ä¸”é€å®¡ä¸Šçº¿çš„ã€‚æˆ‘å¹³å¸¸å°±æ˜¯ç”¨adhocçš„è¯ä¹¦æ‰“åŒ…æˆipaåŒ…ï¼Œç»™æµ‹è¯•å¦¹å­æµ‹è¯•ï¼Œæµ‹è¯•å®Œç›´æ¥ç”¨è¿™ä¸ªåŒ…ä¸Šä¼ é€å®¡äº†ã€‚ğŸ˜†ã€‚


<br/>

***
<br/>

>#  è‹¹æœå†…è´­ä¸¤ç§æ¨¡å¼

- **`æœåŠ¡å™¨æ¨¡å¼`**


>a.  è°ƒç”¨æœåŠ¡å™¨æ¥å£åˆ›å»ºä¸€ä¸ªå•†å“çš„è®¢å•;

>b.  è¯·æ±‚Appleçš„å•†å“åˆ—è¡¨;

>c.  é€‰å–å•†å“è°ƒç”¨è‹¹æœæ”¯ä»˜;

>d.  æ”¯ä»˜æˆåŠŸï¼ˆä¼šè¿”å›å‡­è¯ï¼‰;

>e.  æŠŠæ”¯ä»˜æˆåŠŸçš„è¿”å›å‡­è¯ä¸Šä¼ åˆ°APPæœåŠ¡å™¨ï¼ˆå¸¦ä¸Šè®¢å•çš„IDï¼Œæœ‰åˆ©äºåå°åˆ¤æ–­æ˜¯å“ªä¸ªè®¢å•æ”¯ä»˜æˆåŠŸï¼‰;

>f.  APPæœåŠ¡å™¨ä¿å­˜è¯¥å‡­è¯ç­‰æ•°æ®å¹¶åƒè‹¹æœæœåŠ¡å™¨å‘èµ·å‡­è¯éªŒè¯ï¼ŒéªŒè¯æˆåŠŸåˆ™å‘é€å•†å“ã€‚


<br/>

- **`æœ¬åœ°æ¨¡å¼`**

>a.  è¯·æ±‚Appleçš„å•†å“åˆ—è¡¨;

>b.  é€‰å–å•†å“è°ƒç”¨è‹¹æœæ”¯ä»˜;

>c.  æ”¯ä»˜æˆåŠŸï¼ˆä¼šè¿”å›å‡­è¯ï¼‰;

>d.  æŠŠå‡­è¯ä¸å•†å“å‘é€çŠ¶æ€ä¿å­˜åˆ°ä¸€ä¸ªæœ¬åœ°çš„æ•°æ®åº“;

>e.  appè°ƒç”¨appleæœåŠ¡å™¨çš„éªŒè¯API;

>f.  éªŒè¯æˆåŠŸå‘é€å•†å“å¹¶æ”¹å˜æ•°æ®åº“çš„ç‰©å“å‘é€çŠ¶æ€;


<br/>

- **`æ ¸å¿ƒä»£ç `**

```
//å¯¼å…¥æ–‡ä»¶ï¼š
#import <StoreKit/StoreKit.h>
#pragma mark -- ApplePay
//äº§å“IDå·
#define ApplePayInPurchase          @"com.tianYingXinXi.XXX"

//éµå®ˆSKPaymentTransactionObserverã€SKProductsRequestDelegateåè®®
@interface VIPMemberController ()<UITextViewDelegate, SKPaymentTransactionObserver, SKProductsRequestDelegate>



//è®¾ç½®æ”¯ä»˜æœåŠ¡
[[SKPaymentQueue defaultQueue] addTransactionObserver:self];

[self applePayWithVIP];

//ç»“æŸåä¸€å®šè¦é”€æ¯
- (void)dealloc
{
    [[SKPaymentQueue defaultQueue] removeTransactionObserver:self];
}

- (void) applePayWithVIP {
    if ([SKPaymentQueue canMakePayments]) {
        NSLog(@"yes");
        
        [self getRequestAppleProductID:@"ProductID"];
    }else {
        NSLog(@"not");
    }
}


//è¯·æ±‚è‹¹æœåå°å•†å“
- (void) getRequestAppleProductID:(NSString *)productID {
    //ApplePayInPurchaseå¯¹åº”ç€è‹¹æœåå°çš„å•†å“ID,ä»–ä»¬æ˜¯é€šè¿‡è¿™ä¸ªIDè¿›è¡Œè”ç³»çš„
    NSArray *product = [[NSArray alloc] initWithObjects:ApplePayInPurchase , nil];
    NSSet *nsset = [NSSet setWithArray:product];
    
    //åˆå§‹åŒ–è¯·æ±‚
    SKProductsRequest *request = [[SKProductsRequest alloc] initWithProductIdentifiers:nsset];
    request.delegate = self;
    
    //å¼€å§‹è¯·æ±‚
    [request start];
}


#pragma mark -- SKProductsRequestDelegate
- (void)productsRequest:(SKProductsRequest *)request didReceiveResponse:(SKProductsResponse *)response {
    NSArray *product = response.products;
    
    //æœåŠ¡å™¨æ²¡æœ‰äº§å“
    if ([product count] == 0) {
        NSLog(@"æœåŠ¡å™¨æ²¡æœ‰äº§å“");
        return;
    }
    
    SKProduct *requestProduct = nil;
    for (SKProduct *pro in product) {
        NSLog(@"%@", [pro description]);
        NSLog(@"%@", [pro localizedTitle]);
        NSLog(@"%@", [pro localizedDescription]);
        NSLog(@"%@", [pro price]);
        NSLog(@"%@", [pro productIdentifier]);
        
        //å¦‚æœåå°æ¶ˆè´¹æ¡ç›®çš„IDä¸æˆ‘è¿™é‡Œéœ€è¦è¯·æ±‚çš„ä¸€æ ·ï¼ˆç”¨äºç¡®ä¿è®¢å•çš„æ­£ç¡®æ€§ï¼‰
        if ([pro.productIdentifier isEqualToString:ApplePayInPurchase]) {
            requestProduct = pro;
        }
    }
    
    
    //å‘é€è´­ä¹°è¯·æ±‚
    SKPayment *payment = [SKPayment paymentWithProduct:requestProduct];
    [[SKPaymentQueue defaultQueue] addPayment:payment];
}



#pragma mark -- SKRequestDelegate
//è¯·æ±‚å¤±è´¥
- (void)request:(SKRequest *)request didFailWithError:(NSError *)error {
    NSLog(@"è¯·æ±‚å¤±è´¥error: %@", error);
}
//åé¦ˆè¯·æ±‚çš„äº§å“ä¿¡æ¯ç»“æŸå
- (void)requestDidFinish:(SKRequest *)request{
    NSLog(@"ä¿¡æ¯åé¦ˆç»“æŸ");
}



#pragma mark -- SKPaymentTransactionObserver
//ç›‘å¬è´­ä¹°ç»“æœ
- (void)paymentQueue:(SKPaymentQueue *)queue updatedTransactions:(NSArray<SKPaymentTransaction *> *)transactions {
    for (SKPaymentTransaction *tran in transactions) {
        switch (tran.transactionState) {
            case SKPaymentTransactionStatePurchased://è´­ä¹°æˆåŠŸ
                NSLog(@"äº¤æ˜“å®Œæˆ");
                [self completeTransaction:tran];
                break;
                
            case SKPaymentTransactionStatePurchasing://æ­£åœ¨å¤„ç†
                NSLog(@"å•†å“æ·»åŠ è¿›åˆ—è¡¨");
                break;
                
            case SKPaymentTransactionStateRestored://æ¢å¤è´­ä¹°
                NSLog(@"å·²ç»è´­ä¹°è¿‡å•†å“");
                [[SKPaymentQueue defaultQueue] finishTransaction:tran];
                break;
                
            case SKPaymentTransactionStateFailed:
                NSLog(@"äº¤æ˜“å¤±è´¥");
                [[SKPaymentQueue defaultQueue] finishTransaction:tran];
                break;
                
            default:
                break;
        }
    }
}

//äº¤æ˜“ç»“æŸ,å½“äº¤æ˜“ç»“æŸåè¿˜è¦å»appstoreä¸ŠéªŒè¯æ”¯ä»˜ä¿¡æ¯æ˜¯å¦éƒ½æ­£ç¡®,åªæœ‰æ‰€æœ‰éƒ½æ­£ç¡®å,æˆ‘ä»¬å°±å¯ä»¥ç»™ç”¨æˆ·æ–¹æ³•æˆ‘ä»¬çš„è™šæ‹Ÿç‰©å“äº†
- (void) completeTransaction:(SKPaymentTransaction *)transaction {
    NSString *str = [[NSString alloc] initWithData:transaction.transactionReceipt encoding:NSUTF8StringEncoding];
    NSString *environment = [self environmentForReceipt:str];
    
    NSLog(@"----- å®Œæˆäº¤æ˜“è°ƒç”¨çš„æ–¹æ³•completeTransaction 1--------%@",environment);
    
    //éªŒè¯å‡­æ®ï¼Œè·å–åˆ°è‹¹æœè¿”å›çš„äº¤æ˜“å‡­æ®
    //éªŒè¯å‡­æ®ï¼Œè·å–åˆ°è‹¹æœè¿”å›çš„äº¤æ˜“å‡­æ®
    NSURL *receiptURL = [[NSBundle mainBundle] appStoreReceiptURL];
    //ä»æ²™ç›’ä¸­è·å–åˆ°è´­ä¹°å‡­æ®
    NSData *receiptData = [NSData dataWithContentsOfURL:receiptURL];
    

    //éªŒè¯è¿”å›çš„æ•°æ®ï¼Œé˜²æ­¢ç²¤è¯­(å®‰å…¨æ€§ä¸é«˜çš„å¯ä»¥ä¸ç”¨çœ‹ä¸‹é¢çš„ä»£ç )
    //å°è£…çš„éªŒè¯æ–¹æ³•
    /**
        NSString *receipt = [receiptData base64EncodedStringWithOptions:NSDataBase64Encoding64CharacterLineLength];
        if ([receipt length] > 0 && [productIdentifier length] > 0) {
        [SVProgressHUD showInfoWithStatus:@"æ”¯ä»˜æˆåŠŸ!"];
             //å¯ä»¥å°†receiptå‘ç»™æœåŠ¡å™¨è¿›è¡Œè´­ä¹°éªŒè¯
             [self dl_validateReceiptWiththeAppStore:receipt];
         }
    */

    //BASE64 å¸¸ç”¨çš„ç¼–ç æ–¹æ¡ˆï¼Œé€šå¸¸ç”¨äºæ•°æ®ä¼ è¾“ï¼Œä»¥åŠåŠ å¯†ç®—æ³•çš„åŸºç¡€ç®—æ³•ï¼Œä¼ è¾“è¿‡ç¨‹ä¸­èƒ½å¤Ÿä¿è¯æ•°æ®ä¼ è¾“çš„ç¨³å®šæ€§
    //BASE64æ˜¯å¯ä»¥ç¼–ç å’Œè§£ç çš„
    NSString *encodeStr = [receiptData base64EncodedStringWithOptions:NSDataBase64EncodingEndLineWithLineFeed];
    NSString *sendString = [NSString stringWithFormat:@"{\"receipt-data\" : \"%@\"}", encodeStr];
    NSLog(@"_____%@",sendString);
    NSURL *StoreURL=nil;
    if ([environment isEqualToString:@"environment=Sandbox"]) {
        StoreURL = [[NSURL alloc] initWithString:@"https://sandbox.itunes.apple.com/verifyReceipt"];
    }else {
        StoreURL = [[NSURL alloc] initWithString:@"https://buy.itunes.apple.com/verifyReceipt"];
    }
    
    //è¿™ä¸ªäºŒè¿›åˆ¶æ•°æ®ç”±æœåŠ¡å™¨è¿›è¡ŒéªŒè¯ï¼›zl
    NSData *postData = [NSData dataWithBytes:[sendString UTF8String] length:[sendString length]];
    
    NSLog(@"++++++%@",postData);
    NSMutableURLRequest *connectionRequest = [NSMutableURLRequest requestWithURL:StoreURL];
    
    [connectionRequest setHTTPMethod:@"POST"];
    [connectionRequest setTimeoutInterval:50.0];//120.0---50.0zl
    [connectionRequest setCachePolicy:NSURLRequestUseProtocolCachePolicy];
    [connectionRequest setHTTPBody:postData];
    
    //å¼€å§‹è¯·æ±‚
    NSError *error=nil;
    NSData *responseData=[NSURLConnection sendSynchronousRequest:connectionRequest returningResponse:nil error:&error];
    if (error) {
        NSLog(@"éªŒè¯è´­ä¹°è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯ï¼š%@",error.localizedDescription);
        return;
    }
    NSDictionary *dic=[NSJSONSerialization JSONObjectWithData:responseData options:NSJSONReadingAllowFragments error:nil];
    NSLog(@"è¯·æ±‚æˆåŠŸåçš„æ•°æ®:%@",dic);
    
    //è¿™é‡Œå¯ä»¥ç­‰å¾…ä¸Šé¢è¯·æ±‚çš„æ•°æ®å®Œæˆåå¹¶ä¸”state = 0 éªŒè¯å‡­æ®æˆåŠŸæ¥åˆ¤æ–­åè¿›å…¥è‡ªå·±æœåŠ¡å™¨é€»è¾‘çš„åˆ¤æ–­,ä¹Ÿå¯ä»¥ç›´æ¥è¿›è¡ŒæœåŠ¡å™¨é€»è¾‘çš„åˆ¤æ–­,éªŒè¯å‡­æ®ä¹Ÿå°±æ˜¯ä¸€ä¸ªå®‰å…¨çš„é—®é¢˜ã€‚æ¥¼ä¸»è¿™é‡Œæ²¡æœ‰ç”¨state = 0 æ¥åˆ¤æ–­ã€‚
    // [[SKPaymentQueue defaultQueue] finishTransaction: transaction];
    
    NSString *product = transaction.payment.productIdentifier;
    
    NSLog(@"transaction.payment.productIdentifier++++%@",product);
    
    if ([product length] > 0)
    {
        NSArray *tt = [product componentsSeparatedByString:@"."];
        
        NSString *bookid = [tt lastObject];
        
        if([bookid length] > 0)
        {
            
            NSLog(@"æ‰“å°bookid%@",bookid);
            //è¿™é‡Œå¯ä»¥åšæ“ä½œå§ç”¨æˆ·å¯¹åº”çš„è™šæ‹Ÿç‰©å“é€šè¿‡è‡ªå·±æœåŠ¡å™¨è¿›è¡Œä¸‹å‘æ“ä½œ,æˆ–è€…åœ¨è¿™é‡Œé€šè¿‡åˆ¤æ–­å¾—åˆ°ç”¨æˆ·å°†ä¼šå¾—åˆ°å¤šå°‘è™šæ‹Ÿç‰©å“,åœ¨åé¢ï¼ˆ[self getApplePayDataToServerRequsetWith:transaction];çš„åœ°æ–¹ï¼‰ä¸Šä¼ ä¸Šé¢è‡ªå·±çš„æœåŠ¡å™¨ã€‚
        }
    }
    //æ­¤æ–¹æ³•ä¸ºå°†è¿™ä¸€æ¬¡æ“ä½œä¸Šä¼ ç»™æˆ‘æœ¬åœ°æœåŠ¡å™¨,è®°å¾—åœ¨ä¸Šä¼ æˆåŠŸè¿‡åä¸€å®šè¦è®°å¾—é”€æ¯æœ¬æ¬¡æ“ä½œã€‚è°ƒç”¨[[SKPaymentQueue defaultQueue] finishTransaction: transaction];
//    [self getApplePayDataToServerRequsetWith:transaction];
    NSLog(@"--->> %@", transaction);
    

}

-(NSString * )environmentForReceipt:(NSString * )str
{
    str= [str stringByReplacingOccurrencesOfString:@"\r\n" withString:@""];
    
    str = [str stringByReplacingOccurrencesOfString:@"\n" withString:@""];
    
    str = [str stringByReplacingOccurrencesOfString:@"\t" withString:@""];
    
    str=[str stringByReplacingOccurrencesOfString:@" " withString:@""];
    
    str=[str stringByReplacingOccurrencesOfString:@"\"" withString:@""];
    
    NSArray * arr=[str componentsSeparatedByString:@";"];
    
    //å­˜å‚¨æ”¶æ®ç¯å¢ƒçš„å˜é‡
    NSString * environment=arr[2];
    return environment;
}


-(void)dl_validateReceiptWiththeAppStore:(NSString *)receipt
{
    NSError *error;
    NSDictionary *requestContents = @{@"receipt-data": receipt};
    NSData *requestData = [NSJSONSerialization dataWithJSONObject:requestContents options:0 error:&error];
    
    if (!requestData) {
    
    }else{
        
    }
    NSURL *storeURL;
#ifdef DEBUG
    storeURL = [NSURL URLWithString:@"https://sandbox.itunes.apple.com/verifyReceipt"];
#else
    storeURL = [NSURL URLWithString:@"https://buy.itunes.apple.com/verifyReceipt"];
#endif
    
    NSMutableURLRequest *storeRequest = [NSMutableURLRequest requestWithURL:storeURL];
    [storeRequest setHTTPMethod:@"POST"];
    [storeRequest setHTTPBody:requestData];
    NSOperationQueue *queue = [[NSOperationQueue alloc] init];
    [NSURLConnection sendAsynchronousRequest:storeRequest queue:queue
                           completionHandler:^(NSURLResponse *response, NSData *data, NSError *connectionError) {
                               if (connectionError) {
                                  /* å¤„ç†error */
                               } else {
                                   NSError *error;
                                   NSDictionary *jsonResponse = [NSJSONSerialization JSONObjectWithData:data options:0 error:&error];
                                   if (!jsonResponse) {
                                       /* å¤„ç†error */
                                   }else{
                                       /* å¤„ç†éªŒè¯ç»“æœ */
                                   }
                               }
                           }];

}

```


<br/>

***
<br/>

># å…¶ä»–æ”¯ä»˜

[å¼€å‘æ”¯ä»˜ç¯‡](https://www.cnblogs.com/TheYouth/p/6847014.html?utm_source=itdadao&utm_medium=referral)

[iOSé›†æˆApplePay](https://www.cnblogs.com/zhouxihi/p/6528133.html)

[Apple Pay-è‹¹æœæ”¯ä»˜](https://www.cnblogs.com/feiyu-mdm/p/5802111.html)

[Apple Payå¼€å‘æµç¨‹](https://www.jianshu.com/p/7ea225928726)

[Apple Pay ä¸ é“¶è” çš„é›†æˆ](https://www.jianshu.com/p/a3d03688fc5a)



<br/>

***
<br/>


># å‚è€ƒèµ„æ–™

[Apple Pay é›†æˆ(I)](https://www.jianshu.com/p/dd81d7ade732)

[App Storeæ— æ³•æˆåŠŸæ·»åŠ æ²™ç®±æŠ€æœ¯æµ‹è¯•å‘˜è´¦å·](http://ju.outofmemory.cn/entry/365183)

[è‹¹æœIAP(å†…è´­)ä¸­æ²™ç›’è´¦å·ä½¿ç”¨æ³¨æ„äº‹é¡¹](https://www.jianshu.com/p/1ef61a785508)

[ç”³è¯·æµç¨‹](http://baijiahao.baidu.com/s?id=1586198840331975300&wfr=spider&for=pc)

[IAPåº”ç”¨å†…è´­è¯¦ç»†æ­¥éª¤å’Œé—®é¢˜æ€»ç»“æŒ‡å—](https://www.jianshu.com/p/307a3b7cfd6c)

