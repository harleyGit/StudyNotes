






- 支付宝接入
- 错误解决

<br/>

***
<br/>


># 支付宝接入


- **CocoaPods 下载SDK**

```
//搜索最新版
$ pod search AlipaySDK-iOS

//找到最新版本：pod 'AlipaySDK-iOS', '~> 15.5.9',将其复制到Podfile文件中。
//删除Podfile.lock文件

//更新第三方类库文件
$pod update --verbose

``` 




- **使用AlipaySDK 文件**

在宏文件中导入AlipaySDK：`#import <AlipaySDK/AlipaySDK.h>`

**设置URL Type**'

【项目文件】->【TARGETS】->【项目名】->【info】->【URL Types】然后点击“ + ”在URL Schemes中命名一个名称字符串(最好是与项目有关的名字)。

```
# FloatLaverView.m 文件
//注意：有的后端一股脑把数据传过来没处理，需要前端取字段“params”和“sign”
NSString *orderInfo = [NSString stringWithFormat:@"%@&sign=%@", model[@"params"], model[@"sign"]];

//注意：URL Type中不能使用特殊字符，否则字符宝那边无法识别，如：@"taijidao://"
[[AlipaySDK defaultService] payOrder:orderInfo fromScheme:@"taijidao" callback:^(NSDictionary *resultDic) {
            //在版本 AlipaySDK-iOS 15.5.9 中，这里不支持回调了，需要在AppDelegate.m 文件中，对回调进行处理
        }];
    } failure:^(id  _Nonnull fail) {
        [SVProgressHUD showErrorWithStatus:@"支付异常!"];
    }];


# AppDelegate.m 文件
- (BOOL)application:(UIApplication *)app openURL:(NSURL *)url options:(NSDictionary<UIApplicationOpenURLOptionsKey,id> *)options {
    
    if ([url.host isEqualToString:@"safepay"]) {
        //支付宝跳转支付宝钱包进行支付，处理支付结果
        [[AlipaySDK defaultService] processOrderWithPaymentResult:url standbyCallback:^(NSDictionary *resultDic) {
            
            if ([resultDic[@"resultStatus"] integerValue] == 9000) {
                [SVProgressHUD showSuccessWithStatus:@"支付成功!"];
                [[NSNotificationCenter defaultCenter] postNotificationName:aliPaySuccess object:nil];
            }else {
                [SVProgressHUD showSuccessWithStatus:@"支付异常!"];
                [[NSNotificationCenter defaultCenter] postNotificationName:aliPaySuccess object:nil];
            }
        }];
        
        //授权跳转支付宝钱包进行支付，处理支付结果
        [[AlipaySDK defaultService] processAuth_V2Result:url standbyCallback:^(NSDictionary *resultDic) {
            //解析 auth Code
            NSString *result = resultDic[@"result"];
            NSString *authCode = nil;
            if (result.length > 0) {
                NSArray *resultArr = [result componentsSeparatedByString:@"&"];
                for (NSString *subResult in resultArr) {
                    if (subResult.length > 10 && [subResult hasPrefix:@"auth_code="]) {
                        authCode = [subResult substringFromIndex:10];
                        break;
                    }
                }
            }
            NSLog(@"支付宝授权结果 authCode = %@", authCode?:@"");
        }];
    }
    
    return YES;
}
```


<br/>

***
<br/>

># 错误解决


![阿里SDK拷入报错](https://upload-images.jianshu.io/upload_images/2959789-425451f4076cb987.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![阿里SDK加入依赖库](https://upload-images.jianshu.io/upload_images/2959789-09b6dd62ca06f8ab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

&emsp; 这是许多开发者在使用阿里SDK遇到的坑之一，当我们按照阿里的指示将它所说的SDK宝导入工程中，并按照指示加入依赖库，如：【阿里SDK加入依赖库】所示。等加完依赖库后，我们发现报错继续存在，没有解决。报错仍然如图：【[阿里SDK拷入报错】所示，好像陷入了死循环。

&emsp; How do you do ?

&emsp; 这时查百度，发现这样做是可以的。将原阿里SDK的第三方库删除扔掉垃圾篓，将阿里的Demo拷入到项目中，再运行发现完美运行。问题解决！！


[支付宝支付集成](https://www.cnblogs.com/demodashi/p/8486502.html)

[支付宝支付集成实现](https://www.jianshu.com/p/a62a4793e84f)

[蚂蚁金服iOS支付集成](https://docs.open.alipay.com/204/105295/)




<br/>

***
<br/>


># 参考资料


[支付宝开发](https://docs.open.alipay.com/204/105295/)
