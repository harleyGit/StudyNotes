> å·¥ç¨‹çŸ¥è¯†ç‚¹
- [ç¼“å­˜Redis](#ç¼“å­˜Redis)
  - [ç¼“å­˜æ—¶é—´è®¾ç½®è§„åˆ™](#ç¼“å­˜æ—¶é—´è®¾ç½®è§„åˆ™)


<br/><br/><br/>

***
<br/>

> <h1 id= "ç¼“å­˜Redis">ç¼“å­˜Redis</h1>


***
<br/><br/><br/>
> <h2 id="ç¼“å­˜æ—¶é—´è®¾ç½®è§„åˆ™">ç¼“å­˜æ—¶é—´è®¾ç½®è§„åˆ™</h2>

åœ¨ Redis ç¼“å­˜ä¸­è®¾ç½® **è¿‡æœŸæ—¶é—´ï¼ˆ`expiration`ï¼‰** å®ƒç›´æ¥å½±å“ï¼š

- **ç¼“å­˜å‘½ä¸­ç‡**
- **æ•°æ®ä¸€è‡´æ€§**
- **æ•°æ®åº“å‹åŠ›**
- **ç”¨æˆ·ä½“éªŒ**

---
<br/>

**ğŸ¯ æˆ‘çš„åœºæ™¯ï¼šåˆ†é¡µç”¨æˆ·åˆ—è¡¨ï¼ˆ`GetUserList`ï¼‰å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š**

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **è¯»å¤šå†™å°‘** | ç”¨æˆ·åˆ—è¡¨è¢«é¢‘ç¹è¯»å–ï¼Œä½†ç”¨æˆ·å¢åˆ æ”¹ç›¸å¯¹è¾ƒå°‘ |
| **å…è®¸çŸ­æš‚ä¸ä¸€è‡´** | åˆ—è¡¨å‡ ç§’/å‡ åˆ†é’Ÿå†…æœªæ›´æ–°é€šå¸¸å¯æ¥å— |
| **åˆ†é¡µå‚æ•°å¤šæ ·** | ä¸åŒ `page`/`size` ä¼šäº§ç”Ÿå¤§é‡ç¼“å­˜ keyï¼Œéœ€é˜²å†…å­˜çˆ†ç‚¸ |

<br/>

**æ¨èçš„ `expiration` èŒƒå›´**

| åœºæ™¯ | å»ºè®®è¿‡æœŸæ—¶é—´ | ç†ç”± |
|------|-------------|------|
| **é€šç”¨ Web åº”ç”¨** | **5 ~ 30 åˆ†é’Ÿ** | å¹³è¡¡ä¸€è‡´æ€§ä¸æ€§èƒ½ |
| **é«˜å®æ—¶æ€§è¦æ±‚** | **10 ~ 60 ç§’** | å¦‚åå°ç®¡ç†ç³»ç»Ÿï¼Œå¸Œæœ›å°½å¿«çœ‹åˆ°æ–°ç”¨æˆ· |
| **ä½é¢‘å˜æ›´ + é«˜è´Ÿè½½** | **30 åˆ†é’Ÿ ~ 2 å°æ—¶** | å¦‚å…¬å¼€ç”¨æˆ·ç›®å½•ï¼Œæ•°æ®ç¨³å®š |
| **é˜²æ­¢ç¼“å­˜é›ªå´©** | **åŸºç¡€æ—¶é—´ + éšæœºæŠ–åŠ¨** | è§ä¸‹æ–‡ |

> ğŸ’¡ **æ¨èèµ·ç‚¹ï¼š10 åˆ†é’Ÿï¼ˆ600 ç§’ï¼‰**

```go
const UserListCacheTTL = 10 * time.Minute // 600 seconds
```

---
<br/>

**é«˜çº§ä¼˜åŒ–å»ºè®®**

**1. **åŠ éšæœºæŠ–åŠ¨ï¼ˆé¿å…ç¼“å­˜é›ªå´©ï¼‰****

å¦‚æœæ‰€æœ‰ key åŒæ—¶è¿‡æœŸï¼Œå¤§é‡è¯·æ±‚ä¼šç¬é—´æ‰“åˆ° DBã€‚

âœ… æ”¹è¿›ï¼š
```go
baseTTL := 10 * time.Minute
jitter := time.Duration(rand.Intn(120)) * time.Second // Â±0~120ç§’éšæœº
expiration := baseTTL + jitter
```

<br/>

æˆ–ä½¿ç”¨æ›´å¹³æ»‘çš„æ–¹å¼ï¼š

```go
// åœ¨ [9, 11] åˆ†é’Ÿä¹‹é—´éšæœº
minTTL := 9 * time.Minute
maxTTL := 11 * time.Minute
expiration := minTTL + time.Duration(rand.Int63n(int64(maxTTL-minTTL)))
```

> âš ï¸ è®°å¾— `import "math/rand"`ï¼Œå¹¶åœ¨ç¨‹åºå¯åŠ¨æ—¶ `rand.Seed(time.Now().UnixNano())`ï¼ˆGo 1.20+ å¯çœç•¥ï¼‰

<br/>

**2. **æŒ‰æ•°æ®çƒ­åº¦åŠ¨æ€è°ƒæ•´ TTL****

- çƒ­é—¨é¡µé¢ï¼ˆå¦‚ page=1ï¼‰ç¼“å­˜æ›´ä¹…ï¼ˆå¦‚ 30 åˆ†é’Ÿï¼‰
- å†·é—¨é¡µé¢ï¼ˆpage > 100ï¼‰ç¼“å­˜è¾ƒçŸ­ï¼ˆå¦‚ 2 åˆ†é’Ÿï¼‰æˆ–ä¸ç¼“å­˜

```go
if page == 1 {
    expiration = 30 * time.Minute
} else if page <= 10 {
    expiration = 10 * time.Minute
} else {
    expiration = 2 * time.Minute
}
```

<br/>

**3. **å†™æ“ä½œæ—¶ä¸»åŠ¨å¤±æ•ˆç¼“å­˜ï¼ˆCache-Aside + Write-Invalidateï¼‰****

å½“æœ‰ç”¨æˆ·æ–°å¢/åˆ é™¤/ä¿®æ”¹æ—¶ï¼Œ**ä¸»åŠ¨åˆ é™¤ç›¸å…³ç¼“å­˜**ï¼Œè€Œä¸æ˜¯ç­‰è¿‡æœŸï¼š

```go
// åˆ›å»ºç”¨æˆ·å
func (s *UserService) CreateUser(...) {
    // ... save to DB
    s.userCache.InvalidateUserList(ctx) // åˆ é™¤æ‰€æœ‰ user:list:* keysï¼ˆæˆ–åªåˆ  page=1ï¼‰
}
```

è¿™æ ·å³ä½¿ TTL è®¾ä¸º 30 åˆ†é’Ÿï¼Œä¹Ÿèƒ½ä¿è¯å…³é”®æ“ä½œåç«‹å³åˆ·æ–°ã€‚

> ğŸ”¥ ç»“åˆâ€œä¸»åŠ¨å¤±æ•ˆ + è¾ƒé•¿ TTLâ€æ˜¯æœ€ä½³å®è·µã€‚

<br/>

**4. **é¿å…ç¼“å­˜çˆ†ç‚¸ï¼ˆKey å¤ªå¤šï¼‰****

åˆ†é¡µå‚æ•°ç»„åˆå¤ªå¤šï¼ˆpage=1~10000ï¼‰ï¼Œå¯èƒ½å¯¼è‡´ Redis å†…å­˜è€—å°½ã€‚

âœ… å»ºè®®ï¼š
- **åªç¼“å­˜å‰ N é¡µ**ï¼ˆå¦‚ page â‰¤ 100ï¼‰
- **é™åˆ¶æœ€å¤§ size**ï¼ˆå¦‚ size â‰¤ 100ï¼‰
- è¶…å‡ºèŒƒå›´ä¸ç¼“å­˜ï¼š

```go
if page > 100 || size > 100 {
    // ç›´æ¥æŸ¥ DBï¼Œä¸èµ°ç¼“å­˜
    return s.repo.FindPage(...)
}
```

<br/>

**âœ… æ€»ç»“ï¼šæ¨èé…ç½®**

```go
// é»˜è®¤ç¼“å­˜ 10 åˆ†é’Ÿ + éšæœºæŠ–åŠ¨
func getUserListCacheTTL() time.Duration {
    base := 10 * time.Minute
    jitter := time.Duration(rand.Intn(120)) * time.Second
    return base + jitter
}

// ä½¿ç”¨
err := c.redisCache.SetToRedis(key, resp, getUserListCacheTTL(), ctx)
```

åŒæ—¶é…åˆï¼š
- **å†™æ“ä½œæ—¶åˆ é™¤ç¼“å­˜**
- **é™åˆ¶ç¼“å­˜ page/size èŒƒå›´**
- **ç›‘æ§ Redis å†…å­˜å’Œå‘½ä¸­ç‡**

---

å¦‚æœä½ çš„åº”ç”¨å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼ˆå¦‚å†…éƒ¨ç³»ç»Ÿã€éæ ¸å¿ƒæ¥å£ï¼‰ï¼Œ**10~30 åˆ†é’Ÿæ˜¯éå¸¸å®‰å…¨ä¸”é«˜æ•ˆçš„é€‰æ‹©**ã€‚
