> <h2 id=''></h2>
- [GCD](#GCD)
	- [3ç§é˜Ÿåˆ—ç±»å‹](#3ç§é˜Ÿåˆ—ç±»å‹)
	- [dispatch_once](#dispatch_once)
		- [åŸç†](#åŸç†)
	- [å¹¶å‘](#å¹¶å‘)
		- [dispatch_get_global_queue()](#dispatch_get_global_queue())
	- [çº¿ç¨‹ç»„å’Œä¾èµ–](#çº¿ç¨‹ç»„å’Œä¾èµ–)
		- 	[çº¿ç¨‹ç»„å¤„ç†](#çº¿ç¨‹ç»„å¤„ç†)
- [æ—¶é—´å»¶è¿Ÿ](#æ—¶é—´å»¶è¿Ÿ)
	- [dispatch_after](#dispatch_after)
	- [dispatch_time_t](#dispatch_time_t)
	- [dispatch_walltime](#dispatch_walltime)
- [**é”**](#é”)
	- [OSSpinLock](#OSSpinLock)
	- [dispatch_semaphore](#dispatch_semaphore)
	- [dispatch_barrier_async](dispatch_barrier_async)
	- [pthread_rwlockäº’æ–¥é”](#pthread_rwlockäº’æ–¥é”)
- [**NSOperation**](#NSOperation)
	- [æ“ä½œå’Œæ“ä½œé˜Ÿåˆ—](#æ“ä½œå’Œæ“ä½œé˜Ÿåˆ—)
	- [å±æ€§](#å±æ€§)
	- [çº¿ç¨‹å®‰å…¨](#çº¿ç¨‹å®‰å…¨)
	- [NSOperationã€NSOperationQueueä½¿ç”¨æ–¹æ³•](#NSOperationã€NSOperationQueueä½¿ç”¨æ–¹æ³•)
	- [NSInvocationOperationä½¿ç”¨](#NSInvocationOperationä½¿ç”¨)
	- 	[å­ç¨‹ä½¿ç”¨NSInvocationOperation](#å­ç¨‹ä½¿ç”¨NSInvocationOperation)
	- 	[NSBlockOperation](#NSBlockOperation)
	- [å¸¸é©»çº¿ç¨‹](#å¸¸é©»çº¿ç¨‹)
	- 	[ä¾èµ–](#ä¾èµ–)
	- [å¤šä»»åŠ¡(ä»»åŠ¡æ˜¯å¼‚æ­¥)](#å¤šä»»åŠ¡(ä»»åŠ¡æ˜¯å¼‚æ­¥))
	- [å¹¶å‘](#å¹¶å‘)
- [**å†…å­˜é—®é¢˜**](#å†…å­˜é—®é¢˜)
- **èµ„æ–™**
	- [GCD](https://www.cnblogs.com/EchoHG/p/8609685.html)
	- [dispatch_onceçš„å‘åŠæ³¨æ„ç‚¹](https://juejin.cn/post/6844903558224035848)
	- [**å¤šçº¿ç¨‹**](https://meniny.cn/posts/iOS_Primer_017/)
	- [å¼€æºçš„Parseæºç (GCDç©çš„å‡ºç¥å…¥åŒ–)](https://github.com/ChenYilong/ParseSourceCodeStudy)
	- **[NSOperationã€NSOperationQueueã€è¯¦å°½æ€»ç»“](https://www.jianshu.com/p/4b1d77054b35)**
	- [**NSOperation**](https://www.jianshu.com/p/d8caf596d5d0)
	- [**NSOperationçš„è¿›é˜¶ä½¿ç”¨**](https://juejin.cn/post/6844903721097248782#heading-34)
	- [iOS å…¥é—¨ 017: å¤šçº¿ç¨‹](https://meniny.cn/posts/iOS_Primer_017/)


<br/>
<br/>

***
<br/>
<br/>


><h1 id='GCD'>GCD</h1>


> GCDå’ŒNSOperaiton 
 - èƒ½ç”¨GCDçš„åœ°æ–¹å°±ç”¨GCD å°½é‡å‡å°‘NSOperationçš„ä½¿ç”¨,å› ä¸ºGCDåœ¨å¤šæ ¸CPUä¸Šçº¿ç¨‹åˆ‡æ¢çš„æ—¶é—´æ¯”è¾ƒçŸ­ æ•ˆç‡ç›¸å¯¹é«˜äº›ï¼›
 - NSOperationæ˜¯å»ºç«‹åœ¨GCDä¹‹ä¸Šçš„ï¼Œè™½ç„¶ä½¿ç”¨èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä½†æ˜¯åœ¨çº¿ç¨‹å¹¶å‘ç®¡ç†ã€ä¼˜å…ˆçº§ã€ä¸Šæœ‰ç€GCDæ— æ³•æ¯”æ‹Ÿçš„ä¼˜åŠ¿ã€‚


<br/>
<br/>
<br/>



> <h2 id='3ç§é˜Ÿåˆ—ç±»å‹'>3ç§é˜Ÿåˆ—ç±»å‹</h2>

- **`The main queue`**: ä¸ä¸»çº¿ç¨‹åŠŸèƒ½ç›¸åŒã€‚å®é™…ä¸Šï¼Œæäº¤è‡³main queueçš„ä»»åŠ¡ä¼šåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œã€‚main queueå¯ä»¥è°ƒç”¨dispatch_get_main_queue()æ¥è·å¾—ã€‚å› ä¸ºmain queueæ˜¯ä¸ä¸»çº¿ç¨‹ç›¸å…³çš„ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ã€‚

- **`Global queues`**: å…¨å±€é˜Ÿåˆ—æ˜¯å¹¶å‘é˜Ÿåˆ—ï¼Œå¹¶ç”±æ•´ä¸ªè¿›ç¨‹å…±äº«ã€‚è¿›ç¨‹ä¸­å­˜åœ¨ä¸‰ä¸ªå…¨å±€é˜Ÿåˆ—ï¼šé«˜ã€ä¸­ï¼ˆé»˜è®¤ï¼‰ã€ä½ä¸‰ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚å¯ä»¥è°ƒç”¨dispatch_get_global_queueå‡½æ•°ä¼ å…¥ä¼˜å…ˆçº§æ¥è®¿é—®é˜Ÿåˆ—ã€‚

- **`ç”¨æˆ·é˜Ÿåˆ—`**: ç”¨æˆ·é˜Ÿåˆ— (GCDå¹¶ä¸è¿™æ ·ç§°å‘¼è¿™ç§é˜Ÿåˆ—, ä½†æ˜¯æ²¡æœ‰ä¸€ä¸ªç‰¹å®šçš„åå­—æ¥å½¢å®¹è¿™ç§é˜Ÿåˆ—ï¼Œæ‰€ä»¥æˆ‘ä»¬ç§°å…¶ä¸ºç”¨æˆ·é˜Ÿåˆ—) æ˜¯ç”¨å‡½æ•° dispatch_queue_create åˆ›å»ºçš„é˜Ÿåˆ—. è¿™äº›é˜Ÿåˆ—æ˜¯ä¸²è¡Œçš„ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œå®ƒä»¬å¯ä»¥ç”¨æ¥å®ŒæˆåŒæ­¥æœºåˆ¶, æœ‰ç‚¹åƒä¼ ç»Ÿçº¿ç¨‹ä¸­çš„mutexã€‚

&emsp;  è¿™ä¸ªæœ‰æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ï¼Œéœ€è¦çœ‹è¿™ç§é˜Ÿåˆ—å’Œdispatch_asyncå’Œdispatch_syncçš„æ­é…ï¼Œè¯·çœ‹[è¿™é‡Œ](https://www.cnblogs.com/EchoHG/p/8609685.html)

![3ç§é˜Ÿåˆ—å’Œ2ç§ä»»åŠ¡(åŒæ­¥ã€å¼‚æ­¥)çš„æ­é…](https://upload-images.jianshu.io/upload_images/2959789-74ba672570998f83.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



<br/>


![GCD](./../../Pictures/ios_oc105.png)

<br/>

![GCDåˆ†ç±»](./../../Pictures/ios_oc1_30.webp)


<br/>

><h2 id='dispatch_once'>dispatch_once</h2>

ä»‹ç»:dispatch_onceèƒ½ä¿è¯ä»»åŠ¡åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œå³ä½¿åŒæ—¶å¤šçº¿ç¨‹è°ƒç”¨ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¸¸ç”¨äºåˆ›å»ºå•ä¾‹ã€swizzeld methodç­‰åŠŸèƒ½


<br/>

**ä½¿ç”¨**

```
static dispatch_once_t onceToken;
dispatch_once(&once_token, ^{
	//åˆ›å»ºå•ä¾‹ã€method swizzledæˆ–å…¶ä»–ä»»åŠ¡
})
```



<br/>
<br/>

> <h3 id='åŸç†'>åŸç†</h3>

```
//è°ƒç”¨dispatch_once_fæ¥å¤„ç†
void dispatch_once(dispatch_once_t *val, dispatch_block_t block) {
    dispatch_once_f(val, block, _dispatch_Block_invoke(block));
}
```

dispatch_onceå°è£…è°ƒç”¨äº†dispatch_once_få‡½æ•°ï¼Œå…¶ä¸­é€šè¿‡_dispatch_Block_invokeæ¥æ‰§è¡Œblockä»»åŠ¡ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š

```
//invokeæ˜¯æŒ‡è§¦å‘blockçš„å…·ä½“å®ç°ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹Block_layoutçš„ç»“æ„ä½“
#define _dispatch_Block_invoke(bb) \
        ((dispatch_function_t)((struct Block_layout *)bb)->invoke)
```

æ¥ç€çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°å‡½æ•°dispatch_once_fï¼š


```
void dispatch_once_f(dispatch_once_t *val, void *ctxt, dispatch_function_t func) {
	// volatilegå…³é”®å­—ç¼–è¾‘çš„å˜é‡vvalï¼Œå‘Šè¯‰ç¼–è¯‘å™¨æ­¤æŒ‡é’ˆæŒ‡å‘çš„å€¼éšæ—¶å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹æ”¹å˜ï¼Œä»è€Œä½¿å¾—ç¼–è¯‘å™¨ä¸å¯¹æ­¤æŒ‡é’ˆè¿›è¡Œä»£ç ç¼–è¯‘ä¼˜åŒ–ã€‚
	// æŒ‡é’ˆçš„æœ€å¤§çš„ä½œç”¨å°±æ˜¯é—´æ¥çš„æ”¹å˜å˜é‡çš„å€¼
    struct _dispatch_once_waiter_s * volatile *vval =
            (struct _dispatch_once_waiter_s**)val;
    
    // åˆå§‹åŒ–ä¸€ä¸ªç»“æ„ä½“
    struct _dispatch_once_waiter_s dow = { NULL, 0 };
    
    // å£°æ˜è¾…åŠ©å˜é‡
    struct _dispatch_once_waiter_s *tail, *tmp;
    // å£°æ˜ä¿¡å·å˜é‡
    _dispatch_thread_semaphore_t sema;

	// å†…ç½®å‡½æ•° åŸå­æ¯”è¾ƒäº¤æ¢å‡½æ•° __sync_bool_compare_and_swap
	// åˆ¤æ–­vvalä¸NULLæ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰å°±è¿”å›YESï¼Œå¹¶å°†&dowçš„å€¼èµ‹ç»™vval
	// å½“dispatch_onceç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œpredicateä¹Ÿå³valä¸º0,åœ°å€å¹¶ä¸ä¸ºNULLï¼Œä½†æ˜¯å°†0è½¬æˆé“¾è¡¨çš„æ—¶å€™vvalä¸ºNULLï¼Œé‚£ä¹ˆæ­¤â€œåŸå­æ¯”è¾ƒäº¤æ¢å‡½æ•°â€å°†è¿”å›YESå¹¶å°†vvalæŒ‡å‘å€¼èµ‹å€¼ä¸º&dowï¼Œå³ä¸ºâ€œç­‰å¾…ä¸­â€
	//_dispatch_client_calloutå…¶å†…éƒ¨åšäº†ä¸€äº›åˆ¤å®šï¼Œä½†å®é™…ä¸Šæ˜¯è°ƒç”¨äº†funcè€Œå·²ã€‚åˆ°æ­¤ï¼Œblockä¸­çš„ç”¨æˆ·ä»£ç æ‰§è¡Œå®Œæ¯•ã€‚
	// #1
    if (dispatch_atomic_cmpxchg(vval, NULL, &dow, acquire)) {
		    dispatch_atomic_acquire_barrier();//è¿™æ˜¯ä¸€ä¸ªç©ºçš„å®å‡½æ•°ï¼Œå¤§æ¦‚æ˜¯æ³¨é‡Šçš„ä½œç”¨å§

		// å…¶å®è´¨æ˜¯æ‰§è¡Œblock
        _dispatch_client_callout(ctxt, func);

        // cpuidæŒ‡ä»¤ç­‰å¾…ï¼Œä½¿å¾—å…¶ä»–çº¿ç¨‹çš„ã€è¯»å–åˆ°æœªåˆå§‹åŒ–å€¼çš„ã€‘é¢„æ‰§è¡Œèƒ½è¢«åˆ¤å®šä¸ºçŒœæµ‹æœªå‘½ä¸­ï¼Œä»è€Œä½¿å¾—è¿™äº›çº¿ç¨‹èƒ½å¤Ÿè¿›å…¥dispatch_once_fé‡Œçš„å¦ä¸€ä¸ªåˆ†æ”¯ä»è€Œè¿›è¡Œç­‰å¾…
        dispatch_atomic_maximally_synchronizing_barrier();
        
        dispatch_atomic_release_barrier(); //è¿™æ˜¯ä¸€ä¸ªç©ºçš„å®å‡½æ•°ï¼Œå¤§æ¦‚æ˜¯æ³¨é‡Šçš„ä½œç”¨å§
    
		// dispatch_atomic_xchg å…¶å°†ç¬¬äºŒä¸ªå‚æ•°çš„å€¼èµ‹ç»™ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆè§£å¼•ç”¨æŒ‡é’ˆï¼‰ï¼Œç„¶åè¿”å›ç¬¬ä¸€ä¸ªå‚æ•°è¢«èµ‹å€¼å‰çš„è§£å¼•ç”¨å€¼ï¼š
		// vval = &dow;
		// old = vval;
		// vval = DISPATCH_ONCE_DONE;// ç½®blockå®Œæˆæ ‡è®°ï¼Œæ˜¯ç½®æˆNULLå—
		// tmp = old;
        tmp = dispatch_atomic_xchg(vval, DISPATCH_ONCE_DONE, relaxed);
        tail = &dow;
        
        // tmp = æ—§çš„vval = dow
		// vval = dow;
		// æ¥ä¸‹æ¥æ˜¯å¯¹ä¿¡å·é‡é“¾çš„å¤„ç†ï¼š
		// 1.åœ¨blockæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰å…¶ä»–çº¿ç¨‹è¿›å…¥æœ¬å‡½æ•°æ¥ç­‰å¾…ï¼Œåˆ™vvalæŒ‡å‘å€¼ä¿æŒä¸º&dowï¼Œå³tmpè¢«èµ‹å€¼ä¸º&dowï¼Œå³ä¸‹æ–¹whileå¾ªç¯ä¸ä¼šè¢«æ‰§è¡Œï¼Œæ­¤åˆ†æ”¯ç»“æŸã€‚
		// 2.åœ¨blockæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰å…¶ä»–çº¿ç¨‹è¿›å…¥æœ¬å‡½æ•°æ¥ç­‰å¾…è¿›å…¥å¦ä¸€ä¸ªåˆ†æ”¯ï¼Œé‚£ä¹ˆä¼šæ„é€ ä¸€ä¸ªä¿¡å·é‡é“¾è¡¨ï¼ˆvvalæŒ‡å‘å€¼å˜ä¸ºä¿¡å·é‡é“¾çš„å¤´éƒ¨ï¼Œé“¾è¡¨çš„å°¾éƒ¨ä¸º&dowï¼‰ï¼Œæ­¤æ—¶å°±ä¼šå½“å‰åˆ†æ”¯è¿›å…¥whileå¾ªç¯ï¼Œåœ¨æ­¤whileå¾ªç¯ä¸­ï¼Œéå†é“¾è¡¨ï¼Œé€ä¸ªsignalæ¯ä¸ªä¿¡å·é‡ï¼Œç„¶åç»“æŸå¾ªç¯ã€‚
        while (tail != tmp) {
            while (!tmp->dow_next) {
		        // æ­¤å¥æ˜¯ä¸ºäº†æç¤ºcpuå‡å°‘é¢å¤–å¤„ç†ï¼Œæå‡æ€§èƒ½ï¼ŒèŠ‚çœç”µåŠ›ã€‚
                dispatch_hardware_pause();
            }
            sema = tmp->dow_sema;
            tmp = (struct _dispatch_once_waiter_s*)tmp->dow_next;
            _dispatch_thread_semaphore_signal(sema);
        }
    } else {
	    // #2
	    // å½“æ‰§è¡Œblockåˆ†æ”¯#1æœªå®Œæˆï¼Œä¸”æœ‰çº¿ç¨‹å†è¿›å…¥æœ¬å‡½æ•°æ—¶ï¼Œå°†è¿›å…¥çº¿ç¨‹ç­‰å¾…åˆ†æ”¯ï¼š
	    // å…ˆè°ƒç”¨_dispatch_get_thread_semaphoreåˆ›å»ºä¸€ä¸ªä¿¡å·é‡ï¼Œæ­¤ä¿¡å·é‡è¢«èµ‹å€¼ç»™dow.dow_semaã€‚
	    // ç„¶åè¿›å…¥ä¸€ä¸ªæ— é™forå¾ªç¯ï¼Œå‡å¦‚å‘ç°vvalçš„æŒ‡å‘å€¼å·²ç»ä¸ºDISPATCH_ONCE_DONEï¼Œå³â€œå®Œæˆâ€ï¼Œåˆ™ç›´æ¥breakï¼Œç„¶åè°ƒç”¨_dispatch_put_thread_semaphoreå‡½æ•°é”€æ¯ä¿¡å·é‡å¹¶é€€å‡ºå‡½æ•°
	    // _dispatch_get_thread_semaphoreå†…éƒ¨ä½¿ç”¨çš„æ˜¯â€œæœ‰å³å–ç”¨ï¼Œæ— å³åˆ›å»ºâ€ç­–ç•¥æ¥è·å–ä¿¡å·é‡ã€‚
        dow.dow_sema = _dispatch_get_thread_semaphore();
        tmp = *vval;
        
        // ç„¶åè¿›å…¥ä¸€ä¸ªæ— é™forå¾ªç¯
        for (;;) {
        tmp = *vval;
        // å‡å¦‚å‘ç°vvalçš„æŒ‡å‘å€¼å·²ç»ä¸ºDISPATCH_ONCE_DONEï¼Œå³â€œå®Œæˆâ€ï¼Œåˆ™ç›´æ¥break
        // ç„¶åè°ƒç”¨_dispatch_put_thread_semaphoreå‡½æ•°é”€æ¯ä¿¡å·é‡å¹¶é€€å‡ºå‡½æ•°ã€‚
        if (tmp == DISPATCH_ONCE_DONE) {
            break;
        }
        dispatch_atomic_store_barrier();// æ³¨é‡Šä½œç”¨
        
        /*
         å‡å¦‚vvalçš„è§£å¼•ç”¨å€¼å¹¶éDISPATCH_ONCE_DONEï¼Œåˆ™è¿›è¡Œä¸€ä¸ªâ€œåŸå­æ¯”è¾ƒå¹¶äº¤æ¢â€æ“ä½œï¼ˆæ­¤æ“ä½œå¯ä»¥é¿å…ä¸¤ä¸ªç­‰å¾…çº¿ç¨‹åŒæ—¶æ“ä½œé“¾è¡¨å¸¦æ¥çš„é—®é¢˜ï¼‰
         å‡å¦‚æ­¤æ—¶vvalæŒ‡å‘å€¼å·²ä¸å†æ˜¯tmpï¼ˆè¿™ç§æƒ…å†µå‘ç”Ÿåœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥çº¿ç¨‹ç­‰å¾…åˆ†æ”¯#2ï¼Œå¹¶äº¤é”™ä¿®æ”¹é“¾è¡¨ï¼‰åˆ™forå¾ªç¯é‡æ–°å¼€å§‹ï¼Œå†å°è¯•é‡æ–°è·å–ä¸€æ¬¡vvalæ¥è¿›è¡ŒåŒæ ·çš„æ“ä½œï¼›è‹¥æŒ‡å‘å€¼è¿˜æ˜¯tmpï¼Œåˆ™å°†vvalçš„æŒ‡å‘å€¼èµ‹å€¼ä¸º&dowï¼Œæ­¤æ—¶val->dow_nextå€¼ä¸ºNULLï¼Œå¯èƒ½ä¼šä½¿å¾—blockæ‰§è¡Œåˆ†æ”¯#1è¿›è¡Œwhileç­‰å¾…ï¼ˆå¦‚å‰è¿°ï¼‰ï¼Œç´§æ¥ç€æ‰§è¡Œdow.dow_next = tmpè¿™å¥æ¥å¢åŠ é“¾è¡¨èŠ‚ç‚¹ï¼ˆåŒæ—¶ä¹Ÿä½¿å¾—blockæ‰§è¡Œåˆ†æ”¯#1çš„whileç­‰å¾…ç»“æŸï¼‰ï¼Œç„¶åç­‰å¾…åœ¨ä¿¡å·é‡ä¸Šï¼Œå½“blockæ‰§è¡Œåˆ†æ”¯#1å®Œæˆå¹¶éå†é“¾è¡¨æ¥signalæ—¶ï¼Œå”¤é†’ã€é‡Šæ”¾ä¿¡å·é‡ï¼Œç„¶åä¸€åˆ‡å°±å®Œæˆäº†ã€‚
         */
        // æ­¤æ“ä½œå¯ä»¥é¿å…ä¸¤ä¸ªç­‰å¾…çº¿ç¨‹åŒæ—¶æ“ä½œé“¾è¡¨å¸¦æ¥çš„é—®é¢˜
        // åˆ¤æ–­vvalä¸tmpæ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰å°±è¿”å›YESï¼Œå¹¶å°†&dowçš„å€¼èµ‹ç»™vval
        if (dispatch_atomic_cmpxchg(vval, tmp, &dow)) {
            dow.dow_next = tmp;
            _dispatch_thread_semaphore_wait(dow.dow_sema);
        }
    }
    // _dispatch_put_thread_semaphoreå†…éƒ¨ä½¿ç”¨çš„æ˜¯â€œé”€æ¯æ—§çš„ï¼Œå­˜å‚¨æ–°çš„â€ç­–ç•¥æ¥ç¼“å­˜ä¿¡å·é‡
    _dispatch_put_thread_semaphore(dow.dow_sema);
}
```


<br/>

ç”±ä¸Šé¢çš„ä»£ç å¯çŸ¥dispatch_onceçš„æµç¨‹å›¾å¤§è‡´å¦‚ä¸‹ï¼š

![ios_oc1_99.png](./../../Pictures/ios_oc1_99.png)

&emsp; é¦–å…ˆçœ‹ä¸€ä¸‹dispatch_onceä¸­ç”¨çš„çš„åŸå­æ€§æ“ä½œdispatch_atomic_cmpxchg(vval, NULL, &dow, acquire)ï¼Œå®ƒçš„å®å®šä¹‰å±•å¼€ä¹‹åä¼šå°†$dowèµ‹å€¼ç»™vvalï¼Œå¦‚æœvvalçš„åˆå§‹å€¼ä¸ºNULLï¼Œè¿”å›YES,å¦åˆ™è¿”å›NOã€‚


&emsp; é¦–æ¬¡è°ƒç”¨dispatch_onceæ—¶ï¼Œå› ä¸ºå¤–éƒ¨ä¼ å…¥çš„dispatch_once_tå˜é‡å€¼ä¸ºnilï¼Œæ•…vvalä¼šä¸ºNULLï¼Œæ•…ifåˆ¤æ–­æˆç«‹ã€‚ç„¶åè°ƒç”¨_dispatch_client_calloutæ‰§è¡Œblockï¼Œç„¶ååœ¨blockæ‰§è¡Œå®Œæˆä¹‹åå°†vvalçš„å€¼æ›´æ–°æˆDISPATCH_ONCE_DONEè¡¨ç¤ºä»»åŠ¡å·²å®Œæˆã€‚æœ€åéå†é“¾è¡¨çš„èŠ‚ç‚¹å¹¶è°ƒç”¨_dispatch_thread_semaphore_signalæ¥å”¤é†’ç­‰å¾…ä¸­çš„ä¿¡å·é‡ï¼›

&emsp; å½“å…¶ä»–çº¿ç¨‹åŒæ—¶ä¹Ÿè°ƒç”¨dispatch_onceæ—¶ï¼Œå› ä¸ºifåˆ¤æ–­æ˜¯åŸå­æ€§æ“ä½œï¼Œæ•…åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥åˆ°ifåˆ†æ”¯ä¸­ï¼Œå…¶ä»–çº¿ç¨‹ä¼šè¿›å…¥elseåˆ†æ”¯ã€‚åœ¨elseåˆ†æ”¯ä¸­ä¼šåˆ¤æ–­blockæ˜¯å¦å·²å®Œæˆï¼Œå¦‚æœå·²å®Œæˆåˆ™è·³å‡ºå¾ªç¯ï¼›å¦åˆ™å°±æ˜¯æ›´æ–°é“¾è¡¨å¹¶è°ƒç”¨_dispatch_thread_semaphore_waité˜»å¡çº¿ç¨‹ï¼Œç­‰å¾…ifåˆ†æ”¯ä¸­çš„blockå®Œæˆåå†å”¤é†’å½“å‰ç­‰å¾…çš„çº¿ç¨‹ã€‚


<br/>

**æ€»ç»“ç¯‡**

&emsp; dispatch_onceç”¨åŸå­æ€§æ“ä½œblockæ‰§è¡Œå®Œæˆæ ‡è®°ä½ï¼ŒåŒæ—¶ç”¨ä¿¡å·é‡ç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œblockï¼Œç­‰blockæ‰§è¡Œå®Œå†å”¤é†’æ‰€æœ‰ç­‰å¾…ä¸­çš„çº¿ç¨‹ã€‚






<br/>
<br/>
<br/>


><h2 id='å¹¶å‘'>å¹¶å‘</h2>


&emsp; åœ¨ iOS å¹¶å‘ç¼–ç¨‹æŠ€æœ¯ä¸­ï¼ŒGCD çš„ä½¿ç”¨ç‡æ˜¯æœ€é«˜çš„ã€‚æ‰€ä»¥ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°±ä»¥ GCD ä¸ºä¾‹å’Œä½ è¯´è¯´å¤šçº¿ç¨‹çš„å¹¶å‘é—®é¢˜ã€‚


&emsp; GCDï¼ˆGrand Central Dispatchï¼‰æ˜¯ç”±è‹¹æœå…¬å¸å¼€å‘çš„ä¸€ä¸ªå¤šæ ¸ç¼–ç¨‹è§£å†³æ–¹æ¡ˆã€‚å®ƒæä¾›çš„ä¸€å¥—ç®€å•æ˜“ç”¨çš„æ¥å£ï¼Œæå¤§åœ°æ–¹ä¾¿äº†å¹¶å‘ç¼–ç¨‹ã€‚åŒæ—¶ï¼Œå®ƒè¿˜å¯ä»¥å®Œæˆå¯¹å¤æ‚çš„çº¿ç¨‹åˆ›å»ºã€é‡Šæ”¾æ—¶æœºçš„ç®¡ç†ã€‚ä½†æ˜¯ï¼ŒGCD å¸¦æ¥è¿™äº›ä¾¿åˆ©çš„åŒæ—¶ï¼Œä¹Ÿå¸¦æ¥äº†èµ„æºä½¿ç”¨ä¸Šçš„é£é™©ã€‚


&emsp; ä¾‹å¦‚ï¼Œåœ¨è¿›è¡Œæ•°æ®è¯»å†™æ“ä½œæ—¶ï¼Œæ€»æ˜¯éœ€è¦ä¸€æ®µæ—¶é—´æ¥ç­‰å¾…ç£ç›˜å“åº”çš„ï¼Œå¦‚æœåœ¨è¿™ä¸ªæ—¶å€™é€šè¿‡ GCD å‘èµ·äº†ä¸€ä¸ªä»»åŠ¡ï¼Œé‚£ä¹ˆ GCD å°±ä¼šæœ¬ç€æœ€å¤§åŒ–åˆ©ç”¨ CPU çš„åŸåˆ™ï¼Œä¼šåœ¨ç­‰å¾…ç£ç›˜å“åº”çš„è¿™ä¸ªç©ºæ¡£ï¼Œå†åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥ä¿è¯èƒ½å¤Ÿå……åˆ†åˆ©ç”¨ CPUã€‚

&emsp; è€Œå¦‚æœ GCD å‘èµ·çš„è¿™äº›æ–°ä»»åŠ¡ï¼Œéƒ½æ˜¯ç±»ä¼¼äºæ•°æ®å­˜å‚¨è¿™æ ·éœ€è¦ç­‰å¾…ç£ç›˜å“åº”çš„ä»»åŠ¡çš„è¯ï¼Œé‚£ä¹ˆéšç€ä»»åŠ¡æ•°é‡çš„å¢åŠ ï¼ŒGCD åˆ›å»ºçš„æ–°çº¿ç¨‹å°±ä¼šè¶Šæ¥è¶Šå¤šï¼Œä»è€Œå¯¼è‡´å†…å­˜èµ„æºè¶Šæ¥è¶Šç´§å¼ ï¼Œç­‰åˆ°ç£ç›˜å¼€å§‹å“åº”åï¼Œå†è¯»å–æ•°æ®åˆä¼šå ç”¨æ›´å¤šçš„å†…å­˜ã€‚ç»“æœå°±æ˜¯ï¼Œå¤±æ§çš„å†…å­˜å ç”¨ä¼šå¼•èµ·æ›´å¤šçš„å†…å­˜é—®é¢˜ã€‚


&emsp; è¿™ç§æƒ…å†µæœ€å…¸å‹çš„åœºæ™¯å°±æ˜¯æ•°æ®åº“è¯»å†™æ“ä½œã€‚[FMDB](https://github.com/ccgus/fmdb)æ˜¯ä¸€ä¸ªå¼€æºçš„ç¬¬ä¸‰æ–¹æ•°æ®åº“æ¡†æ¶ï¼Œé€šè¿‡ FMDatabaseQueue è¿™ä¸ªæ ¸å¿ƒç±»ï¼Œå°†ä¸è¯»å†™æ•°æ®åº“ç›¸å…³çš„ç£ç›˜æ“ä½œéƒ½æ”¾åˆ°ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—é‡Œæ‰§è¡Œï¼Œä»è€Œé¿å…äº†çº¿ç¨‹åˆ›å»ºè¿‡å¤šå¯¼è‡´ç³»ç»Ÿèµ„æºç´§å¼ çš„æƒ…å†µã€‚



<br/>
<br/>


> <h3 id='dispatch_get_global_queue()'>dispatch_get_global_queue()</h3>


```

NSLog(@"11111------->>Post çº¿ç¨‹è¯·æ±‚ï¼š %@", [NSThread currentThread]);

dispatch_async(dispatch_get_global_queue(), ^{
	//ç½‘ç»œè¯·æ±‚ï¼Œè€—æ—¶æ“ä½œ
	NSLog(@"22222------->>Post çº¿ç¨‹è¯·æ±‚ï¼š %@", [NSThread currentThread]);
	
	dispatch_async(dispatch_get_main_queue(), ^{
	        //ç½‘ç»œè¯·æ±‚åˆ°æ•°æ®ï¼Œè¿›å…¥ä¸»çº¿ç¨‹ï¼Œå¼€å§‹æŠŠæ•°æ®æ”¾åˆ°UIä¸Š
	        NSLog(@"~~~~222------->>Post çº¿ç¨‹è¯·æ±‚ï¼š %@", [NSThread currentThread]);
	
	    });

});

```

æ‰“å°ç»“æœï¼š

```

2018-12-03 10:52:00.338757+0800 TaiChi_iOS[12042:777252] 11111------->>Post çº¿ç¨‹è¯·æ±‚ï¼š <NSThread: 0x281ebef00>{number = 1, name = main}
2018-12-03 10:52:00.618865+0800 TaiChi_iOS[12042:777252] 22222------->>Post çº¿ç¨‹è¯·æ±‚ï¼š <NSThread: 0x281ebef00>{number = 1, name = main}
2018-12-03 10:52:00.629733+0800 TaiChi_iOS[12042:777252] ~~~~222------->>Post çº¿ç¨‹è¯·æ±‚ï¼š <NSThread: 0x281ebef00>{number = 1, name = main}

```

`ç»“è®ºï¼š`dispatch_get_global_queue()è¿™ä¸ªçº¿ç¨‹é˜Ÿåˆ—ï¼Œå¼€å¯çº¿ç¨‹é˜Ÿåˆ—ä¼šè§†æƒ…å†µè€Œå®šï¼Œæœ‰æ—¶ä¼šå¼€å¯çº¿ç¨‹æœ‰æ—¶ä¸ä¼šå¼€å¯çº¿ç¨‹ã€‚





<br/>
<br/>


ä¸ºäº†èƒ½å¤Ÿæ”¯æŒä»¥åå¯èƒ½æ›´å¤§çš„å¹¶å‘é‡ï¼Œä¸‹é¢æˆ‘å°†å…¶ä¸­â€œå·²è¯»â€åŠŸèƒ½çš„æ•°æ®åº“æ“ä½œæ”¹æˆ FMDatabaseQueueã€‚è¿™æ ·ï¼Œæˆ‘å°±å¯ä»¥å°†å¹¶è¡Œé˜Ÿåˆ—è½¬åŒ–ä¸ºä¸²è¡Œé˜Ÿåˆ—æ¥æ‰§è¡Œï¼Œé¿å…å¤§å¹¶å‘è¯»å†™ç£ç›˜æ“ä½œé€ æˆå†…å­˜é—®é¢˜ï¼Œæ”¹å†™ä»£ç å¦‚ä¸‹ï¼š

```
// æ ‡è®°æ–‡ç« å·²è¯»
- (RACSignal *)markFeedItemAsRead:(NSUInteger)iid fid:(NSUInteger)fid{
    @weakify(self);
    return [RACSignal createSignal:^RACDisposable *(id<RACSubscriber> subscriber) {
        @strongify(self);
        // æ”¹å†™æˆ FMDatabaseQueue ä¸²è¡Œé˜Ÿåˆ—è¿›è¡Œæ•°æ®åº“æ“ä½œ
        FMDatabaseQueue *queue = [FMDatabaseQueue databaseQueueWithPath:self.feedDBPath];
        [queue inDatabase:^(FMDatabase *db) {
            FMResultSet *rs = [FMResultSet new];
            // è¯»å–æ–‡ç« æ•°æ®
            if (fid == 0) {
                rs = [db executeQuery:@"select * from feeditem where isread = ? and iid >= ? order by iid desc", @(0), @(iid)];
            } else {
                rs = [db executeQuery:@"select * from feeditem where isread = ? and iid >= ? and fid = ? order by iid desc", @(0), @(iid), @(fid)];
            }
            NSUInteger count = 0;
            while ([rs next]) {
                count++;
            }
            // æ›´æ–°æ–‡ç« çŠ¶æ€ä¸ºå·²è¯»
            if (fid == 0) {
                [db executeUpdate:@"update feeditem set isread = ? where iid >= ?", @(1), @(iid)];
            } else {
                [db executeUpdate:@"update feeditem set isread = ? where iid >= ? and fid = ?", @(1), @(iid), @(fid)];
            }
            
            [subscriber sendNext:@(count)];
            [subscriber sendCompleted];
            [db close];
        }];
        return nil;
    }];
}
```

å¦‚ä»£ç æ‰€ç¤ºï¼Œä½ åªéœ€è¦å°†æ•°æ®åº“çš„æ“ä½œæ”¾åˆ° FMDatabaseQueue çš„ inDatabase æ–¹æ³•å…¥å‚ block ä¸­ï¼Œå°±å¯ä»¥åœ¨ FMDatabaseQueue ç»´æŠ¤çš„ä¸²è¡Œé˜Ÿåˆ—é‡Œæ’é˜Ÿç­‰å¾…æ‰§è¡Œäº†.



<br/>
<br/>
<br/>


> <h2 id='çº¿ç¨‹ç»„å’Œä¾èµ–'>çº¿ç¨‹ç»„å’Œä¾èµ–</h2>  


- **`dispatch_groupå¸¸ç”¨æ–¹æ³•ï¼š`**
	- `dispatch_group_enter` :é€šçŸ¥ group,ä¸‹ä¸ªä»»åŠ¡è¦æ”¾å…¥ group ä¸­æ‰§è¡Œäº†
	- `dispatch_group_leave`: é€šçŸ¥ group,ä»»åŠ¡æˆåŠŸå®Œæˆ,è¦ç§»é™¤,ä¸ enteræˆå¯¹å‡ºç°
	- `dispatch_group_wait`: åœ¨ä»»åŠ¡ç»„å®Œæˆæ—¶è°ƒç”¨ï¼Œæˆ–è€…ä»»åŠ¡ç»„è¶…æ—¶æ˜¯è°ƒç”¨ï¼ˆå®ŒæˆæŒ‡çš„æ˜¯enterå’Œleaveæ¬¡æ•°ä¸€æ ·å¤šï¼‰
	- `dispatch_group_notify`: åªè¦ä»»åŠ¡å…¨éƒ¨å®Œæˆäº†,å°±ä¼šåœ¨æœ€åè°ƒç”¨


[**dispatch_group_enterå’Œdispatch_group_leave ç½‘ç»œè¯·æ±‚åµŒå¥—**](https://www.jianshu.com/p/71fbc0415b5d)


<br/>

<h3 id='çº¿ç¨‹ç»„å¤„ç†'>çº¿ç¨‹ç»„å¤„ç†</h3>

```
{
    // åˆ›å»ºé˜Ÿåˆ—ç»„
    dispatch_group_t group =  dispatch_group_create();
    // åˆ›å»ºå¹¶å‘é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
 
    // å¼€å­çº¿ç¨‹ï¼Œä»»åŠ¡1
    dispatch_group_async(group, queue, ^{
        [NSData dataWithContentsOfURL:[NSURL URLWithString:@"https://img-blog.csdn.net/20180421152137506"]];
        NSLog(@"ä»»åŠ¡1 å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
    });
 
    // å¼€å­çº¿ç¨‹ï¼Œä»»åŠ¡2
    dispatch_group_async(group, queue, ^{
        [NSData dataWithContentsOfURL:[NSURL URLWithString:@"https://img-blog.csdn.net/20170112145924755?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGVyb193cWI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center"]];
        NSLog(@"ä»»åŠ¡2 å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
    });
 
    // å…¨éƒ¨å®Œæˆ
    dispatch_group_notify(group, queue, ^{
        dispatch_async(dispatch_get_main_queue(), ^{
            NSLog(@"å…¨éƒ¨å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
        });
    });
}
```

<br/>

è¾“å‡ºç»“æœï¼š

```
AsyTaskTest[5963:308229] ä»»åŠ¡1 å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x604000263380>{number = 3, name = (null)}

AsyTaskTest[5963:308228] ä»»åŠ¡2 å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x60400007c4c0>{number = 4, name = (null)}

AsyTaskTest[5963:308103] å…¨éƒ¨å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x604000070600>{number = 1, name = main}

```





<br/>
<br/>



> <h2 id='æ—¶é—´å»¶è¿Ÿ'>æ—¶é—´å»¶è¿Ÿ</h2>


<br/>
<br/>

> <h3 id='dispatch_after'>dispatch_after</h3>



&emsp;  `dispatch_after`æ˜¯åœ¨æŒ‡å®šçš„æ—¶é—´å°†ä»»åŠ¡åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œè€Œä¸æ˜¯åœ¨æŒ‡å®šçš„æ—¶é—´æ‰§è¡Œï¼Œå¦‚æœæ‰€åœ¨çš„é˜Ÿåˆ—ä¸Šæœ‰è€—æ—¶ä»»åŠ¡åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆæ—¶é—´ä¸Šå¯èƒ½å‡ºç°è¯¯å·®ã€‚

```
void  dispatch_after(dispatch_time_t when, dispatch_queue_t queue, dispatch_block_t block);
```


```

NSLog(@"2ç§’åå¼€å§‹æ‰§è¡Œ");
dispatch_after( dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(),^{
    NSLog(@"ç­‰2ç§’ï¼Œå¼€å§‹æ‰§è¡Œä»»åŠ¡");
    sleep(2);
    NSLog(@"ä»»åŠ¡æ‰§è¡Œå®Œæˆ");
} );

```

è¾“å‡ºï¼š

```
2019-05-14 11:51:26.890458+0800 Genealogy[1897:44256] 2ç§’åå¼€å§‹æ‰§è¡Œ

2019-05-14 11:51:35.784266+0800 Genealogy[1897:44256] ç­‰2ç§’ï¼Œå¼€å§‹æ‰§è¡Œä»»åŠ¡

2019-05-14 11:51:40.692939+0800 Genealogy[1897:44256] ä»»åŠ¡æ‰§è¡Œå®Œæˆ
```




<br/>
<br/>

> <h3 id='dispatch_time_t'>dispatch_time_t</h3>


`dispatch_time_t`:ç”¨æ¥æŒ‡å®šæ—¶é—´ï¼Œä¼ å…¥çš„æ˜¯dispatch_time_tç±»å‹çš„å€¼ï¼Œé€šè¿‡dispatch_timeå’Œdispatch_walltimeå‡½æ•°ç”Ÿæˆ;

<br/>

`dispatch_time_t
dispatch_time(dispatch_time_t when, int64_t delta);`


`dispatch_time_t when`:æ—¶é—´ç‚¹;
`int64_t delta`æ—¶é—´é•¿åº¦;

&emsp;  å‡½æ•°çš„ä½œç”¨å°±æ˜¯è·å–æ—¶é—´ç‚¹ç»è¿‡æ—¶é—´é•¿åº¦ä¹‹åçš„æ—¶é—´ç‚¹ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„æ˜¯DISPATCH_TIME_NOWï¼Œè¡¨ç¤ºç°åœ¨è¿™ä¸ªæ—¶é—´ç‚¹ã€‚ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºçš„æ—¶é—´é•¿åº¦ä½¿ç”¨æ•°ç»„* NSEC_PER_SECçš„æ–¹å¼è·å¾—ã€‚

- `NSEC_PER_SEC` è¡¨ç¤ºç§’

- `NSEC_PER_MSEC` è¡¨ç¤ºæ¯«ç§’

- `NSEC_PER_USEC` è¡¨ç¤ºå¾®ç§’

<br/>


- **dispatch_queue_t queue**: ä»»åŠ¡æ·»åŠ çš„é˜Ÿåˆ—;



<br/>
<br/>


> <h3 id='dispatch_walltime'>dispatch_walltime</h3>



```
dispatch_time_t
dispatch_walltime(const struct timespec *_Nullable when, int64_t delta);

const struct timespec *_Nullable when`:  ä¸€ä¸ªstruct timespecç±»å‹çš„å€¼;
int64_t delta`:  ä»¥çº³ç§’ä¸ºå•ä½çš„å»¶è¿Ÿæ—¶é—´;
```


```

//è®¾ç½®æ—¶é—´ç‚¹ä¸º2ç§’å
NSTimeInterval iT = [[NSDate dateWithTimeInterval:2 sinceDate:[NSDate date]] timeIntervalSince1970];

struct timespec time;
time.tv_sec = (NSInteger)iT;
//æ¯”æ—¶é—´ç‚¹å†æ™š10ç§’
dispatch_time_t timer = dispatch_walltime(&time, 10*NSEC_PER_SEC);
NSLog(@"12ç§’åå¼€å§‹ä»»åŠ¡");
dispatch_after(timer, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^{
    NSLog(@"ä»»åŠ¡å¼€å§‹");
    
    sleep(1);

    NSLog(@"ä»»åŠ¡å®Œæˆ");
});

```


è¾“å‡ºï¼š

```
2019-05-14 12:06:25.194589+0800 Genealogy[2330:55634] 6ç§’åå¼€å§‹ä»»åŠ¡`

2019-05-14 12:06:33.000349+0800 Genealogy[2330:55725] ä»»åŠ¡å¼€å§‹

2019-05-14 12:06:34.003165+0800 Genealogy[2330:55725] ä»»åŠ¡å®Œæˆ
```



<br/>
<br/>

> <h3 id=''></h3>





<br/>
<br/>

***
<br/>

> <h1 id='é”'>é”</h1>


<br/>

> <h2 id='OSSpinLock'>OSSpinLock</h2>

&emsp; OSSpinLock:è‡ªæ—‹é”ï¼Œæ€§èƒ½æœ€é«˜çš„é”ã€‚åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ç›´ do while å¿™ç­‰ã€‚å®ƒçš„ç¼ºç‚¹æ˜¯å½“ç­‰å¾…æ—¶ä¼šæ¶ˆè€—å¤§é‡ CPU èµ„æºï¼Œæ‰€ä»¥å®ƒä¸é€‚ç”¨äºè¾ƒé•¿æ—¶é—´çš„ä»»åŠ¡ã€‚å¯¹äºå†…å­˜ç¼“å­˜çš„å­˜å–æ¥è¯´ï¼Œå®ƒéå¸¸åˆé€‚ã€‚


<br/>
<br/>

> <h2 id='dispatch_semaphore'>dispatch_semaphore</h2>

&emsp; dispatch_semaphore æ˜¯ä¿¡å·é‡ï¼Œä½†å½“ä¿¡å·æ€»é‡è®¾ä¸º 1 æ—¶ä¹Ÿå¯ä»¥å½“ä½œé”æ¥ã€‚åœ¨æ²¡æœ‰ç­‰å¾…æƒ…å†µå‡ºç°æ—¶ï¼Œå®ƒçš„æ€§èƒ½æ¯” pthread_mutex è¿˜è¦é«˜ï¼Œä½†ä¸€æ—¦æœ‰ç­‰å¾…æƒ…å†µå‡ºç°æ—¶ï¼Œæ€§èƒ½å°±ä¼šä¸‹é™è®¸å¤šã€‚ç›¸å¯¹äº OSSpinLock æ¥è¯´ï¼Œå®ƒçš„ä¼˜åŠ¿åœ¨äºç­‰å¾…æ—¶ä¸ä¼šæ¶ˆè€— CPU èµ„æºã€‚å¯¹ç£ç›˜ç¼“å­˜æ¥è¯´ï¼Œå®ƒæ¯”è¾ƒåˆé€‚ã€‚


[**ç½‘ç»œè¯·æ±‚ä¾æ¬¡æ‰§è¡Œ**](https://www.jianshu.com/p/71fbc0415b5d)




<br/>
<br/>

> <h2 id='dispatch_barrier_async'>dispatch_barrier_async</h2>


- è¯»å†™é”åœºæ™¯ï¼š

	- åŒä¸€æ—¶é—´ï¼Œåªèƒ½æœ‰1ä¸ªçº¿ç¨‹è¿›è¡Œå†™çš„æ“ä½œ
	
	- åŒä¸€æ—¶é—´ï¼Œå…è®¸æœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œè¯»çš„æ“ä½œ
	
	- åŒä¸€æ—¶é—´ï¼Œä¸å…è®¸æ—¢æœ‰å†™çš„æ“ä½œï¼Œåˆæœ‰è¯»çš„æ“ä½œ

<br/>


ä¸Šé¢çš„åœºæ™¯å°±æ˜¯å…¸å‹çš„â€œå¤šè¯»å•å†™â€ï¼Œç»å¸¸ç”¨äºæ–‡ä»¶ç­‰æ•°æ®çš„è¯»å†™æ“ä½œï¼ŒiOSä¸­çš„å®ç°æ–¹æ¡ˆç”¨**â€Œdispatch_barrier_async**ï¼š

```

@property (nonatomic, copy) NSString *text;
@property (nonatomic, strong) dispatch_queue_t concurrentQueue;



- (void) testAction {
    
    [self testMethod2];
    
}


//è¯»å†™é”æµ‹è¯•
- (void) testMethod2 {
    NSLog(@"è¯»å†™é”æµ‹è¯•------------------------------------>");
    
    /**
     è¯»å†™é”åœºæ™¯ï¼š
     
     åŒä¸€æ—¶é—´ï¼Œåªèƒ½æœ‰1ä¸ªçº¿ç¨‹è¿›è¡Œå†™çš„æ“ä½œ
     
     åŒä¸€æ—¶é—´ï¼Œå…è®¸æœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œè¯»çš„æ“ä½œ
     
     åŒä¸€æ—¶é—´ï¼Œä¸å…è®¸æ—¢æœ‰å†™çš„æ“ä½œï¼Œåˆæœ‰è¯»çš„æ“ä½œ
     ä¸Šé¢çš„åœºæ™¯å°±æ˜¯å…¸å‹çš„â€œå¤šè¯»å•å†™â€ï¼Œç»å¸¸ç”¨äºæ–‡ä»¶ç­‰æ•°æ®çš„è¯»å†™æ“ä½œï¼ŒiOSä¸­çš„å®ç°æ–¹æ¡ˆæœ‰ï¼š
     */
    
    self.concurrentQueue = dispatch_queue_create("aaa", DISPATCH_QUEUE_CONCURRENT);
    // æµ‹è¯•ä»£ç ,æ¨¡æ‹Ÿå¤šçº¿ç¨‹æƒ…å†µä¸‹çš„è¯»å†™
    for (int i = 0; i<10; i++) {
        NSLog(@"ğŸ ğŸ ğŸ å†™æ“ä½œ1");
        dispatch_async(dispatch_get_global_queue(0, 0), ^{
            self.text = [NSString stringWithFormat:@"å™¼é‡Œå•ªå•¦--%d",i];
        });
        
    }
    
    for (int i = 0; i<50; i++) {

        dispatch_async(dispatch_get_global_queue(0, 0), ^{
            NSLog(@"è¯» %@ %@",[self text],[NSThread currentThread]);
        });
        
    }
    
    
    for (int i = 10; i<20; i++) {
        NSLog(@"ğŸ ğŸ ğŸ å†™æ“ä½œ2");

        dispatch_async(dispatch_get_global_queue(0, 0), ^{
            self.text = [NSString stringWithFormat:@"å™¼é‡Œå•ªå•¦--%d",i];
        });
        
    }
}

// å†™æ“ä½œ,æ …æ å‡½æ•°æ˜¯ä¸å…è®¸å¹¶å‘çš„,æ‰€ä»¥"å†™æ“ä½œ"æ˜¯å•çº¿ç¨‹è¿›å…¥çš„,æ ¹æ®logå¯ä»¥çœ‹å‡ºæ¥
- (void)setText:(NSString *)text {
    
    __weak typeof(self) weakSelf = self;
    NSLog(@"ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ");

    dispatch_barrier_sync(self.concurrentQueue, ^{
        __strong typeof(weakSelf) strongSelf = weakSelf;
        strongSelf->_text = text;
        NSLog(@"å†™æ“ä½œ %@ %@",text,[NSThread currentThread]);
        // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ,1ä¸ª1ä¸ªæ‰§è¡Œ,æ²¡æœ‰å¹¶å‘
        sleep(1);
    });
}
// è¯»æ“ä½œ,è¿™ä¸ªæ˜¯å¯ä»¥å¹¶å‘çš„,logåœ¨å¾ˆå¿«æ—¶é—´æ‰“å°å®Œ
- (NSString *)text {
    
    __block NSString * t = nil ;
    __weak typeof(self) weakSelf = self;
    NSLog(@"ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1");

    dispatch_sync(self.concurrentQueue, ^{
        __strong typeof(weakSelf) strongSelf = weakSelf;
        NSLog(@"ğŸ ğŸ ğŸ è¯»æ“ä½œ1");

        t = strongSelf->_text;
        // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ,ç¬é—´æ‰§è¡Œå®Œ,è¯´æ˜æ˜¯å¤šä¸ªçº¿ç¨‹å¹¶å‘çš„è¿›å…¥çš„
        sleep(1);
        
    });
    return t;
    
}


```

æ‰“å°ï¼š

```
2021-06-01 21:23:42.050578+0800 OCTest[49150:1874181] è¯»å†™é”æµ‹è¯•------------------------------------>
2021-06-01 21:23:42.050872+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ1
2021-06-01 21:23:42.051131+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ1
2021-06-01 21:23:42.051168+0800 OCTest[49150:1875102] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.051374+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ1
2021-06-01 21:23:42.051447+0800 OCTest[49150:1875240] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.051493+0800 OCTest[49150:1875102] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--0 <NSThread: 0x600002005680>{number = 4, name = (null)}
2021-06-01 21:23:42.051602+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ1
2021-06-01 21:23:42.051671+0800 OCTest[49150:1875241] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.052223+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ1
2021-06-01 21:23:42.052290+0800 OCTest[49150:1875242] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.052553+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ1
2021-06-01 21:23:42.052642+0800 OCTest[49150:1875243] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.052926+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ1
2021-06-01 21:23:42.052992+0800 OCTest[49150:1875244] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.053249+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ1
2021-06-01 21:23:42.053349+0800 OCTest[49150:1875245] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.059369+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ1
2021-06-01 21:23:42.059459+0800 OCTest[49150:1875246] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.059518+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ1
2021-06-01 21:23:42.059570+0800 OCTest[49150:1875247] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.059764+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ2
2021-06-01 21:23:42.059770+0800 OCTest[49150:1875248] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.059808+0800 OCTest[49150:1875249] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.059899+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ2
2021-06-01 21:23:42.059919+0800 OCTest[49150:1875251] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.059938+0800 OCTest[49150:1875250] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.059977+0800 OCTest[49150:1875252] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060023+0800 OCTest[49150:1875253] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060034+0800 OCTest[49150:1875254] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060085+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ2
2021-06-01 21:23:42.060098+0800 OCTest[49150:1875255] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060133+0800 OCTest[49150:1875256] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060181+0800 OCTest[49150:1875257] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060220+0800 OCTest[49150:1875258] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060282+0800 OCTest[49150:1875259] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060295+0800 OCTest[49150:1875260] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060346+0800 OCTest[49150:1875261] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060403+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ2
2021-06-01 21:23:42.060405+0800 OCTest[49150:1875263] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060413+0800 OCTest[49150:1875262] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060456+0800 OCTest[49150:1875264] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060489+0800 OCTest[49150:1875265] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060584+0800 OCTest[49150:1875266] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060644+0800 OCTest[49150:1875267] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060683+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ2
2021-06-01 21:23:42.060689+0800 OCTest[49150:1875268] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060719+0800 OCTest[49150:1875269] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060760+0800 OCTest[49150:1875270] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060799+0800 OCTest[49150:1875271] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060826+0800 OCTest[49150:1875272] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060879+0800 OCTest[49150:1875273] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060910+0800 OCTest[49150:1875274] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.060941+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ2
2021-06-01 21:23:42.060959+0800 OCTest[49150:1875275] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061002+0800 OCTest[49150:1875276] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061048+0800 OCTest[49150:1875277] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061077+0800 OCTest[49150:1875278] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061115+0800 OCTest[49150:1875279] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061187+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ2
2021-06-01 21:23:42.061221+0800 OCTest[49150:1875281] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061320+0800 OCTest[49150:1875282] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061327+0800 OCTest[49150:1875283] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061156+0800 OCTest[49150:1875280] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061346+0800 OCTest[49150:1875284] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061405+0800 OCTest[49150:1875285] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061434+0800 OCTest[49150:1875286] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061474+0800 OCTest[49150:1875287] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061510+0800 OCTest[49150:1875288] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061574+0800 OCTest[49150:1875290] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061547+0800 OCTest[49150:1875289] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061636+0800 OCTest[49150:1875291] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061671+0800 OCTest[49150:1875292] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061755+0800 OCTest[49150:1875293] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061819+0800 OCTest[49150:1875294] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061645+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ2
2021-06-01 21:23:42.061802+0800 OCTest[49150:1875295] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061935+0800 OCTest[49150:1875297] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.061899+0800 OCTest[49150:1875296] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.062126+0800 OCTest[49150:1875298] ğŸŠ ğŸŠ ğŸŠ è¯»æ“ä½œ1
2021-06-01 21:23:42.062160+0800 OCTest[49150:1875299] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.062192+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ2
2021-06-01 21:23:42.062200+0800 OCTest[49150:1875300] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.062247+0800 OCTest[49150:1875301] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.062274+0800 OCTest[49150:1875302] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:42.062444+0800 OCTest[49150:1874181] ğŸ ğŸ ğŸ å†™æ“ä½œ2
2021-06-01 21:23:43.055129+0800 OCTest[49150:1875102] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:43.055269+0800 OCTest[49150:1875240] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--1 <NSThread: 0x600002042a80>{number = 7, name = (null)}
2021-06-01 21:23:44.059101+0800 OCTest[49150:1875240] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:44.059136+0800 OCTest[49150:1875244] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--5 <NSThread: 0x600002000e80>{number = 8, name = (null)}
2021-06-01 21:23:45.062779+0800 OCTest[49150:1875244] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:45.062808+0800 OCTest[49150:1875243] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--4 <NSThread: 0x60000200aa40>{number = 9, name = (null)}
2021-06-01 21:23:46.066867+0800 OCTest[49150:1875243] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:46.066941+0800 OCTest[49150:1875241] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--2 <NSThread: 0x60000201ba80>{number = 10, name = (null)}
2021-06-01 21:23:47.072205+0800 OCTest[49150:1875241] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:47.072235+0800 OCTest[49150:1875242] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--3 <NSThread: 0x600002052400>{number = 11, name = (null)}
2021-06-01 21:23:48.075550+0800 OCTest[49150:1875242] ğŸŒ° ğŸŒ° ğŸŒ° ------ã€‹ã€‰å†™æ“ä½œ
2021-06-01 21:23:48.075615+0800 OCTest[49150:1875245] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--6 <NSThread: 0x60000200d840>{number = 12, name = (null)}
2021-06-01 21:23:49.079437+0800 OCTest[49150:1875246] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--7 <NSThread: 0x60000200ad40>{number = 13, name = (null)}
2021-06-01 21:23:50.083392+0800 OCTest[49150:1875247] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--8 <NSThread: 0x60000200d840>{number = 14, name = (null)}
2021-06-01 21:23:51.084361+0800 OCTest[49150:1875268] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:52.085362+0800 OCTest[49150:1875268] è¯» å™¼é‡Œå•ªå•¦--8 <NSThread: 0x60000200ab40>{number = 15, name = (null)}
2021-06-01 21:23:52.085422+0800 OCTest[49150:1875301] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--12 <NSThread: 0x60000200d040>{number = 16, name = (null)}
2021-06-01 21:23:53.086301+0800 OCTest[49150:1875302] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--13 <NSThread: 0x600002051e00>{number = 17, name = (null)}
2021-06-01 21:23:54.087017+0800 OCTest[49150:1875253] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:54.087032+0800 OCTest[49150:1875251] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:55.092658+0800 OCTest[49150:1875251] è¯» å™¼é‡Œå•ªå•¦--13 <NSThread: 0x6000020533c0>{number = 18, name = (null)}
2021-06-01 21:23:55.092658+0800 OCTest[49150:1875253] è¯» å™¼é‡Œå•ªå•¦--13 <NSThread: 0x60000200d8c0>{number = 19, name = (null)}
2021-06-01 21:23:55.092684+0800 OCTest[49150:1875248] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--9 <NSThread: 0x60000200acc0>{number = 20, name = (null)}
2021-06-01 21:23:56.096441+0800 OCTest[49150:1875276] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:56.096442+0800 OCTest[49150:1875278] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:56.096441+0800 OCTest[49150:1875275] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:56.096438+0800 OCTest[49150:1875249] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:57.101096+0800 OCTest[49150:1875276] è¯» å™¼é‡Œå•ªå•¦--9 <NSThread: 0x60000207a100>{number = 23, name = (null)}
2021-06-01 21:23:57.101100+0800 OCTest[49150:1875249] è¯» å™¼é‡Œå•ªå•¦--9 <NSThread: 0x600002043900>{number = 22, name = (null)}
2021-06-01 21:23:57.101108+0800 OCTest[49150:1875278] è¯» å™¼é‡Œå•ªå•¦--9 <NSThread: 0x60000201b580>{number = 24, name = (null)}
2021-06-01 21:23:57.101100+0800 OCTest[49150:1875275] è¯» å™¼é‡Œå•ªå•¦--9 <NSThread: 0x60000200acc0>{number = 21, name = (null)}
2021-06-01 21:23:57.101141+0800 OCTest[49150:1875300] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--11 <NSThread: 0x60000200d880>{number = 25, name = (null)}
2021-06-01 21:23:58.102176+0800 OCTest[49150:1875299] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201a540>{number = 26, name = (null)}
2021-06-01 21:23:59.104168+0800 OCTest[49150:1875292] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104179+0800 OCTest[49150:1875274] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104169+0800 OCTest[49150:1875277] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104234+0800 OCTest[49150:1875293] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104235+0800 OCTest[49150:1875294] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104239+0800 OCTest[49150:1875295] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104240+0800 OCTest[49150:1875259] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104251+0800 OCTest[49150:1875298] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104262+0800 OCTest[49150:1875260] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104280+0800 OCTest[49150:1875267] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104294+0800 OCTest[49150:1875258] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104301+0800 OCTest[49150:1875266] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104313+0800 OCTest[49150:1875291] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104171+0800 OCTest[49150:1875261] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104345+0800 OCTest[49150:1875289] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104348+0800 OCTest[49150:1875265] ğŸ ğŸ 2021-06-01 21:23:59.104423+0800 OCTest[49150:1875257] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104382+0800 OCTest[49150:1875272] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104388+0800 OCTest[49150:1875263] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104427+0800 OCTest[49150:1875262] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104427+0800 OCTest[49150:1875296] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104435+0800 OCTest[49150:1875288] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104464+0800 OCTest[49150:1875264] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104497+0800 OCTest[49150:1875297] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104504+0800 OCTest[49150:1875256] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104507+0800 OCTest[49150:1875255] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104510+0800 OCTest[49150:1875269] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104551+0800 OCTest[49150:1875273] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104569+0800 OCTest[49150:1875250] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104573+0800 OCTest[49150:1875287] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104572+0800 OCTest[49150:1875252] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104584+0800 OCTest[49150:1875270] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104607+0800 OCTest[49150:1875254] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104608+0800 OCTest[49150:1875285] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104619+0800 OCTest[49150:1875286] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104664+0800 OCTest[49150:1875280] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104619+0800 OCTest[49150:1875282] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104675+0800 OCTest[49150:1875271] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104667+0800 OCTest[49150:1875283] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104732+0800 OCTest[49150:1875279] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104683+0800 OCTest[49150:1875281] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104712+0800 OCTest[49150:1875284] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:23:59.104682+0800 OCTest[49150:1875290] ğŸ ğŸ ğŸ è¯»æ“ä½œ1
2021-06-01 21:24:00.105580+0800 OCTest[49150:1875293] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x6000020075c0>{number = 28, name = (null)}
2021-06-01 21:24:00.105592+0800 OCTest[49150:1875292] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201c680>{number = 27, name = (null)}
2021-06-01 21:24:00.105594+0800 OCTest[49150:1875294] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002053ec0>{number = 29, name = (null)}
2021-06-01 21:24:00.105626+0800 OCTest[49150:1875259] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000200d8c0>{number = 30, name = (null)}
2021-06-01 21:24:00.105657+0800 OCTest[49150:1875295] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201e380>{number = 31, name = (null)}
2021-06-01 21:24:00.105678+0800 OCTest[49150:1875277] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002078a00>{number = 32, name = (null)}
2021-06-01 21:24:00.105699+0800 OCTest[49150:1875274] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002000e40>{number = 33, name = (null)}
2021-06-01 21:24:00.106405+0800 OCTest[49150:1875298] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201e240>{number = 34, name = (null)}
2021-06-01 21:24:00.106839+0800 OCTest[49150:1875260] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000200d5c0>{number = 35, name = (null)}
2021-06-01 21:24:00.107150+0800 OCTest[49150:1875258] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201aa00>{number = 36, name = (null)}
2021-06-01 21:24:00.107471+0800 OCTest[49150:1875289] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002007a00>{number = 37, name = (null)}
2021-06-01 21:24:00.107824+0800 OCTest[49150:1875291] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002007800>{number = 38, name = (null)}
2021-06-01 21:24:00.107992+0800 OCTest[49150:1875261] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201abc0>{number = 39, name = (null)}
2021-06-01 21:24:00.108320+0800 OCTest[49150:1875252] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201be80>{number = 40, name = (null)}
2021-06-01 21:24:00.108564+0800 OCTest[49150:1875287] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002007a00>{number = 41, name = (null)}
2021-06-01 21:24:00.109351+0800 OCTest[49150:1875266] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000200c400>{number = 44, name = (null)}
2021-06-01 21:24:00.109350+0800 OCTest[49150:1875256] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002000cc0>{number = 42, name = (null)}
2021-06-01 21:24:00.109361+0800 OCTest[49150:1875269] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201b340>{number = 43, name = (null)}
2021-06-01 21:24:00.109727+0800 OCTest[49150:1875297] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201b0c0>{number = 45, name = (null)}
2021-06-01 21:24:00.110234+0800 OCTest[49150:1875288] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000200d600>{number = 48, name = (null)}
2021-06-01 21:24:00.109838+0800 OCTest[49150:1875264] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002007640>{number = 46, name = (null)}
2021-06-01 21:24:00.110236+0800 OCTest[49150:1875296] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201bcc0>{number = 47, name = (null)}
2021-06-01 21:24:00.110339+0800 OCTest[49150:1875255] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000200d780>{number = 49, name = (null)}
2021-06-01 21:24:00.110921+0800 OCTest[49150:1875273] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002000dc0>{number = 51, name = (null)}
2021-06-01 21:24:00.110915+0800 OCTest[49150:1875250] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002051fc0>{number = 50, name = (null)}
2021-06-01 21:24:00.110934+0800 OCTest[49150:1875257] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x6000020077c0>{number = 52, name = (null)}
2021-06-01 21:24:00.113876+0800 OCTest[49150:1875263] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x6000020074c0>{number = 55, name = (null)}
2021-06-01 21:24:00.113849+0800 OCTest[49150:1875265] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002052940>{number = 54, name = (null)}
2021-06-01 21:24:00.113963+0800 OCTest[49150:1875272] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002000d40>{number = 57, name = (null)}
2021-06-01 21:24:00.113920+0800 OCTest[49150:1875262] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002079f40>{number = 56, name = (null)}
2021-06-01 21:24:00.113849+0800 OCTest[49150:1875267] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000207a6c0>{number = 53, name = (null)}
2021-06-01 21:24:00.119015+0800 OCTest[49150:1875285] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201e480>{number = 59, name = (null)}
2021-06-01 21:24:00.119016+0800 OCTest[49150:1875271] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000200d740>{number = 60, name = (null)}
2021-06-01 21:24:00.119015+0800 OCTest[49150:1875286] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002051d00>{number = 58, name = (null)}
2021-06-01 21:24:00.119033+0800 OCTest[49150:1875280] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002079f80>{number = 61, name = (null)}
2021-06-01 21:24:00.119056+0800 OCTest[49150:1875270] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002001540>{number = 62, name = (null)}
2021-06-01 21:24:00.119073+0800 OCTest[49150:1875282] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000200d800>{number = 63, name = (null)}
2021-06-01 21:24:00.119088+0800 OCTest[49150:1875254] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000207a0c0>{number = 64, name = (null)}
2021-06-01 21:24:00.119491+0800 OCTest[49150:1875283] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201c6c0>{number = 65, name = (null)}
2021-06-01 21:24:00.119494+0800 OCTest[49150:1875281] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002000dc0>{number = 66, name = (null)}
2021-06-01 21:24:00.119555+0800 OCTest[49150:1875290] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201ad00>{number = 67, name = (null)}
2021-06-01 21:24:00.119707+0800 OCTest[49150:1875279] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x600002002040>{number = 68, name = (null)}
2021-06-01 21:24:00.119911+0800 OCTest[49150:1875102] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--14 <NSThread: 0x600002005680>{number = 4, name = (null)}
2021-06-01 21:24:00.119914+0800 OCTest[49150:1875284] è¯» å™¼é‡Œå•ªå•¦--10 <NSThread: 0x60000201b580>{number = 69, name = (null)}
2021-06-01 21:24:01.121618+0800 OCTest[49150:1875240] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--15 <NSThread: 0x600002042a80>{number = 7, name = (null)}
2021-06-01 21:24:02.122389+0800 OCTest[49150:1875244] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--16 <NSThread: 0x600002000e80>{number = 8, name = (null)}
2021-06-01 21:24:03.124373+0800 OCTest[49150:1875243] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--17 <NSThread: 0x60000200aa40>{number = 9, name = (null)}
2021-06-01 21:24:04.125953+0800 OCTest[49150:1875241] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--18 <NSThread: 0x60000201ba80>{number = 10, name = (null)}
2021-06-01 21:24:05.131037+0800 OCTest[49150:1875242] å†™æ“ä½œ å™¼é‡Œå•ªå•¦--19 <NSThread: 0x600002052400>{number = 11, name = (null)}


```

è¯»å†™åºåˆ—å›¾:

![multithread1.png](./../../Pictures/multithread1.png)



æ ¹æ®ä¸Šé¢çš„æ‰“å°ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨å†™çš„æ‰“å°ï¼šå†™æ“ä½œ å™¼é‡Œå•ªå•¦--1 å’Œ ğŸ å­—æ ·ï¼Œå…¶ä»–çš„éƒ½æ˜¯çƒŸé›¾å¼¹ã€‚æˆ‘ä»¬å†ç»“åˆä¸Šé¢çš„çº¿ç¨‹æ—¶åºå›¾å¯ä»¥çœ‹åˆ°ï¼Œä¸€èˆ¬éƒ½æ˜¯ç­‰åˆ°æ …æ éƒ½å®Œæˆåå†æ‰§è¡Œå…¶ä»–çš„ã€‚æ‰€ä»¥ä¸€èˆ¬éƒ½æ˜¯å…ˆå†™å‰10ä¸ªï¼Œå†æ˜¯è¯»ï¼Œç„¶åæ¥ç€å†™ã€‚


<br/>

ä¸‹é¢è´´ä¸Šä¸€ä¸ªAFNçš„å®ç° , requestHeaderModificationQueueæ˜¯ä¸€ä¸ªç”±AFHTTPRequestSerializeråˆ›å»ºçš„å¹¶å‘é˜Ÿåˆ—, ä½¿ç”¨è¿™ä¸ªå¹¶å‘é˜Ÿåˆ—å¯¹ä¸€ä¸ªNSMutableDictionaryå®ç°äº†å¤šè¯»å•å†™çš„é”.



```
self.requestHeaderModificationQueue = dispatch_queue_create("requestHeaderModificationQueue", DISPATCH_QUEUE_CONCURRENT);

```


![multithread0.png](./../../Pictures/multithread0.png)




<br/>
<br/>
<br/>


> <h2 id='pthread_rwlockäº’æ–¥é”'>pthread_rwlockäº’æ–¥é”</h2>

**ä½¿ç”¨pthread_rwlock äº’æ–¥é”ï¼ˆä¼šä¼‘çœ ï¼‰:**


![multithread2.png](./../../Pictures/multithread2.png)

<br/>

```
#import <pthread.h>

@property (assign, nonatomic) pthread_rwlock_t lock;


- (void) testAction {
    
    [self testMethod3];
    
}


//è¯»å†™äº’æ–¥é”æµ‹è¯•
- (void) testMethod3 {
    // åˆå§‹åŒ–é”
        pthread_rwlock_init(&_lock, NULL);
        
        dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
        
        for (int i = 0; i < 5; i++) {
            dispatch_async(queue, ^{
                [self read];
            });
            dispatch_async(queue, ^{
                [self write];
            });
        }
}

- (void)read {
    //è¯»é”
    pthread_rwlock_rdlock(&_lock);
    
    sleep(1);
    NSLog(@"ğŸ ğŸ %s", __func__);
    
    pthread_rwlock_unlock(&_lock);
}

- (void)write
{
    //å†™é”
    pthread_rwlock_wrlock(&_lock);
    
    sleep(1);
    NSLog(@"ğŸŠ ğŸŠ %s", __func__);
    
    pthread_rwlock_unlock(&_lock);
}
```

æ‰“å°ï¼š

```
021-06-01 22:30:57.268204+0800 OCTest[50381:1928202] ğŸ ğŸ -[ViewController read]
2021-06-01 22:30:58.272268+0800 OCTest[50381:1928423] ğŸŠ ğŸŠ -[ViewController write]
2021-06-01 22:30:59.275954+0800 OCTest[50381:1928424] ğŸ ğŸ -[ViewController read]
2021-06-01 22:31:00.280702+0800 OCTest[50381:1928425] ğŸŠ ğŸŠ -[ViewController write]
2021-06-01 22:31:01.283694+0800 OCTest[50381:1928426] ğŸ ğŸ -[ViewController read]
2021-06-01 22:31:02.284539+0800 OCTest[50381:1928427] ğŸŠ ğŸŠ -[ViewController write]
2021-06-01 22:31:03.285518+0800 OCTest[50381:1928428] ğŸ ğŸ -[ViewController read]
2021-06-01 22:31:04.286463+0800 OCTest[50381:1928429] ğŸŠ ğŸŠ -[ViewController write]
2021-06-01 22:31:05.287468+0800 OCTest[50381:1928430] ğŸ ğŸ -[ViewController read]
2021-06-01 22:31:06.288403+0800 OCTest[50381:1928431] ğŸŠ ğŸŠ -[ViewController write]
```






<br/>
<br/>

> <h2 id=''></h2>







<br/>
<br/>
<br/>

***
<br/>




> <h1 id='NSOperation'>NSOperation</h1>


> <h2 id='æ“ä½œå’Œæ“ä½œé˜Ÿåˆ—'>æ“ä½œå’Œæ“ä½œé˜Ÿåˆ—</h2>


- **`æ“ä½œ(Operation):`**

&emsp;  æ‰§è¡Œæ“ä½œ,æ¢å¥è¯è¯´å°±æ˜¯ä½ åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œçš„é‚£æ®µä»£ç ã€‚

&emsp;  åœ¨ GCD ä¸­æ˜¯æ”¾åœ¨ block ä¸­çš„ã€‚åœ¨ NSOperation ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ NSOperation å­ç±» NSInvocationOperationã€NSBlockOperationï¼Œæˆ–è€…è‡ªå®šä¹‰å­ç±»æ¥å°è£…æ“ä½œã€‚


<br/>

- **`æ“ä½œé˜Ÿåˆ—(Operation Queues)`**

&emsp;  è¿™é‡Œçš„é˜Ÿåˆ—æŒ‡æ“ä½œé˜Ÿåˆ—ï¼Œå³ç”¨æ¥å­˜æ”¾æ“ä½œçš„é˜Ÿåˆ—ã€‚ä¸åŒäº GCD ä¸­çš„è°ƒåº¦é˜Ÿåˆ— FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰çš„åŸåˆ™ã€‚NSOperationQueue å¯¹äºæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„æ“ä½œï¼Œé¦–å…ˆè¿›å…¥å‡†å¤‡å°±ç»ªçš„çŠ¶æ€ï¼ˆå°±ç»ªçŠ¶æ€å–å†³äºæ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼‰ï¼Œç„¶åè¿›å…¥å°±ç»ªçŠ¶æ€çš„æ“ä½œçš„å¼€å§‹æ‰§è¡Œé¡ºåºï¼ˆéç»“æŸæ‰§è¡Œé¡ºåºï¼‰ç”±æ“ä½œä¹‹é—´ç›¸å¯¹çš„ä¼˜å…ˆçº§å†³å®šï¼ˆä¼˜å…ˆçº§æ˜¯æ“ä½œå¯¹è±¡è‡ªèº«çš„å±æ€§ï¼‰ã€‚

&emsp;  æ“ä½œé˜Ÿåˆ—é€šè¿‡è®¾ç½®æœ€å¤§å¹¶å‘æ“ä½œæ•°ï¼ˆmaxConcurrentOperationCountï¼‰æ¥æ§åˆ¶å¹¶å‘ã€ä¸²è¡Œã€‚

&emsp;  NSOperationQueue ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§ä¸åŒç±»å‹çš„é˜Ÿåˆ—ï¼šä¸»é˜Ÿåˆ—å’Œè‡ªå®šä¹‰é˜Ÿåˆ—ã€‚ä¸»é˜Ÿåˆ—è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¹‹ä¸Šï¼Œè€Œè‡ªå®šä¹‰é˜Ÿåˆ—åœ¨åå°æ‰§è¡Œã€‚




<br/>
<br/>





> <h2 id='å±æ€§'>å±æ€§</h2>

- é˜Ÿåˆ—ä¼˜å…ˆçº§
	- 	**`queuePriority`:**

```
typedef NS_ENUM(NSInteger, NSOperationQueuePriority){
        NSOperationQueuePriorityVeryLow = -8L,
        NSOperationQueuePriorityLow = -4L,
        NSOperationQueuePriorityNormal = 0,
        NSOperationQueuePriorityHigh = 4,
        NSOperationQueuePriorityVeryHigh = 8
}

```

- æ§åˆ¶ä¸²è¡Œæ‰§è¡Œã€å¹¶å‘æ‰§è¡Œ

	- `maxConcurrentOperationCount`ï¼šæ§åˆ¶çš„ä¸æ˜¯å¹¶å‘çº¿ç¨‹çš„æ•°é‡ï¼Œè€Œæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ä¸­åŒæ—¶èƒ½å¹¶å‘æ‰§è¡Œçš„æœ€å¤§æ“ä½œæ•°ã€‚è€Œä¸”ä¸€ä¸ªæ“ä½œä¹Ÿå¹¶éåªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œã€‚

- completionBlock

	completionBlock	å¯è¯»å¯å†™ï¼Œå½“ finished çš„å€¼æ›´æ”¹ä¸º YES æ—¶ï¼Œå°†æ‰§è¡Œè¯¥ä»£ç å—ã€‚
	
	completionBlocké€šå¸¸æ˜¯ä¸€ä¸ªå­çº¿ç¨‹æ‰§è¡Œï¼›å› æ­¤ï¼Œä¸åº”è¯¥ä½¿ç”¨è¿™ä¸ªå—æ¥åšåˆ·æ–°UIã€‚
	
	finished=YESå¯èƒ½å› ä¸ºå®ƒè¢«å–æ¶ˆæˆ–è€…å› ä¸ºå®ƒå®Œæˆä»»åŠ¡è€Œç»“æŸï¼›åœ¨ç¼–å†™ä»£ç å—æ—¶ï¼Œåº”è¯¥è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚
 
	completionBlock ç±»ä¼¼äºGCDçš„å‡½æ•°  dispatch_block_notify() ï¼Œç›‘å¬ dispatch_block å®Œæˆæ—¶ dispatch_queue è°ƒç”¨ notification_block




<br/>
<br/>





> <h2 id='çº¿ç¨‹å®‰å…¨'>çº¿ç¨‹å®‰å…¨</h2>


ä»å¤šä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨ä¸€ä¸ªNSOperationQueueå¯¹è±¡æ˜¯å®‰å…¨çš„ï¼Œæ— éœ€åˆ›å»ºé¢å¤–çš„é”æ¥åŒæ­¥å¯¹è¯¥å¯¹è±¡çš„è®¿é—®ã€‚

æ“ä½œé˜Ÿåˆ—ä½¿ç”¨è°ƒåº¦æ¡†æ¶æ¥å¯åŠ¨å…¶æ“ä½œçš„æ‰§è¡Œã€‚å› æ­¤ï¼Œæ“ä½œæ€»æ˜¯åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œè€Œä¸ç®¡å®ƒä»¬æ˜¯è¢«æŒ‡å®šä¸ºåŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„ã€‚


<br/>


```
NSInvocationOperation *op1 = [[NSInvocationOperation alloc] initWithTarget:self selector:@selector(taskOne) object: nil];

- (void) taskOne {
            for();
}

NSBlockOperation *op2 = [NSBlockOperation blockOperationWithBlock:^{

}];

NSOperationQueue *operation = [[NSOperationQueue alloc] init];

[operation addOperation: op1];
[operation addOperation: op2];

```


<br/>

**`- (void) addOperationWithBlock:(void (^)(void))block {}`**


```
NSOperationQueue *queue = [[NSOperationQueue alloc] init];
[queue addOperationWithBlock:^{
      
}];

```





<br/>
<br/>



> <h2 id='NSOperationã€NSOperationQueueä½¿ç”¨æ–¹æ³•'>NSOperationã€NSOperationQueueä½¿ç”¨æ–¹æ³•</h2>


&emsp;  `NSOperation` éœ€è¦é…åˆ `NSOperationQueue` æ¥å®ç°å¤šçº¿ç¨‹ã€‚å› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼Œ`NSOperation` å•ç‹¬ä½¿ç”¨æ—¶æ˜¯ç³»ç»Ÿçš„åŒæ­¥æ‰§è¡Œæ“ä½œï¼Œé…åˆ NSOperationQueue å¯ä»¥å®ç°å¼‚æ­¥æ‰§è¡Œã€‚


<br/>

- `NSOperationå®ç°å¤šçº¿ç¨‹çš„æ­¥éª¤ä¸ºï¼š`

	- åˆ›å»ºæ“ä½œï¼šå…ˆå°†éœ€è¦æ‰§è¡Œçš„æ“ä½œå°è£…åˆ°ä¸€ä¸ª NSOperation å¯¹è±¡ä¸­ã€‚
	
	- åˆ›å»ºé˜Ÿåˆ—ï¼šåˆ›å»º NSOperationQueue å¯¹è±¡ã€‚
	
	- å°†æ“ä½œåŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼šå°† NSOperation å¯¹è±¡æ·»åŠ åˆ° NSOperationQueue å¯¹è±¡ä¸­ã€‚

ä¹‹åç³»ç»Ÿå°±ä¼šè‡ªåŠ¨å°† NSOperationQueue ä¸­çš„ NSOperation å–å‡ºæ¥ï¼Œåœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œæ“ä½œã€‚


<br/>
<br/>



`NSOperationçš„åˆ›å»ºæ“ä½œ:`

&emsp; NSOperation æ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œä¸èƒ½ç”¨æ¥å°è£…æ“ä½œã€‚æˆ‘ä»¬åªæœ‰ä½¿ç”¨å®ƒçš„å­ç±»æ¥å°è£…æ“ä½œã€‚æˆ‘ä»¬æœ‰ä¸‰ç§æ–¹å¼æ¥å°è£…æ“ä½œã€‚

â‘ .  ä½¿ç”¨å­ç±» NSInvocationOperation;

â‘¡.  ä½¿ç”¨å­ç±» NSBlockOperation;

â‘¢.  è‡ªå®šä¹‰ç»§æ‰¿è‡ª NSOperation çš„å­ç±»ï¼Œé€šè¿‡å®ç°å†…éƒ¨ç›¸åº”çš„æ–¹æ³•æ¥å°è£…æ“ä½œ;

&emsp; åœ¨ä¸ä½¿ç”¨ NSOperationQueueï¼Œå•ç‹¬ä½¿ç”¨ NSOperation çš„æƒ…å†µä¸‹ç³»ç»ŸåŒæ­¥æ‰§è¡Œæ“ä½œï¼Œä¸‹é¢æˆ‘ä»¬å­¦ä¹ ä»¥ä¸‹æ“ä½œçš„ä¸‰ç§åˆ›å»ºæ–¹å¼ã€‚






<br/>
<br/>



> <h3 id=' NSInvocationOperationä½¿ç”¨'> NSInvocationOperationä½¿ç”¨</h3>


 åœ¨ä¸»çº¿ç¨‹ä½¿ç”¨NSInvocationOperation:
 
 ```

/**
 * ä½¿ç”¨å­ç±» NSInvocationOperation
 */
- (void)useInvocationOperation {
    
    // 1.åˆ›å»º NSInvocationOperation å¯¹è±¡
    NSInvocationOperation *op = [[NSInvocationOperation alloc] initWithTarget:self selector:@selector(task1) object:nil];
    
    // 2.è°ƒç”¨ start æ–¹æ³•å¼€å§‹æ‰§è¡Œæ“ä½œ
    [op start];
}

/**
 * ä»»åŠ¡1
 */
- (void)task1 {
    for (int i = 0; i < 2; i++) {
        [NSThread sleepForTimeInterval:2];              // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        NSLog(@"1---%@", [NSThread currentThread]);     // æ‰“å°å½“å‰çº¿ç¨‹
    }
}

```

è¾“å‡ºï¼š

```
2019-05-20 14:22:37.467721+0800 YSC-NSOperation-demo[3051:82251] 1---<NSThread: 0x600001d62680>{number = 1, name = main}

2019-05-20 14:22:39.469215+0800 YSC-NSOperation-demo[3051:82251] 1---<NSThread: 0x600001d62680>{number = 1, name = main}
```

 


&emsp;  åœ¨æ²¡æœ‰ä½¿ç”¨NSOperationQueueã€åœ¨ä¸»çº¿ç¨‹ä¸­å•ç‹¬ä½¿ç”¨å­ç±» NSInvocationOperation æ‰§è¡Œä¸€ä¸ªæ“ä½œçš„æƒ…å†µä¸‹ï¼Œæ“ä½œæ˜¯åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå¹¶æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ã€‚


 




<br/>
<br/>



> <h3 id='å­ç¨‹ä½¿ç”¨NSInvocationOperation'>å­ç¨‹ä½¿ç”¨NSInvocationOperation</h3>

```
//    åœ¨å…¶ä»–çº¿ç¨‹ä½¿ç”¨å­ç±» NSInvocationOperation
[NSThread detachNewThreadSelector:@selector(useInvocationOperation) toTarget:self withObject:nil];


/**
 * ä½¿ç”¨å­ç±» NSInvocationOperation
 */
- (void)useInvocationOperation {
    
    // 1.åˆ›å»º NSInvocationOperation å¯¹è±¡
    NSInvocationOperation *op = [[NSInvocationOperation alloc] initWithTarget:self selector:@selector(task1) object:nil];
    
    // 2.è°ƒç”¨ start æ–¹æ³•å¼€å§‹æ‰§è¡Œæ“ä½œ
    [op start];
}

/**
 * ä»»åŠ¡1
 */
- (void)task1 {
    for (int i = 0; i < 2; i++) {
        [NSThread sleepForTimeInterval:2];              // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        NSLog(@"1---%@", [NSThread currentThread]);     // æ‰“å°å½“å‰çº¿ç¨‹
    }
}
```

è¾“å‡ºï¼š

 ```
019-05-20 14:34:38.696854+0800 YSC-NSOperation-demo[3197:87716] 1---<NSThread: 0x600001980600>{number = 3, name = (null)}
 
2019-05-20 14:34:40.701441+0800 YSC-NSOperation-demo[3197:87716] 1---<NSThread: 0x600001980600>{number = 3, name = (null)}
```

&emsp; åœ¨å…¶ä»–çº¿ç¨‹ä¸­å•ç‹¬ä½¿ç”¨å­ç±» NSInvocationOperationï¼Œæ“ä½œæ˜¯åœ¨å½“å‰è°ƒç”¨çš„å…¶ä»–çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå¹¶æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ã€‚






<br/>
<br/>



> <h2 id='NSBlockOperation'>NSBlockOperation</h2>


```
//    åœ¨å½“å‰çº¿ç¨‹ä½¿ç”¨ NSBlockOperation
[self useBlockOperation];


/**
 * ä½¿ç”¨å­ç±» NSBlockOperation
 */
- (void)useBlockOperation {
    
    // 1.åˆ›å»º NSBlockOperation å¯¹è±¡
    NSBlockOperation *op = [NSBlockOperation blockOperationWithBlock:^{
        for (int i = 0; i < 2; i++) {
            [NSThread sleepForTimeInterval:2];          // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
            NSLog(@"1---%@", [NSThread currentThread]); // æ‰“å°å½“å‰çº¿ç¨‹
        }
    }];
    
    // 2.è°ƒç”¨ start æ–¹æ³•å¼€å§‹æ‰§è¡Œæ“ä½œ
    [op start];
}
```

è¾“å‡ºï¼š

```
2019-05-20 17:02:04.186312+0800 YSC-NSOperation-demo[21633:174028] 1---<NSThread: 0x600001554140>{number = 1, name = main}

2019-05-20 17:02:06.187878+0800 YSC-NSOperation-demo[21633:174028] 1---<NSThread: 0x600001554140>{number = 1, name = main}
```

&emsp;  åœ¨æ²¡æœ‰ä½¿ç”¨ NSOperationQueueã€åœ¨ä¸»çº¿ç¨‹ä¸­å•ç‹¬ä½¿ç”¨ NSBlockOperation æ‰§è¡Œä¸€ä¸ªæ“ä½œçš„æƒ…å†µä¸‹ï¼Œæ“ä½œæ˜¯åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå¹¶æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ã€‚

&emsp;  ä¸ NSInvocationOperation ä½¿ç”¨ä¸€æ ·ã€‚å› ä¸ºä»£ç æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨çš„ï¼Œæ‰€ä»¥æ‰“å°ç»“æœä¸ºä¸»çº¿ç¨‹ã€‚å¦‚æœåœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œæ“ä½œï¼Œåˆ™æ‰“å°ç»“æœä¸ºå…¶ä»–çº¿ç¨‹ã€‚


<br/>

```
//ä½¿ç”¨ NSBlockOperation çš„ AddExecutionBlock: æ–¹æ³•
[self useBlockOperationAddExecutionBlock];


/**
 * ä½¿ç”¨å­ç±» NSBlockOperation
 * è°ƒç”¨æ–¹æ³• AddExecutionBlock:
 */
- (void)useBlockOperationAddExecutionBlock {
    
    // 1.åˆ›å»º NSBlockOperation å¯¹è±¡
    NSBlockOperation *op = [NSBlockOperation blockOperationWithBlock:^{
        for (int i = 0; i < 2; i++) {
            [NSThread sleepForTimeInterval:2];          // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
            NSLog(@"1---%@", [NSThread currentThread]); // æ‰“å°å½“å‰çº¿ç¨‹
        }
    }];
    
    // 2.æ·»åŠ é¢å¤–çš„æ“ä½œ
    [op addExecutionBlock:^{
        for (int i = 0; i < 2; i++) {
            [NSThread sleepForTimeInterval:2];          // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
            NSLog(@"2---%@", [NSThread currentThread]); // æ‰“å°å½“å‰çº¿ç¨‹
        }
    }];
    [op addExecutionBlock:^{
        for (int i = 0; i < 2; i++) {
            [NSThread sleepForTimeInterval:2];          // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
            NSLog(@"3---%@", [NSThread currentThread]); // æ‰“å°å½“å‰çº¿ç¨‹
        }
    }];
    [op addExecutionBlock:^{
        for (int i = 0; i < 2; i++) {
            [NSThread sleepForTimeInterval:2];          // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
            NSLog(@"4---%@", [NSThread currentThread]); // æ‰“å°å½“å‰çº¿ç¨‹
        }
    }];
    [op addExecutionBlock:^{
        for (int i = 0; i < 2; i++) {
            [NSThread sleepForTimeInterval:2];          // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
            NSLog(@"5---%@", [NSThread currentThread]); // æ‰“å°å½“å‰çº¿ç¨‹
        }
    }];
    // 3.è°ƒç”¨ start æ–¹æ³•å¼€å§‹æ‰§è¡Œæ“ä½œ
    [op start];
}

```

è¾“å‡ºï¼š

```
2019-05-20 17:18:39.602123+0800 YSC-NSOperation-demo[22041:183103] 3---<NSThread: 0x60000138af00>{number = 1, name = main}

2019-05-20 17:18:39.602129+0800 YSC-NSOperation-demo[22041:183155] 1---<NSThread: 0x6000013d0140>{number = 4, name = (null)}

2019-05-20 17:18:39.602128+0800 YSC-NSOperation-demo[22041:183154] 2---<NSThread: 0x6000013d9440>{number = 5, name = (null)}

2019-05-20 17:18:39.602130+0800 YSC-NSOperation-demo[22041:183162] 4---<NSThread: 0x6000013d4700>{number = 3, name = (null)}

2019-05-20 17:18:41.602619+0800 YSC-NSOperation-demo[22041:183155] 1---<NSThread: 0x6000013d0140>{number = 4, name = (null)}

2019-05-20 17:18:41.602619+0800 YSC-NSOperation-demo[22041:183103] 3---<NSThread: 0x60000138af00>{number = 1, name = main}

2019-05-20 17:18:41.602619+0800 YSC-NSOperation-demo[22041:183154] 2---<NSThread: 0x6000013d9440>{number = 5, name = (null)}

2019-05-20 17:18:41.602619+0800 YSC-NSOperation-demo[22041:183162] 4---<NSThread: 0x6000013d4700>{number = 3, name = (null)}

2019-05-20 17:18:43.603699+0800 YSC-NSOperation-demo[22041:183162] 5---<NSThread: 0x6000013d4700>{number = 3, name = (null)}

2019-05-20 17:18:45.604132+0800 YSC-NSOperation-demo[22041:183162] 5---<NSThread: 0x6000013d4700>{number = 3, name = (null)}

```


&emsp;  NSBlockOperation è¿˜æä¾›äº†ä¸€ä¸ªæ–¹æ³• addExecutionBlock:ï¼Œé€šè¿‡`addExecutionBlock: `å°±å¯ä»¥ä¸º NSBlockOperation æ·»åŠ é¢å¤–çš„æ“ä½œã€‚è¿™äº›æ“ä½œï¼ˆåŒ…æ‹¬ blockOperationWithBlock ä¸­çš„æ“ä½œï¼‰å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­åŒæ—¶ï¼ˆå¹¶å‘ï¼‰æ‰§è¡Œã€‚åªæœ‰å½“æ‰€æœ‰ç›¸å…³çš„æ“ä½œå·²ç»å®Œæˆæ‰§è¡Œæ—¶ï¼Œæ‰è§†ä¸ºå®Œæˆã€‚

&emsp; å¦‚æœæ·»åŠ çš„æ“ä½œå¤šçš„è¯ï¼ŒblockOperationWithBlock: ä¸­çš„æ“ä½œä¹Ÿå¯èƒ½ä¼šåœ¨å…¶ä»–çº¿ç¨‹ï¼ˆéå½“å‰çº¿ç¨‹ï¼‰ä¸­æ‰§è¡Œï¼Œè¿™æ˜¯ç”±ç³»ç»Ÿå†³å®šçš„ï¼Œå¹¶ä¸æ˜¯è¯´æ·»åŠ åˆ° blockOperationWithBlock: ä¸­çš„æ“ä½œä¸€å®šä¼šåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œã€‚ï¼ˆå¯ä»¥ä½¿ç”¨ addExecutionBlock: å¤šæ·»åŠ å‡ ä¸ªæ“ä½œè¯•è¯•ï¼‰ã€‚

&emsp;  ä½¿ç”¨å­ç±» NSBlockOperationï¼Œå¹¶è°ƒç”¨æ–¹æ³• AddExecutionBlock: çš„æƒ…å†µä¸‹ï¼ŒblockOperationWithBlock:æ–¹æ³•ä¸­çš„æ“ä½œ å’Œ addExecutionBlock: ä¸­çš„æ“ä½œæ˜¯åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­å¼‚æ­¥æ‰§è¡Œçš„ã€‚

&emsp;  è€Œä¸”ï¼Œè¿™æ¬¡æ‰§è¡Œç»“æœä¸­ blockOperationWithBlock:æ–¹æ³•ä¸­çš„æ“ä½œä¹Ÿä¸æ˜¯åœ¨å½“å‰çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ä¸­æ‰§è¡Œçš„ã€‚ä»è€Œå°è¯äº†blockOperationWithBlock: ä¸­çš„æ“ä½œä¹Ÿå¯èƒ½ä¼šåœ¨å…¶ä»–çº¿ç¨‹ï¼ˆéå½“å‰çº¿ç¨‹ï¼‰ä¸­æ‰§è¡Œã€‚

&emsp;  ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ª NSBlockOperation å¯¹è±¡å°è£…äº†å¤šä¸ªæ“ä½œã€‚NSBlockOperation æ˜¯å¦å¼€å¯æ–°çº¿ç¨‹ï¼Œå–å†³äºæ“ä½œçš„ä¸ªæ•°ã€‚å¦‚æœæ·»åŠ çš„æ“ä½œçš„ä¸ªæ•°å¤šï¼Œå°±ä¼šè‡ªåŠ¨å¼€å¯æ–°çº¿ç¨‹ã€‚å½“ç„¶å¼€å¯çš„çº¿ç¨‹æ•°æ˜¯ç”±ç³»ç»Ÿæ¥å†³å®šçš„ã€‚





<br/>
<br/>



> <h2 id=''></h2>




<br/>
<br/>


> <h2 id='å¸¸é©»çº¿ç¨‹'>å¸¸é©»çº¿ç¨‹</h2>

&emsp; åœ¨ AFNetworking 2.0 ä¸­ï¼ŒæŠŠæ¯ä¸ªè¯·æ±‚éƒ½å°è£…æˆäº†å•ç‹¬çš„ NSOperationQueueï¼Œå†ç”± NSOperationQueue æ ¹æ®å½“å‰çš„ CPU æ•°é‡å’Œç³»ç»Ÿè´Ÿè½½æ¥æ§åˆ¶å¹¶å‘ã€‚é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆ AFNetworking 2.0 æ²¡æœ‰ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œåªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”¨æ¥æ¥æ”¶ NSOperationQueue çš„å›è°ƒå‘¢ï¼Ÿ

&emsp; FMDB åªé€šè¿‡ FMDatabaseQueue å¼€å¯äº†ä¸€ä¸ªçº¿ç¨‹é˜Ÿåˆ—ï¼Œæ¥ä¸²è¡Œåœ°æ“ä½œæ•°æ®åº“ã€‚è¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

<br/>


&emsp; è¿™å¤§æ¦‚å°±æ˜¯å› ä¸ºå¤šçº¿ç¨‹æŠ€æœ¯æœ‰å‘ã€‚ç‰¹åˆ«æ˜¯ UIKit å¹²è„†å°±åšæˆäº†çº¿ç¨‹ä¸å®‰å…¨ï¼Œåªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šæ“ä½œã€‚

&emsp; è€Œå†™ UIKitã€AFNetworkingã€FMDB è¿™äº›åº“çš„â€œå¤§ç¥â€ä»¬ï¼Œå¹¶ä¸æ˜¯è§£å†³ä¸äº†å¤šçº¿ç¨‹æŠ€æœ¯å¯èƒ½ä¼šå¸¦æ¥çš„é—®é¢˜ï¼Œè€Œç›¸åæ­£æ˜¯å› ä¸ºä»–ä»¬éå¸¸æ¸…æ¥šè¿™äº›å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¸ºé¿å…ä½¿ç”¨è€…æ»¥ç”¨å¤šçº¿ç¨‹ï¼Œäº¦æˆ–æ˜¯å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œè€Œé€‰æ‹©äº†ä½¿ç”¨å•ä¸€çº¿ç¨‹æ¥ä¿è¯è¿™äº›åŸºç¡€åº“çš„ç¨³å®šå¯ç”¨ã€‚


&emsp; ä¸¾ä¸€ä¸ªåœ¨å¼€å‘ä¸­å¯èƒ½é‡åˆ°çš„ä¸€ä¸ªä¾‹å­ï¼šä»¥ç…§ç‰‡å¤„ç†ä¸ºä¾‹ï¼Œå½“é€‰æ‹©ä¸€å¼ ç…§ç‰‡åï¼Œä½ å¸Œæœ›èƒ½å¤Ÿçœ‹åˆ°ä¸åŒæ»¤é•œå¤„ç†åçš„æ•ˆæœã€‚å¦‚æœè¿™äº›æ•ˆæœå›¾éƒ½æ˜¯åœ¨ä¸€ä¸ªé˜Ÿåˆ—é‡Œä¸²è¡Œå¤„ç†çš„è¯ï¼Œé‚£ä¹ˆä½ å°±å¾—ç­‰ç€è¿™äº›æ»¤é•œä¸€ä¸ªä¸€ä¸ªåœ°æ¥å¤„ç†ã€‚è¿™ä¹ˆåšçš„è¯ï¼Œä¸ä»…ä¼šå½±å“ç”¨æˆ·ä½“éªŒï¼Œä¹Ÿæ²¡èƒ½å……åˆ†åˆ©ç”¨ç¡¬ä»¶èµ„æºï¼Œå¯ä»¥è¯´æ˜¯æŠŠé«˜ç«¯æ‰‹æœºå½“ä½œä½ç«¯æœºæ¥ç”¨äº†ã€‚æ¢å¥è¯è¯´å°±æ˜¯ï¼Œç”¨æˆ·èŠ±å¤§ä»·é’±å‡çº§äº†æ‰‹æœºç¡¬ä»¶ï¼Œæ“ä½œ App çš„ä½“éªŒå´æ²¡æœ‰å¾—åˆ°æå‡ã€‚

&emsp; æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸èƒ½å› ä¸ºå¤šçº¿ç¨‹æŠ€æœ¯æœ‰å‘å°±ä¸å»ç”¨ï¼Œæ­£ç¡®çš„æ–¹æ³•åº”è¯¥æ˜¯æ›´å¤šåœ°å»äº†è§£å¤šçº¿ç¨‹ä¼šæœ‰å“ªäº›é—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿäº‹å…ˆé¢„è§åˆ°é‚£äº›é—®é¢˜çš„è¯ï¼Œé‚£ä¹ˆé¿å…è¿™äº›é—®é¢˜çš„å‘ç”Ÿä¹Ÿå°±ä¸åœ¨è¯ä¸‹äº†ã€‚

&emsp; æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä¸€èµ·æ¥çœ‹çœ‹å¤šçº¿ç¨‹æŠ€æœ¯å¸¸è§çš„ä¸¤ä¸ªå¤§å‘ï¼Œå¸¸é©»çº¿ç¨‹å’Œå¹¶å‘é—®é¢˜ï¼Œåˆ†åˆ«æ˜¯ä»ä½•è€Œæ¥ï¼Œä»¥åŠå¦‚ä½•é¿å…å§ã€‚

<br/>


&emsp; å¸¸é©»çº¿ç¨‹ï¼ŒæŒ‡çš„å°±æ˜¯é‚£äº›ä¸ä¼šåœæ­¢ï¼Œä¸€ç›´å­˜åœ¨äºå†…å­˜ä¸­çš„çº¿ç¨‹ã€‚åœ¨ AFNetworking 2.0 ä¸“é—¨åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹æ¥æ¥æ”¶ NSOperationQueue çš„å›è°ƒï¼Œè¿™ä¸ªçº¿ç¨‹å…¶å®å°±æ˜¯ä¸€ä¸ªå¸¸é©»çº¿ç¨‹ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±çœ‹çœ‹å¸¸é©»çº¿ç¨‹è¿™ä¸ªé—®é¢˜æ˜¯å¦‚ä½•å¼•èµ·çš„ï¼Œä»¥åŠæ˜¯å¦æœ‰å¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚

åœ¨AFNetworking 2.0 åˆ›å»ºå¸¸é©»çº¿ç¨‹çš„ä»£ç ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªçº¿ç¨‹æ˜¯æ€ä¹ˆåˆ›å»ºçš„ï¼š

```
+ (void)networkRequestThreadEntryPoint:(id)__unused object {
    @autoreleasepool {
        // å…ˆç”¨ NSThread åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹
        [[NSThread currentThread] setName:@"AFNetworking"];
        // ä½¿ç”¨ run æ–¹æ³•æ·»åŠ  runloop
        NSRunLoop *runLoop = [NSRunLoop currentRunLoop];
        [runLoop addPort:[NSMachPort port] forMode:NSDefaultRunLoopMode];
        [runLoop run];
    }
}
```

AFNetworking 2.0 å…ˆç”¨ NSThread åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä½¿ç”¨ NSRunLoop çš„ run æ–¹æ³•ç»™è¿™ä¸ªæ–°çº¿ç¨‹æ·»åŠ äº†ä¸€ä¸ª runloopã€‚


<br/>


é€šè¿‡ NSRunLoop æ·»åŠ  runloop çš„æ–¹æ³•æœ‰ä¸‰ä¸ªï¼š
- run æ–¹æ³•ã€‚é€šè¿‡ run æ–¹æ³•æ·»åŠ çš„ runloop ï¼Œä¼šä¸æ–­åœ°é‡å¤è°ƒç”¨ runMode:beforeDate: æ–¹æ³•ï¼Œæ¥ä¿è¯è‡ªå·±ä¸ä¼šåœæ­¢ã€‚
- runUntilDate: å’Œ runMode:beforeDate æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•æ·»åŠ çš„ runloopï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šæ—¶é—´æ¥åœæ­¢ runloopã€‚

ä½†æ˜¯è‹¥æ˜¯è¿‡å¤šçš„åˆ›å»ºå¸¸é©»çº¿ç¨‹ï¼Œä¸ä½†ä¸èƒ½æé«˜ CPU çš„åˆ©ç”¨ç‡ï¼Œåè€Œä¼šé™ä½ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚å¸¸é©»çº¿ç¨‹æ˜¯å¾ˆè€—è´¹èµ„æºçš„ã€‚



<br/>

&emsp; æ—¢ç„¶å¸¸çº¿ç¨‹æ˜¯ä¸ªå‘ï¼Œé‚£ä¸ºä»€ä¹ˆ **AFNetworking 2.0 åº“è¿˜è¦è¿™ä¹ˆåšå‘¢ï¼Ÿ**

&emsp; å…¶å®ï¼Œè¿™ä¸ªé—®é¢˜çš„æ ¹æºåœ¨äº AFNetworking 2.0 ä½¿ç”¨çš„æ˜¯ NSURLConnectionï¼Œè€Œ NSURLConnection çš„è®¾è®¡ä¸Šå­˜åœ¨äº›ç¼ºé™·ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å’Œä½ è¯´è¯´å®ƒçš„è®¾è®¡ä¸Šæœ‰å“ªäº›ç¼ºé™·ï¼Œäº†è§£äº†è¿™äº›ç¼ºé™·åä½ ä¹Ÿå°±èƒ½å¤Ÿç†è§£å½“æ—¶ AFNetworking 2.0 ä¸ºä»€ä¹ˆæ˜çŸ¥å¸¸é©»çº¿ç¨‹æœ‰å‘ï¼Œè¿˜æ˜¯ä½¿ç”¨äº†å¸¸é©»çº¿ç¨‹ã€‚è¿™æ ·ï¼Œä½ ä»¥åå†ç¢°åˆ°ç±»ä¼¼çš„æƒ…å†µæ—¶ï¼Œä¹Ÿå¯ä»¥è·Ÿ AFNetworking 2.0 ä¸€æ ·ä½¿ç”¨å¸¸çº¿ç¨‹å»è§£å†³é—®é¢˜ï¼Œåªè¦ä¸æ»¥ç”¨å¸¸é©»çº¿ç¨‹å°±å¯ä»¥äº†ã€‚

&emsp; NSURLConnection å‘èµ·è¯·æ±‚åï¼Œæ‰€åœ¨çš„çº¿ç¨‹éœ€è¦ä¸€ç›´å­˜æ´»ï¼Œä»¥ç­‰å¾…æ¥æ”¶ NSURLConnectionDelegate å›è°ƒæ–¹æ³•ã€‚ä½†æ˜¯ï¼Œç½‘ç»œè¿”å›çš„æ—¶é—´ä¸ç¡®å®šï¼Œæ‰€ä»¥è¿™ä¸ªçº¿ç¨‹å°±éœ€è¦ä¸€ç›´å¸¸é©»åœ¨å†…å­˜ä¸­ã€‚æ—¢ç„¶è¿™æ ·ï¼ŒAFNetworking 2.0 ä¸ºä»€ä¹ˆæ²¡æœ‰åœ¨ä¸»çº¿ç¨‹ä¸Šå®Œæˆè¿™ä¸ªå·¥ä½œï¼Œè€Œä¸€å®šè¦æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥åšå‘¢ï¼Ÿ


&emsp; è¿™æ˜¯å› ä¸ºä¸»çº¿ç¨‹è¿˜è¦å¤„ç†å¤§é‡çš„ UI å’Œäº¤äº’å·¥ä½œï¼Œä¸ºäº†å‡å°‘å¯¹ä¸»çº¿ç¨‹çš„å½±å“ï¼Œæ‰€ä»¥ AFNetworking 2.0 å°±æ–°å»ºäº†ä¸€ä¸ªå¸¸é©»çº¿ç¨‹ï¼Œç”¨æ¥å¤„ç†æ‰€æœ‰çš„è¯·æ±‚å’Œå›è°ƒã€‚AFNetworking 2.0 çš„çº¿ç¨‹è®¾è®¡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ios_oc1_21.webp](./../../Pictures/ios_oc1_21.webp)

&emsp; é€šè¿‡ä¸Šé¢çš„åˆ†ææˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¦‚æœä¸æ˜¯å› ä¸º NSURLConnection çš„è¯·æ±‚å¿…é¡»è¦æœ‰ä¸€ä¸ªä¸€ç›´å­˜æ´»çš„çº¿ç¨‹æ¥æ¥æ”¶å›è°ƒï¼Œé‚£ä¹ˆ AFNetworking 2.0 å°±ä¸ç”¨åˆ›å»ºä¸€ä¸ªå¸¸é©»çº¿ç¨‹å‡ºæ¥äº†ã€‚è™½ç„¶è¯´ï¼Œåœ¨ä¸€ä¸ª App é‡Œç½‘ç»œè¯·æ±‚è¿™ä¸ªåŠ¨ä½œçš„å æ¯”å¾ˆé«˜ï¼Œä½†ä¹Ÿæœ‰å¾ˆå¤šä¸éœ€è¦ç½‘ç»œçš„åœºæ™¯ï¼Œæ‰€ä»¥çº¿ç¨‹ä¸€ç›´å¸¸é©»åœ¨å†…å­˜ä¸­ï¼Œä¹Ÿæ˜¯ä¸åˆç†çš„ã€‚


<br/>
<br/>


&emsp; AFNetworking åœ¨ 3.0 ç‰ˆæœ¬æ—¶ï¼Œä½¿ç”¨è‹¹æœå…¬å¸æ–°æ¨å‡ºçš„ NSURLSession æ›¿æ¢äº† NSURLConnectionï¼Œä»è€Œé¿å…äº†å¸¸é©»çº¿ç¨‹è¿™ä¸ªå‘ã€‚NSURLSession å¯ä»¥æŒ‡å®šå›è°ƒ NSOperationQueueï¼Œè¿™æ ·è¯·æ±‚å°±ä¸éœ€è¦è®©çº¿ç¨‹ä¸€ç›´å¸¸é©»åœ¨å†…å­˜é‡Œå»ç­‰å¾…å›è°ƒäº†ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

```
self.operationQueue = [[NSOperationQueue alloc] init];
self.operationQueue.maxConcurrentOperationCount = 1;
self.session = [NSURLSession sessionWithConfiguration:self.sessionConfiguration delegate:self delegateQueue:self.operationQueue];
```

&emsp; ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒNSURLSession å‘èµ·çš„è¯·æ±‚ï¼Œå¯ä»¥æŒ‡å®šå›è°ƒçš„ delegateQueueï¼Œä¸å†éœ€è¦åœ¨å½“å‰çº¿ç¨‹è¿›è¡Œä»£ç†æ–¹æ³•çš„å›è°ƒã€‚æ‰€ä»¥è¯´ï¼ŒNSURLSession è§£å†³äº† NSURLConnection çš„çº¿ç¨‹å›è°ƒé—®é¢˜ã€‚


<br/>

&emsp; å¦‚æœä½ éœ€è¦ç¡®å®éœ€è¦ä¿æ´»çº¿ç¨‹ä¸€æ®µæ—¶é—´çš„è¯ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ NSRunLoop çš„å¦å¤–ä¸¤ä¸ªæ–¹æ³• runUntilDate: å’Œ runMode:beforeDateï¼Œæ¥æŒ‡å®šçº¿ç¨‹çš„ä¿æ´»æ—¶é•¿ã€‚è®©çº¿ç¨‹å­˜æ´»æ—¶é—´å¯é¢„æœŸï¼Œæ€»æ¯”è®©çº¿ç¨‹å¸¸é©»ï¼Œè‡³å°‘åœ¨ç¡¬ä»¶èµ„æºåˆ©ç”¨ç‡è¿™ç‚¹ä¸Šè¦æ›´åŠ åˆç†ã€‚


æˆ–è€…ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ CFRunLoopRef çš„ CFRunLoopRun å’Œ CFRunLoopStop æ–¹æ³•æ¥å®Œæˆ runloop çš„å¼€å¯å’Œåœæ­¢ï¼Œè¾¾åˆ°å°†çº¿ç¨‹ä¿æ´»ä¸€æ®µæ—¶é—´çš„ç›®çš„ã€‚








<br/>
<br/>

> <h2 id='ä¾èµ–'>ä¾èµ–</h2>


- **æ“ä½œä¾èµ–:**
	- `- (void) addDependency:(NSOperation *)op`  :æ·»åŠ ä¾èµ–ï¼Œä½¿å½“å‰æ“ä½œä¾èµ–äºæ“ä½œ op çš„å®Œæˆ;
	
	- `- (void) removeDependency:(NSOperation *)op`  :ç§»é™¤ä¾èµ–ï¼Œå–æ¶ˆå½“å‰æ“ä½œå¯¹æ“ä½œ op çš„ä¾èµ–;
	
	- `@property(readonly, copy) NSArray<NSOperation *> *dependencies;` :  åœ¨å½“å‰æ“ä½œå¼€å§‹æ‰§è¡Œä¹‹å‰å®Œæˆæ‰§è¡Œçš„æ‰€æœ‰æ“ä½œå¯¹è±¡æ•°ç»„.


```
{
    // åˆ›å»ºé˜Ÿåˆ—
    NSOperationQueue *queue = [[NSOperationQueue alloc] init];
 
    // ä»»åŠ¡1
    NSBlockOperation *op1 = [NSBlockOperation blockOperationWithBlock:^{
        [NSData dataWithContentsOfURL:[NSURL URLWithString:@"https://img-blog.csdn.net/20180421152137506"]];
        NSLog(@"ä»»åŠ¡1 å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
    }];
 
    // ä»»åŠ¡2
    NSBlockOperation *op2 = [NSBlockOperation blockOperationWithBlock:^{
        [NSData dataWithContentsOfURL:[NSURL URLWithString:@"https://img-blog.csdn.net/20170112145924755?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGVyb193cWI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center"]];
        NSLog(@"ä»»åŠ¡2 å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
    }];
 
    // æ·»åŠ æ“ä½œä¾èµ–ï¼Œæ³¨æ„ä¸èƒ½å¾ªç¯ä¾èµ–
    [op1 addDependency:op2];
 
    op1.completionBlock = ^{
        NSLog(@"å…¨éƒ¨å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
    };
 
    // æ·»åŠ æ“ä½œåˆ°é˜Ÿåˆ—
    [queue addOperation:op1];
    [queue addOperation:op2];
}


```

è¾“å‡ºç»“æœï¼š

```
AsyTaskTest[6009:309365] ä»»åŠ¡2 å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x600000277c80>{number = 3, name = (null)}

AsyTaskTest[6009:309362] ä»»åŠ¡1 å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x60400046c0c0>{number = 4, name = (null)}

AsyTaskTest[6009:309364] å…¨éƒ¨å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x600000277d40>{number = 5, name = (null)}


```




<br/>
<br/>



><h2 id='å¤šä»»åŠ¡(ä»»åŠ¡æ˜¯å¼‚æ­¥)'>å¤šä»»åŠ¡(ä»»åŠ¡æ˜¯å¼‚æ­¥)</h2>


è‹¥æ˜¯ç›´æ¥ä½¿ç”¨ä¸Šè¿°çš„çº¿ç¨‹ç»„æ¥æ‰§è¡Œï¼Œå¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œå¦‚ä¸‹é—®é¢˜çš„æ¨¡æ‹Ÿï¼š

```
{
    NSURLSession *session = [NSURLSession sharedSession];
 
    // åˆ›å»ºé˜Ÿåˆ—ç»„
    dispatch_group_t group =  dispatch_group_create();
    // åˆ›å»ºå¹¶å‘é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
 
    // ä»»åŠ¡1
    dispatch_group_async(group, queue, ^{
        NSURLSessionDataTask *task1 = [session dataTaskWithURL:[NSURL URLWithString:@"https://www.apple.com/105/media/us/imac-pro/2018/d0b63f9b_f0de_4dea_a993_62b4cb35ca96/hero/large.mp4"] completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
            NSLog(@"ä»»åŠ¡1 å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
        }];
        [task1 resume];
    });
 
    // ä»»åŠ¡2
    dispatch_group_async(group, queue, ^{
        NSURLSessionDataTask *task2 = [session dataTaskWithURL:[NSURL URLWithString:@"https://www.apple.com/105/media/us/imac-pro/2018/d0b63f9b_f0de_4dea_a993_62b4cb35ca96/thumbnails/erin-sarofsky/large.mp4"] completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
            NSLog(@"ä»»åŠ¡2 å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
        }];
        [task2 resume];
    });
 
    // å…¨éƒ¨å®Œæˆ
    dispatch_group_notify(group, queue, ^{
        dispatch_async(dispatch_get_main_queue(), ^{
            NSLog(@"å…¨éƒ¨å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
        });
    });
}
 
! è¾“å‡ºç»“æœï¼š

AsyTaskTest[6048:310326] å…¨éƒ¨å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x60000007f480>{number = 1, name = main}

AsyTaskTest[6048:310361] ä»»åŠ¡2 å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x604000468a80>{number = 3, name = (null)}

AsyTaskTest[6048:310364] ä»»åŠ¡1 å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x60400046a900>{number = 4, name = (null)}

```

- é€šè¿‡dispatch_group_enterã€dispatch_group_leaveè§£å†³å¼‚æ­¥é—®é¢˜ï¼š

```
{
    NSURLSession *session = [NSURLSession sharedSession];
 
    // åˆ›å»ºé˜Ÿåˆ—ç»„
    dispatch_group_t group = dispatch_group_create();
 
    // ä»»åŠ¡1
    dispatch_group_enter(group);
    NSURLSessionDataTask *task1 = [session dataTaskWithURL:[NSURL URLWithString:@"https://www.apple.com/105/media/us/imac-pro/2018/d0b63f9b_f0de_4dea_a993_62b4cb35ca96/hero/large.mp4"] completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
        NSLog(@"ä»»åŠ¡1 å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
        dispatch_group_leave(group);
    }];
    [task1 resume];
 
    // ä»»åŠ¡2
    dispatch_group_enter(group);
    NSURLSessionDataTask *task2 = [session dataTaskWithURL:[NSURL URLWithString:@"https://www.apple.com/105/media/us/imac-pro/2018/d0b63f9b_f0de_4dea_a993_62b4cb35ca96/thumbnails/erin-sarofsky/large.mp4"] completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
        NSLog(@"ä»»åŠ¡2 å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
        dispatch_group_leave(group);
    }];
    [task2 resume];
 
    // å…¨éƒ¨å®Œæˆ
    dispatch_group_notify(group, dispatch_get_main_queue(), ^(){
        NSLog(@"å…¨éƒ¨å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
    });

    /*æˆ–è€…è¿™æ ·åš
    dispatch_group_wait(taskGroup, DISPATCH_TIME_FOREVER);

        dispatch_async(dispatch_get_main_queue(), ^{

Â  Â  Â  Â  //æ‰§è¡ŒmainTask

    });
    */
}

```
 
è¾“å‡ºç»“æœï¼š

```
AsyTaskTest[6102:311543] ä»»åŠ¡2 å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x60400046bd00>{number = 3, name = (null)}

AsyTaskTest[6102:311539] ä»»åŠ¡1 å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x60400046c700>{number = 4, name = (null)}

AsyTaskTest[6102:311509] å…¨éƒ¨å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x60400007cdc0>{number = 1, name = main}

```


- ä½¿ç”¨ä¿¡å·é‡+çº¿ç¨‹ç»„æ¥å¤„ç†

```

{
    // åˆå§‹åŒ–ä¿¡å·é‡
    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
 
    NSURLSession *session = [NSURLSession sharedSession];
 
    // åˆ›å»ºé˜Ÿåˆ—ç»„
    dispatch_group_t group =  dispatch_group_create();
    // åˆ›å»ºå¹¶å‘é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
 
    // ä»»åŠ¡1
    dispatch_group_async(group, queue, ^{
        NSURLSessionDataTask *task1 = [session dataTaskWithURL:[NSURL URLWithString:@"https://www.apple.com/105/media/us/imac-pro/2018/d0b63f9b_f0de_4dea_a993_62b4cb35ca96/hero/large.mp4"] completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
            NSLog(@"ä»»åŠ¡1 å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
            // å‘é€ä¿¡å·ï¼Œä½¿ä¿¡å·é‡+1
            dispatch_semaphore_signal(semaphore);
        }];
        [task1 resume];
    });
    // ä¿¡å·é‡ç­‰äº0æ—¶ä¼šä¸€ç›´ç­‰å¾…ï¼Œå¤§äº0æ—¶æ­£å¸¸æ‰§è¡Œï¼Œå¹¶è®©ä¿¡å·é‡-1
    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);
 
    // ä»»åŠ¡2
    dispatch_group_async(group, queue, ^{
        NSURLSessionDataTask *task2 = [session dataTaskWithURL:[NSURL URLWithString:@"https://www.apple.com/105/media/us/imac-pro/2018/d0b63f9b_f0de_4dea_a993_62b4cb35ca96/thumbnails/erin-sarofsky/large.mp4"] completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
            NSLog(@"ä»»åŠ¡2 å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
            dispatch_semaphore_signal(semaphore);
        }];
        [task2 resume];
    });
    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);
 
    // å…¨éƒ¨å®Œæˆ
    dispatch_async(dispatch_get_main_queue(), ^{
        NSLog(@"å…¨éƒ¨å®Œæˆï¼Œçº¿ç¨‹ï¼š%@", [NSThread currentThread]);
    });
}

```
 
è¾“å‡ºç»“æœï¼š

```
AsyTaskTest[6149:312567] ä»»åŠ¡1 å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x600000468040>{number = 3, name = (null)}

AsyTaskTest[6149:312567] ä»»åŠ¡2 å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x600000468040>{number = 3, name = (null)}

AsyTaskTest[6149:312507] å…¨éƒ¨å®Œæˆï¼Œçº¿ç¨‹ï¼š<NSThread: 0x60000007d680>{number = 1, name = main}
 
```



<br/>
<br/>

***
<br/>


> <h2 id='å†…å­˜é—®é¢˜'>å†…å­˜é—®é¢˜</h2>


&emsp; åˆ›å»ºçº¿ç¨‹çš„è¿‡ç¨‹ï¼Œéœ€è¦ç”¨åˆ°ç‰©ç†å†…å­˜ï¼ŒCPU ä¹Ÿä¼šæ¶ˆè€—æ—¶é—´ã€‚è€Œä¸”ï¼Œæ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œç³»ç»Ÿè¿˜éœ€è¦ä¸ºè¿™ä¸ªè¿›ç¨‹ç©ºé—´åˆ†é…ä¸€å®šçš„å†…å­˜ä½œä¸ºçº¿ç¨‹å †æ ˆã€‚å †æ ˆå¤§å°æ˜¯ 4KB çš„å€æ•°ã€‚åœ¨ iOS å¼€å‘ä¸­ï¼Œä¸»çº¿ç¨‹å †æ ˆå¤§å°æ˜¯ 1MBï¼Œæ–°åˆ›å»ºçš„å­çº¿ç¨‹å †æ ˆå¤§å°æ˜¯ 512KBã€‚

&emsp; é™¤äº†å†…å­˜å¼€é”€å¤–ï¼Œçº¿ç¨‹åˆ›å»ºå¾—å¤šäº†ï¼ŒCPU åœ¨åˆ‡æ¢çº¿ç¨‹ä¸Šä¸‹æ–‡æ—¶ï¼Œè¿˜ä¼šæ›´æ–°å¯„å­˜å™¨ï¼Œæ›´æ–°å¯„å­˜å™¨çš„æ—¶å€™éœ€è¦å¯»å€ï¼Œè€Œå¯»å€çš„è¿‡ç¨‹è¿˜ä¼šæœ‰è¾ƒå¤§çš„ CPU æ¶ˆè€—ã€‚

&emsp; æ‰€ä»¥ï¼Œçº¿ç¨‹è¿‡å¤šæ—¶å†…å­˜å’Œ CPU éƒ½ä¼šæœ‰å¤§é‡çš„æ¶ˆè€—ï¼Œä»è€Œå¯¼è‡´ App æ•´ä½“æ€§èƒ½é™ä½ï¼Œä½¿å¾—ç”¨æˆ·ä½“éªŒå˜æˆå·®ã€‚CPU å’Œå†…å­˜çš„ä½¿ç”¨è¶…å‡ºç³»ç»Ÿé™åˆ¶æ—¶ï¼Œç”šè‡³ä¼šé€ æˆç³»ç»Ÿå¼ºæ€ã€‚è¿™ç§æƒ…å†µå¯¹ç”¨æˆ·å’Œ App çš„ä¼¤å®³å°±æ›´å¤§äº†ã€‚























