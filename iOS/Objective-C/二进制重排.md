>
- [**Appå¯åŠ¨å’ŒåŠ è½½**](#Appå¯åŠ¨å’ŒåŠ è½½)
	- [page faultå¦‚ä½•ä¼˜åŒ–](#pagefaultå¦‚ä½•ä¼˜åŒ–)
	- [Link Mapé“¾æ¥é¡ºåº](#LinkMapé“¾æ¥é¡ºåº)
		- [é…ç½®](#é…ç½®)
			- [Write Link Map File](#WriteLinkMapFile)
			- [Order File](#OrderFile)
- [**SanitizerCoverageé‡‡é›†è°ƒç”¨å‡½æ•°ä¿¡æ¯**](#SanitizerCoverageé‡‡é›†è°ƒç”¨å‡½æ•°ä¿¡æ¯)
	- [æ¡ˆä¾‹ä»£ç 1](#æ¡ˆä¾‹ä»£ç 1)
	- [__sanitizer_cov_trace_pc_guard_initè§£æ](#__sanitizer_cov_trace_pc_guard_initè§£æ)




<br/>

***
<br/><br/>


> <h1 id='Appå¯åŠ¨å’ŒåŠ è½½'>Appå¯åŠ¨å’ŒåŠ è½½</h1>

&emsp; Linuxç³»ç»Ÿä¸‹ï¼Œè¿›ç¨‹ç”³è¯·è¿è¡Œçš„å†…å­˜å¹¶ä¸æ˜¯ç‰©ç†å†…å­˜.è€Œæ˜¯åªæ ‡è®°å½“å‰è¿›ç¨‹æ‹¥æœ‰è¯¥æ®µå†…å­˜ï¼Œå½“çœŸæ­£ä½¿ç”¨è¿™æ®µæ®µå†…å­˜æ—¶æ‰ä¼šåˆ†é…ï¼Œæ­¤æ—¶çš„å†…å­˜æ˜¯è™šæ‹Ÿå†…å­˜ã€‚

<br/>

&emsp; åœ¨**è™šæ‹Ÿå†…å­˜**å‡ºç°å‰ï¼Œç¨‹åºæŒ‡ä»¤å¿…é¡»éƒ½åœ¨ç‰©ç†å†…å­˜å†…ï¼Œä½¿å¾—ç‰©ç†å†…å­˜èƒ½å­˜æ”¾çš„è¿›ç¨‹ååˆ†æœ‰é™ï¼Œå¹¶ä¸”ç”±äºæ˜¯ç›¸é‚»å­˜å‚¨ï¼Œå®¹æ˜“å‘ç”Ÿè¶Šç•Œè®¿é—®ç­‰æƒ…å†µã€‚

&emsp; è™šæ‹Ÿå†…å­˜æ˜¯ä½œä¸º**å†…å­˜çš„ç®¡ç†å’Œä¿æŠ¤å·¥å…·**è¯ç”Ÿçš„ï¼Œä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ä¸€ç‰‡è¿ç»­å®Œæ•´çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œä½¿ç”¨æ—¶å…ˆé€šè¿‡**ç•Œé™å¯„å­˜å™¨**åˆ¤æ–­è®¿é—®æ˜¯å¦è¶Šç•Œï¼Œå†é€šè¿‡åŸºå€å¯„å­˜å™¨è½¬æ¢ä¸ºå®é™…å†…å­˜åœ°å€ã€‚

&emsp; é™ä½äº†å†…å­˜ç®¡ç†çš„å¤æ‚åº¦ï¼Œä¿æŠ¤æ¯ä¸ªè¿›ç¨‹çš„å†…å­˜åœ°å€ç©ºé—´ä¸ä¼šè¢«å…¶å®ƒè¿›ç¨‹ç ´åï¼Œå¹¶ä¸”å®ç°äº† å…±äº«ç¼“å­˜åŠŸèƒ½.è®¿é—®æ—¶å…ˆåˆ¤æ–­æ˜¯å¦å·²ç¼“å­˜åˆ°ä¸»å­˜ä¸­,ç„¶åæ‰é€šè¿‡ CPU å¯»å€ï¼ˆè™šæ‹Ÿåœ°å€ï¼‰è®¿é—®ä¸»å­˜æˆ–ç¡¬ç›˜ã€‚


<br/>

&emsp; å½“æˆ‘ä»¬éœ€è¦è®¿é—®ä¸€ä¸ªå†…å­˜åœ°å€æ—¶ï¼Œå¦‚æœè™šæ‹Ÿå†…å­˜åœ°å€å¯¹åº”çš„ç‰©ç†å†…å­˜è¿˜æœªåˆ†é…ï¼Œ**CPU ä¼šæ‰§è¡Œ page fault**ï¼Œå°†æŒ‡ä»¤ä»ç£ç›˜åŠ è½½åˆ°ç‰©ç†å†…å­˜ä¸­å¹¶è¿›è¡ŒéªŒç­¾æ“ä½œï¼ˆApp Store å‘å¸ƒæƒ…å†µä¸‹ï¼‰ã€‚

&emsp; åœ¨App å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨å„ç§å‡½æ•°ï¼Œç”±äºè¿™äº›å‡½æ•°åˆ†å¸ƒåœ¨å„ä¸ª TEXT æ®µä¸­ä¸”ä¸è¿ç»­ï¼Œæ­¤æ—¶éœ€è¦æ‰§è¡Œå¤šæ¬¡ page fault åˆ›å»ºåˆ†é¡µï¼Œå°†ä»£ç è¯»å–åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œå¹¶ä¸”è¿™äº›åˆ†é¡µä¸­çš„éƒ¨åˆ†ä»£ç ä¸ä¼šåœ¨å¯åŠ¨é˜¶æ®µè¢«è°ƒç”¨ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå‡è®¾æˆ‘ä»¬åœ¨å¯åŠ¨é˜¶æ®µéœ€è¦è°ƒç”¨ Func Aã€Bã€Cï¼Œåˆ™éœ€æ‰§è¡Œ3æ¬¡ page default(åŒ…æ‹¬é¦–æ¬¡è¯»å–)ï¼Œå¹¶ä½¿ç”¨3ä¸ªåˆ†é¡µã€‚

![ios_oc2_39.png](./../../Pictures/ios_oc2_39.png)


<br/><br/>

> <h2 id='pagefaultå¦‚ä½•ä¼˜åŒ–'>page faultå¦‚ä½•ä¼˜åŒ–</h2>

&emsp; ä¼˜åŒ–çš„æ€è·¯å¾ˆç®€å•ï¼Œå³æŠŠå¯åŠ¨é˜¶æ®µéœ€è¦ç”¨åˆ°çš„å‡½æ•°æŒ‰é¡ºåºé›†ä¸­æ”¾åœ¨ä¸€å—ï¼Œå‡å°‘ page fault æ‰§è¡Œæ¬¡æ•°å’Œåˆ†é¡µæ•°é‡.å¦‚ä¸‹å›¾æ‰€ç¤º:

![ios_oc2_40.png](./../../Pictures/ios_oc2_40.png)



<br/><br/>

> <h2 id='LinkMapé“¾æ¥é¡ºåº'>Link Mapé“¾æ¥é¡ºåº</h2>

Link Map æ˜¯ App ç¼–è¯‘è¿‡ç¨‹çš„ä¸­é—´äº§ç‰©ï¼Œè®°è½½äº†äºŒè¿›åˆ¶æ–‡ä»¶çš„å¸ƒå±€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Link Map æ–‡ä»¶åˆ†æå¯æ‰§è¡Œæ–‡ä»¶çš„æ„æˆæ˜¯æ€æ ·ï¼Œé‡Œé¢çš„å†…å®¹éƒ½æ˜¯äº›ä»€ä¹ˆï¼Œå“ªäº›åº“å ç”¨ç©ºé—´è¾ƒé«˜ç­‰ç­‰.


<br/><br/>

> <h3 id='é…ç½®'>é…ç½®</h3>


> <h4 id='WriteLinkMapFile'>Write Link Map File</h4>


**éœ€è¦æ‰‹åŠ¨åœ¨ Build Settings å°† Write Link Map File è®¾ç½®ä¸º Yesã€‚**

**é»˜è®¤ç”Ÿæˆçš„ Link Map æ–‡ä»¶åœ¨ build ç›®å½•ä¸‹ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ Path To Link Map æŒ‡å®šå­˜æ”¾åœ°å€ã€‚**


![ios_oc2_43.png](./../../Pictures/ios_oc2_43.png)


æ–‡ä»¶è·¯å¾„å¦‚ä¸‹:

![ios_oc2_42.png](./../../Pictures/ios_oc2_42.png)


ä»¥å…¶ä¸­ä¸€ä¸ªé¡¹ç›®ä¸ºä¾‹,å¦‚ä¸‹:


```
// Link Mapå¯¹åº”å®‰è£…åŒ…åœ°å€
# Path: /Users/harleyhuang/Library/Developer/Xcode/DerivedData/MLC-fpuuznzditxxpmazhuzthcbbhziq/Build/Products/Debug-iphonesimulator/MLC.app/MLC

// å¯¹åº”çš„æ¶æ„
# Arch: x86_64

// ç¼–è¯‘åç”Ÿæˆçš„.oæ–‡ä»¶åˆ—è¡¨ï¼ŒåŒ…æ‹¬ç³»ç»Ÿå’Œç”¨æˆ·è‡ªå®šçš„ç±»ï¼ŒUIKitåº“ç­‰ç­‰ã€‚
# Object files:
[  0] linker synthesized
[  1] dtrace
[  2] /Users/harleyhuang/Library/Developer/Xcode/DerivedData/MLC-fpuuznzditxxpmazhuzthcbbhziq/Build/Intermediates.noindex/MLC.build/Debug-iphonesimulator/MLC.build/Objects-normal/x86_64/NSObject+HGTestCategory.o
[  3] /Users/harleyhuang/Library/Developer/Xcode/DerivedData/MLC-fpuuznzditxxpmazhuzthcbbhziq/Build/Intermediates.noindex/MLC.build/Debug-iphonesimulator/MLC.build/Objects-normal/x86_64/HGMenuItem.o
Â·Â·Â·
Â·Â·
Â·

// Sectionæ˜¯å„ç§æ•°æ®ç±»å‹æ‰€åœ¨çš„å†…å­˜ç©ºé—´ï¼ŒSectionä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œ__Textå’Œ__DATAã€‚__TextæŒ‡çš„æ˜¯ç¨‹åºä»£ç ï¼Œ__DATAæŒ‡çš„æ˜¯å·²ç»åˆå§‹åŒ–çš„å˜é‡ç­‰ã€‚
# Sections:
# Address	Size    	Segment	Section
0x1000031F0	0x0079E9BA	__TEXT	__text
0x1007A1BAA	0x00002610	__TEXT	__stubs
0x1007A41BC	0x000034C2	__TEXT	__stub_helper
0x1007A767E	0x000024BC	__TEXT	__ustring
0x1007A9B40	0x00035C0E	__TEXT	__cstring
0x1007DF74E	0x0002A4AE	__TEXT	__objc_methname
0x100809BFC	0x000032D8	__TEXT	__objc_classname
0x10080CED4	0x00007398	__TEXT	__objc_methtype
0x100814270	0x000244A3	__TEXT	__const
0x100838714	0x0000E958	__TEXT	__gcc_except_tab
Â·Â·Â·
Â·Â·
Â·


//å˜é‡åã€ç±»åã€æ–¹æ³•åç­‰ç¬¦å·è¡¨
# Symbols:
# Address	Size    	File  Name
0x1000031F0	0x000000E0	[  2] -[NSObject(HGTestCategory) setTestGetOrSet:]
0x1000032D0	0x00000029	[  2] -[NSObject(HGTestCategory) testGetOrSet]
0x100003300	0x00000050	[  3] -[HGMenuItem speedFactor]
0x100003350	0x000000D0	[  3] -[HGMenuItem setNormalColor:]
0x100003420	0x000000D0	[  3] -[HGMenuItem setSelecetedColor:]
0x1000034F0	0x000002B0	[  3] -[HGMenuItem setRate:]
0x1000037A0	0x000001B0	[  3] -[HGMenuItem initWithFrame:]
0x100003950	0x00000080	[  3] -[HGMenuItem setupGestureRecognizer]
0x1000039D0	0x000000D0	[  3] -[HGMenuItem touchUpInside:]
0x100003AA0	0x000002A0	[  3] -[HGMenuItem setSelected:withAnimation:]
0x100003D40	0x000001E0	[  3] -[HGMenuItem rateChange]
0x100003F20	0x00000040	[  3] -[HGMenuItem delegate]
Â·Â·Â·Â·
Â·Â·Â·
Â·Â·
Â·


# Dead Stripped Symbols:
#        	Size    	File  Name
<<dead>> 	0x00000018	[  2] CIE
<<dead>> 	0x00000008	[  3] 8-byte-literal
<<dead>> 	0x00000008	[  3] 8-byte-literal
<<dead>> 	0x0000000B	[  3] literal string: v24@0:8@16
<<dead>> 	0x00000008	[  3] literal string: @16@0:8
<<dead>> 	0x00000009	[  3] literal string: delegate
Â·Â·Â·
Â·Â·
Â·

```

å¯ä»¥çœ‹åˆ°æ­¤æ—¶ Symbols çš„ç¬¦å·è¡¨å¹¶ä¸æ˜¯æŒ‰ç…§å¯åŠ¨æ—¶æ‰§è¡Œçš„å‡½æ•°é¡ºåºåŠ è½½çš„ï¼Œè€Œæ˜¯æŒ‰ç…§åº“çš„ç¼–è¯‘é¡ºåºå…¨éƒ¨è½½å…¥ã€‚




<br/><br/>

> <h4 id='OrderFile'>Order File</h4>


Xcode çš„é“¾æ¥å™¨æä¾›äº†ä¸€ä¸ª Order File é…ç½®ï¼Œå¯¹åº”çš„æ–‡ä»¶ä¸­ç¬¦å·ä¼šæŒ‰ç…§é¡ºåºå†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†è°ƒç”¨åˆ°çš„å‡½æ•°å†™åˆ°è¯¥æ–‡ä»¶ï¼Œå®ç°ä¼˜åŒ–

![ios_oc2_41.png](./../../Pictures/ios_oc2_41.png)



<br/><br/>

> <h2 id='SanitizerCoverageé‡‡é›†è°ƒç”¨å‡½æ•°ä¿¡æ¯'>SanitizerCoverageé‡‡é›†è°ƒç”¨å‡½æ•°ä¿¡æ¯</h2>

&emsp; é€šè¿‡ SanitizerCoverage é‡‡é›†è°ƒç”¨å‡½æ•°ä¿¡æ¯ï¼Œ SanitizerCoverage å†…ç½®åœ¨LLVMä¸­ï¼Œå¯ä»¥åœ¨å‡½æ•°ã€åŸºæœ¬å—å’Œè¾¹ç•Œè¿™äº›çº§åˆ«ä¸Šæ’å…¥å¯¹ç”¨æˆ·å®šä¹‰å‡½æ•°çš„å›è°ƒï¼Œå±äºé™æ€æ’æ¡©ï¼Œä»£ç ä¼šåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­æ’å…¥åˆ°æ¯ä¸ªå‡½æ•°ä¸­ï¼Œè¯¦ç»†ä»‹ç»å¯ä»¥åœ¨ [Clang 11 documentation(Clangå®˜æ–¹æ–‡æ¡£) ](https://clang.llvm.org/docs/index.html)æ‰¾åˆ°: [SanitizerCoverage](https://clang.llvm.org/docs/SanitizerCoverage.html)=>[Tracing PCs with guards](https://clang.llvm.org/docs/SanitizerCoverage.html#tracing-pcs-with-guards)ã€‚


<br/>


åœ¨ build settings é‡Œçš„ `Other C Flags` ä¸­æ·»åŠ  

```
-fsanitize-coverage=func,trace-pc-guard
```

å¦‚æœå«æœ‰ Swift ä»£ç çš„è¯ï¼Œè¿˜éœ€è¦åœ¨ â€œOther Swift Flagsâ€ ä¸­åŠ å…¥ 

```
-sanitize-coverage=func å’Œ -sanitize=undefined
```

éœ€æ³¨æ„ï¼Œæ‰€æœ‰é“¾æ¥åˆ° App ä¸­çš„äºŒè¿›åˆ¶éƒ½éœ€è¦å¼€å¯ SanitizerCoverage(å¦‚ä¸Šè¿°çš„é…ç½®)ï¼Œè¿™æ ·æ‰èƒ½å®Œå…¨è¦†ç›–åˆ°æ‰€æœ‰è°ƒç”¨ã€‚


<br/>

å¼€å¯åï¼Œå‡½æ•°çš„è°ƒç”¨ éƒ½ä¼šæ‰§è¡Œ 

```
void __sanitizer_cov_trace_pc_guard(uint32_t *guard) {
	// +loadæ–¹æ³•å…ˆäºguard_initè°ƒç”¨ï¼Œæ­¤æ—¶guardä¸º0
	// if(!*guard) { return }

    if (stopCollecting) {
        return;
    }

    // __builtin_return_address è·å–å½“å‰è°ƒç”¨æ ˆçš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€
    void *PC = __builtin_return_address(0);
    PointerNode *node = malloc(sizeof(PointerNode));
    *node = (PointerNode){PC, NULL};
    // ä½¿ç”¨åŸå­é˜Ÿåˆ—è¦å­˜å‚¨å¸§åœ°å€
    OSAtomicEnqueue(&qHead, node, offsetof(PointerNode, next));
} 
```

å›è°ƒï¼Œæ•ˆæœç±»ä¼¼æˆ‘ä»¬å¯¹ objc_msgSend è¿›è¡Œ Hookæ’æ¡©ï¼Œä½†è¯¥å›è°ƒä¸æ­¢å±€é™äº OC å‡½æ•°ï¼Œè¿˜åŒ…æ‹¬ Swiftã€blockã€Cç­‰ã€‚

<br/>

![ios_oc2_44.png](./../../Pictures/ios_oc2_44.png)

é€šè¿‡æ±‡ç¼–å¯å‘ç°ï¼Œæ¯ä¸ªå‡½æ•°è°ƒç”¨å‰éƒ½è¢«æ’å…¥äº†`__sanitizer_cov_trace_pc_guard`ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¯¥å‡½æ•°ä¸­ï¼Œåˆ©ç”¨ `__builtin_return_address` è·å–è¿è¡Œæ ˆçš„æƒ…å†µï¼Œä¿å­˜ç¬¬ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼Œå³å‡½æ•°åœ°å€ã€‚


<br/>

<br/><br/>

> <h3 id='æ¡ˆä¾‹ä»£ç 1'>æ¡ˆä¾‹ä»£ç 1</h3>


æˆ‘ä»¬åœ¨è¯¥å›è°ƒä¸­æ’å…¥è‡ªå·±çš„ç»Ÿè®¡ä»£ç ï¼Œæ”¶é›†å‡½æ•°åï¼Œå¯åŠ¨å®Œæˆåå†å°†æ•°æ®å¯¼å‡º,å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```
//
//  HGBinaryRearrangement.m
//  MLC
//
//  Created by Harley Huang on 29/4/2023.
//  Copyright Â© 2023 HuangGang'sMac. All rights reserved.
//

#import "HGBinaryRearrangement.h"

#import <dlfcn.h>
#include <stdint.h>
#include <stdio.h>
#include <sanitizer/coverage_interface.h>
#import <libkern/OSAtomicQueue.h>
#import <pthread.h>



static OSQueueHead qHead = OS_ATOMIC_QUEUE_INIT;
static BOOL stopCollecting = NO;

// é€šè¿‡é“¾è¡¨çš„å½¢å¼å­˜æ”¾æ–¹æ³•åœ°å€
typedef struct {
    void *pointer;
    void *next;
} PointerNode;

// dyldé“¾æ¥dylibæ—¶è°ƒç”¨ï¼Œstartå’Œstopåœ°å€ä¹‹é—´çš„ä¿å­˜è¯¥dylibçš„æ‰€æœ‰ç¬¦å·çš„ä¸ªæ•°
// å¯ä»¥ä¸å®ç°å…·ä½“å†…å®¹ï¼Œä¸å½±å“åç»­è°ƒç”¨
void __sanitizer_cov_trace_pc_guard_init(uint32_t *start,uint32_t *stop) {
    static uint32_t N;  // Counter for the guards.
    if (start == stop || *start) return;  // Initialize only once.
    printf("INIT: %p %p\n", start, stop);
    for (uint32_t *x = start; x < stop; x++)
        *x = ++N;  // Guards should start from 1.
    
    printf("totasl count %i\n", N);
}

/* é€šè¿‡æ±‡ç¼–å¯å‘ç°ï¼Œæ¯ä¸ªå‡½æ•°è°ƒç”¨å‰éƒ½è¢«æ’å…¥äº†
 bl     0x102b188c0               ; symbol stub for: __sanitizer_cov_trace_pc_guard
 æ‰€ä»¥åœ¨æ¯ä¸ªå‡½æ•°è°ƒç”¨æ—¶éƒ½ä¼šå…ˆè·³è½¬æ‰§è¡Œè¯¥å‡½æ•°
*/
void __sanitizer_cov_trace_pc_guard(uint32_t *guard) {
    // +loadæ–¹æ³•å…ˆäºguard_initè°ƒç”¨ï¼Œæ­¤æ—¶guardä¸º0
    //if(!*guard) { return }

    if (stopCollecting) {
        return;
    }

    // __builtin_return_address è·å–å½“å‰è°ƒç”¨æ ˆä¿¡æ¯ï¼Œå–ç¬¬ä¸€å¸§åœ°å€ï¼ˆå³ä¸‹æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ï¼Œè¢«æ’æ¡©çš„å‡½æ•°åœ°å€ï¼‰
    void *PC = __builtin_return_address(0);
    PointerNode *node = malloc(sizeof(PointerNode));
    *node = (PointerNode){PC, NULL};
    // ä½¿ç”¨åŸå­é˜Ÿåˆ—è¦å­˜å‚¨å¸§åœ°å€
    OSAtomicEnqueue(&qHead, node, offsetof(PointerNode, next));
}




/**
 * ç”±äºå­˜åœ¨å¤šçº¿ç¨‹è°ƒç”¨çš„é—®é¢˜ï¼Œæ­¤æ—¶éœ€è¦ç”¨é”æ¥ä¿è¯ç¬¦å·å­˜å‚¨
 *è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨åŸå­é˜Ÿåˆ—ï¼Œæ‰§è¡Œæ•ˆç‡é«˜ä¸”é˜Ÿåˆ—å­˜å‚¨æ•°æ®ï¼Œä¸éœ€è¦å†é¢å¤–åŠ é”å¤„ç†å’Œåˆ›å»ºæ•°ç»„ã€‚
 */
extern NSArray <NSString *> *getAllFunctions(NSString *currentFuncName) {
    NSMutableSet<NSString *> *unqSet = [NSMutableSet setWithObject:currentFuncName];
    NSMutableArray <NSString *> *functions = [NSMutableArray array];
    while (YES) {
        PointerNode *front = OSAtomicDequeue(&qHead, offsetof(PointerNode, next));
        if(front == NULL) {
            break;
        }
        Dl_info info = {0};
        // dladdrè·å–åœ°å€ç¬¦å·ä¿¡æ¯
        dladdr(front->pointer, &info);
        NSString *name = @(info.dli_sname);
        // å»é™¤é‡å¤è°ƒç”¨
        if([unqSet containsObject:name]) {
            continue;
        }
        BOOL isObjc = [name hasPrefix:@"+["] || [name hasPrefix:@"-["];
        // orderæ–‡ä»¶æ ¼å¼è¦æ±‚Cå‡½æ•°å’Œblockå‰éœ€è¦æ·»åŠ _
        NSString *symbolName = isObjc ? name : [@"_" stringByAppendingString:name];
        [unqSet addObject:name];
        [functions addObject:symbolName];
    }
    // å–åå¾—åˆ°æ­£ç¡®è°ƒç”¨æ’åº
    return [[functions reverseObjectEnumerator] allObjects];;

}

#pragma mark - public
extern NSArray <NSString *> *getAppCalls(void) {
    
    stopCollecting = YES;
    // å†…å­˜å±éšœï¼Œé˜²æ­¢cpuçš„ä¹±åºæ‰§è¡Œè°ƒåº¦å†…å­˜ï¼ˆåŸå­é”ï¼‰
    __sync_synchronize();
    NSString* curFuncationName = [NSString stringWithUTF8String:__FUNCTION__];
    return getAllFunctions(curFuncationName);
}

extern void appOrderFile(void(^completion)(NSString* orderFilePath)) {
    
    stopCollecting = YES;
    __sync_synchronize();
   NSString* curFuncationName = [NSString stringWithUTF8String:__FUNCTION__];
    
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.01 * NSEC_PER_SEC)), dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
        NSArray *functions = getAllFunctions(curFuncationName);
        NSString *orderFileContent = [functions.reverseObjectEnumerator.allObjects componentsJoinedByString:@"\n"];
        NSLog(@"[orderFile]: %@",orderFileContent);
        NSString *filePath = [NSTemporaryDirectory() stringByAppendingPathComponent:@"orderFile.order"];
        [orderFileContent writeToFile:filePath
                           atomically:YES
                             encoding:NSUTF8StringEncoding
                                error:nil];
        if(completion){
            completion(filePath);
        }
    });
}
```


ä½†æ˜¯æˆ‘åœ¨AppDelegate.mä¸­è¿›è¡Œè°ƒç”¨äº†**`appOrderFileå’ŒgetAppCalls`**æ–¹æœ‰å¤§é—®é¢˜,æ’æ¡©æ–¹æ³•åªæœ‰å‡ ä¸ª,å®Œå…¨ä¸è¡Œ.è¿™ä¸ªå¯ä»¥åé¢è¿›è¡Œæ”¹è¿›


<br/>

```
/*
 * Structure filled in by dladdr().
 */
typedef struct dl_info {
        const char      *dli_fname;     /* Pathname of shared object */
        void            *dli_fbase;     /* Base address of shared object */
        const char      *dli_sname;     /* Name of nearest symbol */
        void            *dli_saddr;     /* Address of nearest symbol */
} Dl_info;

extern int dladdr(const void *, Dl_info *);

```

å°†æ”¶é›†çš„å‡½æ•°åœ°å€ä»åŸå­é˜Ÿåˆ—ä¸­å–å‡ºï¼Œé€šè¿‡ dladdr  è·å–åœ°å€çš„å¯¹åº”ç¬¦å·ä¿¡æ¯ï¼Œæœ€åå°†æ•°ç»„æ’åºé€†è½¬å³å¯å¾—åˆ°æŒ‰é¡ºåºæ’åºçš„è°ƒç”¨å‡½æ•°æ•°ç»„ã€‚




<br/><br/>


> <h2 id='æ¡ˆä¾‹ä»£ç 2'>æ¡ˆä¾‹ä»£ç 2</h2>

```
#import <dlfcn.h>
#include <stdint.h>
#include <stdio.h>
#include <sanitizer/coverage_interface.h>



int main(int argc, char * argv[]) {
    @autoreleasepool {
        return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));
    }
}


void __sanitizer_cov_trace_pc_guard_init(uint32_t *start,uint32_t *stop) {
    static uint32_t N;  // Counter for the guards.
    if (start == stop || *start) return;  // Initialize only once.
    printf("ğŸ­INIT: %p %p\n", start, stop);
    for (uint32_t *x = start; x < stop; x++)
        *x = ++N;  // Guards should start from 1.
    
    printf("ğŸ¿totasl count %i\n", N);
}

/// é€šè¿‡æ±‡ç¼–å¯å‘ç°ï¼Œæ¯ä¸ªå‡½æ•°è°ƒç”¨å‰éƒ½è¢«æ’å…¥äº†
/// bl     0x102b188c0               ; symbol stub for: __sanitizer_cov_trace_pc_guard
/// æ‰€ä»¥åœ¨æ¯ä¸ªå‡½æ•°è°ƒç”¨æ—¶éƒ½ä¼šå…ˆè·³è½¬æ‰§è¡Œè¯¥å‡½æ•°
void __sanitizer_cov_trace_pc_guard(uint32_t *guard) {
    // +loadæ–¹æ³•å…ˆäºguard_initè°ƒç”¨ï¼Œæ­¤æ—¶guardä¸º0
    //if(!*guard) { return; }

    // __builtin_return_address è·å–å½“å‰è°ƒç”¨æ ˆä¿¡æ¯ï¼Œå–ç¬¬ä¸€å¸§åœ°å€ï¼ˆå³ä¸‹æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ï¼Œè¢«æ’æ¡©çš„å‡½æ•°åœ°å€ï¼‰
    void *PC = __builtin_return_address(0);
    
    Dl_info info;
    dladdr(PC, &info);
    printf("ğŸ’æ’æ¡©æ–¹æ³•:%s\n", info.dli_sname);

}

```


æ§åˆ¶å°æ‰“å°çš„æ–¹æ³•å°±æ˜¯æ’æ¡©åçš„æ–¹æ³•,ä½†æ˜¯é‡Œé¢å¯èƒ½åŒ…å«å¾ˆå¤šé‡å¤çš„ä»£ç ,ä½ å¯ä»¥é€šè¿‡å»[**é‡å¤å­—ç¬¦ä¸²ç½‘ç«™è¿›è¡Œå»é™¤**](https://www.bejson.com/othertools/removeDuplicate/),æ•´ç†åå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„æ–¹æ³•äº†

<br/><br/>

> <h3 id='__sanitizer_cov_trace_pc_guard_initè§£æ'>__sanitizer_cov_trace_pc_guard_initè§£æ</h3>

```
void __sanitizer_cov_trace_pc_guard_init(uint32_t *start,
                                         uint32_t *stop) {
  
    static uint32_t N;  // Counter for the guards.
    if (start == stop || *start) return;  // Initialize only once.
    printf("INIT: %p %p\n", start, stop);
    for (uint32_t *x = start; x < stop; x++)
        *x = ++N;  // Guards should start from 1.
    
    printf("totasl count %i\n", N);
}
```


dyld æ¯é“¾æ¥ä¸€ä¸ªå¼€å¯ SanitizerCoverage é…ç½®çš„ dylib éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡  __sanitizer_cov_trace_pc_guard_init ï¼Œstart å’Œ stop ä¹‹é—´çš„åŒºé—´ä¿å­˜äº†è¯¥ dylib çš„ç¬¦å·ä¸ªæ•°ï¼Œæˆ‘ä»¬é€šè¿‡è®¾ç½®é™æ€å…¨å±€å˜é‡ N å¯ç»Ÿè®¡æ‰€æœ‰ dylib çš„ç¬¦å·ã€‚


å¦‚æœä¸éœ€è¦ä»¥ä¸Šå†…å®¹å¯ä»¥ä»…æ‰§è¡Œç©ºå‡½æ•° void __sanitizer_cov_trace_pc_guard_init(uint32_t *start,                                          uint32_t *stop){}ï¼Œä¸ä¼šå½±å“åé¢çš„è°ƒç”¨ã€‚


<br/>

***
<br/><br/>

> <h1 id='ç»“æœ'>ç»“æœ</h1>


<br/><br/>

> <h2 id='è·å–çœŸæœºæ’åºæ–‡ä»¶'>è·å–çœŸæœºæ’åºæ–‡ä»¶</h2>


- **1).æ–¹æ³•**

çœŸæœºè¿ç€Xcodeå,é€‰æ‹© **Devices And Simulators** ç„¶åä¸‹è½½.xcappdataæ ¼å¼æ–‡ä»¶åˆ°æ¡Œé¢:

![ios_oc2_45.png](./../../Pictures/ios_oc2_45.png)

ç„¶åç‚¹å‡»..xcappdataæ ¼å¼.æ–‡ä»¶é€‰æ‹© **æ˜¾ç¤ºåŒ…å†…å®¹**,ç„¶åæŒ‰ç…§å¦‚ä¸‹æ‰“å¼€.orderæ–‡ä»¶:

![ios_oc2_46.png](./../../Pictures/ios_oc2_46.png)



<br/>


**â€Œ2).æ–¹æ³•**

ä¸Šé¢çš„æ–¹æ³•å¤ªç¹çäº†,åé¢å‘ç°ä¸€ç§æ›´æ–¹ä¾¿çš„åŠæ³•å°±æ˜¯: 
- çœŸæœºæ¥æ¥Xcode

- è¿è¡Œåä¼šäº§ç”Ÿä¸€ä¸ª.appæ–‡ä»¶

- é€‰ä¸­.app,ç„¶åæ˜¾ç¤ºæ‰€åœ¨æ–‡ä»¶è·¯å¾„

![ios_oc2_47.png](./../../Pictures/ios_oc2_47.png)


<br/>


é€šè¿‡ system trace å·¥å…·å¯¹æ¯”ä¸‹ä¼˜åŒ–å‰åçš„å¯åŠ¨é€Ÿåº¦ï¼Œç”±äº Demo å·¥ç¨‹å†…å®¹å°‘ï¼Œæ— æ³•çœ‹å‡ºæ˜æ˜¾åŒºåˆ«ï¼Œå¯ä»¥è·Ÿå…¬å¸é¡¹ç›®ä½œä¸ºå¯¹æ¯”.



<br/>

å¯ä»¥çœ‹åˆ°æ‰§è¡Œ page fault å°‘äº†å°†è¿‘ 1/3ï¼Œé€Ÿåº¦æå‡äº† 1/4ï¼Œè¯´æ˜å¯¹å¯åŠ¨ä¼˜åŒ–ä¸Šè¿˜æ˜¯æœ‰ä¸€å®šæ•ˆæœï¼Œå°¤å…¶æ˜¯åœ¨å¤§é¡¹ç›®ä¸­ã€‚

























