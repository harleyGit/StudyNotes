

- HTTPS认证流程
- [ **数字签名、数字证书与HTTPS关系**](https://www.zhihu.com/question/52493697)


<br/>

***
<br/>


># HTTPS认证流程

![https 认证流程](https://upload-images.jianshu.io/upload_images/2959789-6e492103d356ac3c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


<br/>

![<br/>](./../Pictures/z54.png)

- **1\. 客户端发起HTTPS请求**

　　&emsp; 这个没什么好说的，就是用户在浏览器里输入一个https网址，然后连接到server的443端口。
　　
　　<br/>
　　
- **2\. 服务端的配置**

　　&emsp; 采用HTTPS协议的服务器必须要有一套数字证书，可以自己制作，也可以向组织申请。区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面。这套证书其实就是一对公钥和私钥。如果对公钥和私钥不太理解，可以想象成一把钥匙和一个锁头，只是全世界只有你一个人有这把钥匙，你可以把锁头给别人，别人可以用这个锁把重要的东西锁起来，然后发给你，因为只有你一个人有这把钥匙，所以只有你才能看到被这把锁锁起来的东西。
　　
　　<br/>
　　
- **3\. 传送证书**
　　&emsp; 这个证书其实就是公钥，只是包含了很多信息，如证书的颁发机构，过期时间等等。

证书内容：
　　
```
签发者
证书用途
某A的公钥
某A的加密算法
某A的HASH算法
证书的到期时间

```

&emsp; 将证书内容进行签名，得到**数字签名**，签名的步骤是：把证书类容做一次HASH（得到一个固定长度比如128位的HASH），再用CA的私钥A加密得到了**数字签名**。

&emsp; 把证书传给客户端，这个证书(为了防止中间人的劫持攻击)包含公钥B（这个公钥B将用来对对称加密密钥进行加密， 服务器存在一个私钥B，这个私钥B对对称密钥解密。）、散列算法，数字签名(使用CA机构的私钥A对公钥B、摘要进行加密，然后使用散列算法进行摘要)。
　　
　　
<br/>
　　
- **4\. 客户端解析证书**

　　&emsp; 这部分工作是有客户端的TLS/SSL来完成的，首先会验证公钥是否有效，比如颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。
　　
	 &emsp; 若没有使用客户端内置的证书公钥A进行解密数字签名然后得到原始的HASH，然后根据证书的HASH算法计算一个HASH进行对比。若相等则没有篡改可以信任，否则就不能信任。然后生成一个随机对称加密密钥K，使用公钥B进行加密。
　　
　　　
　　<br/>
- **5\. 传送加密信息**

　　&emsp; 这部分传送的是加密过的密钥K和使用密钥K加密过的数据，目的就是让服务端使用私钥B进行解密得到密钥K。然后使用对称密钥K进行解密数据。以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了。
　
　　<br/>
　　
- **6\. 服务段解密信息**

　　&emsp; 服务端用私钥解密后，得到了客户端传过来的随机值(私钥)，然后把内容通过该值进行对称加密。所谓对称加密就是，将信息和私钥通过某种算法混合在一起，这样除非知道私钥，不然无法获取内容，而正好客户端和服务端都知道这个私钥，所以只要加密算法够彪悍，私钥够复杂，数据就够安全。
　
　　<br/>
　　
- **7\. 传输加密后的信息**

　　&emsp; 这部分信息是服务段用私钥加密后的信息，可以在客户端被还原。

　　<br/>
　　
- **8\. 客户端解密信息**

　　　&emsp; 客户端用之前生成的私钥解密服务端传过来的信息，于是获取了解密后的内容。整个过程第三方即使监听到了数据，也束手无策。

这就是整个https验证的流程了。简单总结一下：

* 就是用户发起请求，服务器响应后返回一个证书，证书中包含一些基本信息和公钥。
*   用户拿到证书后，去验证这个证书是否合法，不合法，则请求终止。
*   合法则生成一个随机数，作为对称加密的密钥，用服务器返回的公钥对这个随机数加密。然后返回给服务器。
*   服务器拿到加密后的随机数，利用私钥解密，然后再用解密后的随机数（对称密钥），把需要返回的数据加密，加密完成后数据传输给用户。
*   最后用户拿到加密的数据，用一开始的那个随机数（对称密钥），进行数据解密。整个过程完成。

当然这仅仅是一个单向认证，https还会有双向认证，相对于单向认证也很简单。仅仅多了服务端验证客户端这一步。感兴趣的可以看看这篇：[Https单向认证和双向认证。](https://link.jianshu.com?t=http://blog.csdn.net/duanbokan/article/details/50847612)

**了解了https认证流程后，接下来我们来讲讲AFSecurityPolicy这个类，AF就是用这个类来满足我们各种https认证需求。**
