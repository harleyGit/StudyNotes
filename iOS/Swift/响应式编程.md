
> <h1 id=""></h1>
- [**ä»‹ç»**](#ä»‹ç»)
- [**â€Œå“åº”å¼ç¼–ç¨‹**](#å“åº”å¼ç¼–ç¨‹)
	- [å…³é”®å­—@Published](#å…³é”®å­—@Published)
- [**â€ŒCombineæ¡†æ¶**](#Combineæ¡†æ¶)
	- [å¯å–æ¶ˆè®¢é˜…ç±»å‹AnyCancellable](#å¯å–æ¶ˆè®¢é˜…ç±»å‹AnyCancellable)
	- [åè®®ObservableObject](#åè®®ObservableObject)
		- [å‘å¸ƒè€…](#å‘å¸ƒè€…)
			- [AsyncPublisher](#AsyncPublisher)
			- [AnyPublisher](#AnyPublisher)
		- [UIKit+Frameå¸ƒå±€+MVVM+Combineç®€å•é¡¹ç›®](#UIKit+Frameå¸ƒå±€+MVVM+Combineç®€å•é¡¹ç›®)
- [**Combineç½‘ç»œè¯·æ±‚**](#Combineç½‘ç»œè¯·æ±‚)
- [**çŠ¶æ€é©±åŠ¨ç™»å½•æµç¨‹**](#çŠ¶æ€é©±åŠ¨ç™»å½•æµç¨‹)


<br/><br/><br/>

***
<br/>

> <h1 id="ä»‹ç»">ä»‹ç»</h1>


`Combine` æ˜¯ Apple è‡ªå®¶åœ¨ **Swift** ä¸­æ¨å‡ºçš„ **å“åº”å¼ç¼–ç¨‹æ¡†æ¶**ï¼Œè‡ª **iOS 13 / macOS 10.15 / watchOS 6 / tvOS 13** èµ·å¼•å…¥ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯è®©ä½ ç”¨ä¸€ç§**å£°æ˜å¼çš„æ–¹å¼**æ¥å¤„ç†æ•°æ®æµï¼Œæ¯”å¦‚å¼‚æ­¥äº‹ä»¶ã€ç”¨æˆ·è¾“å…¥ã€ç½‘ç»œè¯·æ±‚ã€å®šæ—¶å™¨ç­‰ç­‰ã€‚

---

**ğŸ§  Combine æ˜¯ä»€ä¹ˆï¼Ÿ**

ç®€å•è¯´ï¼š**Combine æ˜¯ç”¨æ¥å¤„ç†å¼‚æ­¥äº‹ä»¶æµçš„æ¡†æ¶**ï¼Œæ¯”å¦‚ï¼š

* ç½‘ç»œè¯·æ±‚è¿”å›çš„æ•°æ®
* ç”¨æˆ·è¾“å…¥æ–‡æœ¬æ¡†
* å®šæ—¶å™¨
* NotificationCenter äº‹ä»¶
* KVO (Key-Value Observing)

<br/>

- **å®ƒæä¾›äº†ä¸€æ•´å¥—å·¥å…·æ¥ï¼š**
	* è§‚å¯Ÿï¼ˆ`Publisher`ï¼‰
	* å˜æ¢ï¼ˆ`map`, `filter`, `flatMap` ç­‰ï¼‰
	* åˆå¹¶ï¼ˆ`merge`, `zip`, `combineLatest`ï¼‰
	* å“åº”ï¼ˆ`sink`, `assign`ï¼‰
	* å–æ¶ˆï¼ˆ`Cancellable`ï¼‰

---

- **ğŸ”§ Combine èƒ½åšä»€ä¹ˆï¼Ÿæ¯”å¦‚ï¼š**
	* æ›¿ä»£ `NotificationCenter` çš„ addObserver
	* æ›¿ä»£ `KVO` çš„è§‚å¯Ÿè€…
	* æ›¿ä»£ `URLSession` çš„ completion handler
	* ç”¨é“¾å¼æ“ä½œç»„åˆå¤æ‚é€»è¾‘
	* å“åº”ç”¨æˆ·ç•Œé¢äº‹ä»¶ï¼ˆé…åˆ SwiftUI æ›´å¼ºå¤§ï¼‰

---

**ğŸ§ª Combine çš„åŸºæœ¬æ¦‚å¿µ**

| æœ¯è¯­              | è¯´æ˜                          |
| --------------- | --------------------------- |
| **Publisher**   | å‘å¸ƒè€…ï¼Œå‘å¸ƒäº‹ä»¶æˆ–å€¼ï¼Œæ¯”å¦‚ä¸€ä¸ªç½‘ç»œè¯·æ±‚æˆ–è®¡æ—¶å™¨     |
| **Subscriber**  | è®¢é˜…è€…ï¼Œæ¥æ”¶å¹¶å¤„ç†äº‹ä»¶æˆ–å€¼               |
| **Operator**    | ä¸­é—´å˜æ¢é€»è¾‘ï¼Œæ¯”å¦‚ `.map`, `.filter` |
| **Cancellable** | è¿”å›çš„å¯¹è±¡ï¼Œç”¨äºå–æ¶ˆè®¢é˜…                |


***

- **âœ… æ€»ç»“ï¼šä»€ä¹ˆæ—¶å€™è¯¥ç”¨ Combineï¼Ÿ**
	* ä½ éœ€è¦å¤„ç†å¼‚æ­¥äº‹ä»¶æˆ–æ•°æ®æµ
	* æƒ³è¦æ›´ä¼˜é›…åœ°é“¾å¼ç»„åˆé€»è¾‘
	* é¡¹ç›®æ˜¯ iOS 13+ ä¸”æ˜¯ Swift é£æ ¼ï¼ˆç‰¹åˆ«æ˜¯é…åˆ SwiftUIï¼‰
	* æ›¿ä»£ä¼ ç»Ÿ KVOã€Notificationã€callback

<br/><br/><br/>

***
<br/>

> <h1 id= "å“åº”å¼ç¼–ç¨‹">å“åº”å¼ç¼–ç¨‹</h1>

- **âœ… å®ç”¨åœºæ™¯æ€»ç»“**

| åç§°                 | ç”¨é€”                    | åœºæ™¯ç¤ºä¾‹                    |
| ------------------ | --------------------- | ----------------------- |
| `@Published`       | å±æ€§å˜åŒ–é€šçŸ¥                | æ•°æ®æ¨¡å‹æ›´æ–°é€šçŸ¥ç•Œé¢æˆ–è®¢é˜…è€…          |
| `ObservableObject` | å¯è§‚å¯Ÿçš„æ•°æ®æ¨¡å‹              | SwiftUI è‡ªåŠ¨åˆ·æ–°ã€Combine è®¢é˜… |
| `AnyCancellable`   | å–æ¶ˆè®¢é˜…                  | é¿å…å†…å­˜æ³„æ¼ï¼Œä¿å­˜è®¢é˜…             |
| `@StateObject`     | SwiftUI ä¸­æŒæœ‰ ViewModel | ä¿æŒ ViewModel ç”Ÿå‘½å‘¨æœŸä¸€è‡´     |
| `PreviewProvider`  | é¢„è§ˆ UI                 | Xcode å³ä¾§ Canvas é¢„è§ˆ      |
| `AnyPublisher`     | æ³›å‹å‘å¸ƒè€…                 | æš´éœ² Combine æ¥å£           |
| `AsyncPublisher`   | å¼‚æ­¥æµè®¢é˜…                 | Swift å¹¶å‘ä¸­è§‚å¯Ÿå‘å¸ƒæ•°æ®         |


***
<br/><br/><br/>
> <h2 id="å…³é”®å­—@Published">å…³é”®å­—@Published</h2>

**âœ…`@Published`:**  æ˜¯å±æ€§åŒ…è£…å™¨ï¼Œç”¨äºå°†ç±»ä¸­çš„å±æ€§å˜æˆ **å‘å¸ƒè€…ï¼ˆPublisherï¼‰**ï¼Œä»è€Œåœ¨å€¼å‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨é€šçŸ¥è§‚å¯Ÿè€…ã€‚

- **ç”¨é€”ï¼š**

	* ç”¨äºå‘ç•Œé¢/UI æˆ–å…¶ä»–è®¢é˜…è€… **è‡ªåŠ¨å‘å¸ƒæ•°æ®å˜åŒ–**ã€‚

- **ä½¿ç”¨ç¯å¢ƒï¼š**

	* âœ… **åªèƒ½ç”¨äº `class` ä¸”ç±»å¿…é¡»ç¬¦åˆ `ObservableObject` åè®®**
	* âœ… SwiftUI ä¸­å¸¸ç”¨äºè§¦å‘ç•Œé¢åˆ·æ–°ã€‚
	* âœ… Combine æ¡†æ¶ä¸­ä¹Ÿèƒ½ä½¿ç”¨ `@Published` æ­é…è®¢é˜…é€»è¾‘ã€‚

**ç¤ºä¾‹ï¼š**

```swift
class MyModel: ObservableObject {
    @Published var name: String = ""
}
```



<br/><br/><br/>

***
<br/>

> <h1 id= "Combineæ¡†æ¶">Combineæ¡†æ¶</h1>

***
<br/><br/><br/>
> <h2 id="å¯å–æ¶ˆè®¢é˜…ç±»å‹AnyCancellable">å¯å–æ¶ˆè®¢é˜…ç±»å‹AnyCancellable</h2>

- **âœ… `AnyCancellable`:** æ˜¯Combine ä¸­çš„â€œå–æ¶ˆè®¢é˜…â€ç±»å‹ã€‚å®ƒè¡¨ç¤ºä¸€ä¸ªå¯å–æ¶ˆçš„è®¢é˜…ä»»åŠ¡ã€‚

- **ç”¨é€”ï¼š**

	* ç”¨æ¥ä¿å­˜è®¢é˜…å…³ç³»ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
	* éœ€è¦æ‰‹åŠ¨æŒæœ‰ï¼Œä¸ç„¶è®¢é˜…ä¼šç«‹åˆ»é‡Šæ”¾

- **ç¤ºä¾‹ï¼š**

```swift
var cancellables = Set<AnyCancellable>()

myModel.$name
    .sink { newName in
        print("Name changed to: \(newName)")
    }
    .store(in: &cancellables)
```



***
<br/><br/><br/>
> <h2 id="åè®®ObservableObject">åè®®ObservableObject</h2>

- **âœ…`ObservableObject`:** æ˜¯ä¸€ä¸ªåè®®ï¼Œç”¨äºæ ‡è®°ç±»æ˜¯å¯è§‚å¯Ÿçš„å¯¹è±¡ï¼Œå’Œ `@Published` æ­é…ä½¿ç”¨ã€‚

- **ç”¨é€”ï¼š**

	* SwiftUI ä¸­ç”¨äºè‡ªåŠ¨åˆ·æ–°ç•Œé¢
	* Combine ä¸­ç”¨äºæ‰‹åŠ¨è®¢é˜…å±æ€§å˜åŒ–

- **ç¤ºä¾‹ï¼š**

```swift
class UserData: ObservableObject {
    @Published var age: Int = 0
}
```

***
<br/><br/><br/>
> <h2 id="å‘å¸ƒè€…">å‘å¸ƒè€…</h2>

<br/><br/>
> <h3 id="AsyncPublisher">AsyncPublisher</h3>

**ğŸ”¸ `AsyncPublisher` æ˜¯ Swift Concurrency ä¸­çš„å¼‚æ­¥æµå°è£…ï¼ˆiOS 15+ï¼‰**

```swift
@Published var name: String = ""
for await value in $name.values {
    print("Name updated: \(value)")
}
```


***
<br/><br/><br/>
> <h2 id="UIKit+Frameå¸ƒå±€+MVVM+Combineç®€å•é¡¹ç›®">UIKit + Frame å¸ƒå±€ + MVVM + Combine ç¤ºä¾‹é¡¹ç›®</h2>

**è¾“å…¥ç•Œé¢ï¼š**

> âœ… ç”¨æˆ·è¾“å…¥åå­— â†’ å®æ—¶æ˜¾ç¤ºåå­—é•¿åº¦
> âœ… ä½¿ç”¨ Combine ç›‘å¬è¾“å…¥å˜åŒ–
> âœ… ä½¿ç”¨ MVVM æ¶æ„ï¼ˆModel + ViewModel + ViewControllerï¼‰

---

- **âœ… é¡¹ç›®ç»“æ„**

```text
ğŸ“ MVVMCombineUIKitExample
â”œâ”€â”€ UserModel.swift        // æ¨¡å‹å±‚
â”œâ”€â”€ UserViewModel.swift    // ä¸šåŠ¡é€»è¾‘å±‚
â””â”€â”€ ViewController.swift   // æ§åˆ¶å™¨ + UIå±‚ (ç”¨ Frame å¸ƒå±€)
```

---

- **âœ… 1. æ¨¡å‹å±‚ `UserModel.swift`**

```swift
import Foundation

struct UserModel {
    var name: String
}
```

---

- **âœ… 2. ViewModel å±‚ `UserViewModel.swift`**

```swift
import Foundation
import Combine

class UserViewModel {
    // è¾“å…¥ï¼šname å­—ç¬¦ä¸²
    @Published var name: String = ""
    
    // è¾“å‡ºï¼šåå­—é•¿åº¦å­—ç¬¦ä¸²ï¼ˆä¾› UI æ˜¾ç¤ºï¼‰
    @Published private(set) var nameLengthText: String = "0"

    private var cancellables = Set<AnyCancellable>()

    init() {
        // ç›‘å¬ name çš„å˜åŒ–ï¼Œè½¬æ¢æˆ length å­—ç¬¦ä¸²
        $name
            .map { "åå­—é•¿åº¦ï¼š\($0.count)" }
            .assign(to: \.nameLengthText, on: self)
            .store(in: &cancellables)
    }
}
```

> âœ… ç”¨ `@Published` å‘å¸ƒå˜åŒ–ï¼ŒCombine ä¼šè‡ªåŠ¨å°† `name` æ˜ å°„æˆ `nameLengthText`
> âœ… æ‰€æœ‰è®¢é˜…éƒ½ä¿å­˜åœ¨ `cancellables` é›†åˆä¸­ï¼Œé¿å…å†…å­˜æ³„æ¼

---

- **âœ… 3. è§†å›¾å±‚ï¼ˆæ§åˆ¶å™¨ï¼‰`ViewController.swift`**

```swift
import UIKit
import Combine

class ViewController: UIViewController {

    private let nameTextField = UITextField()
    private let lengthLabel = UILabel()
    private let viewModel = UserViewModel()
    private var cancellables = Set<AnyCancellable>()

    override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = .white

        setupUI()
        bindViewModel()
    }

    private func setupUI() {
        // è®¾ç½®è¾“å…¥æ¡†
        nameTextField.frame = CGRect(x: 40, y: 100, width: 300, height: 40)
        nameTextField.placeholder = "è¯·è¾“å…¥åå­—"
        nameTextField.borderStyle = .roundedRect
        view.addSubview(nameTextField)

        // è®¾ç½®æ˜¾ç¤ºé•¿åº¦çš„ Label
        lengthLabel.frame = CGRect(x: 40, y: 160, width: 300, height: 30)
        lengthLabel.textColor = .black
        view.addSubview(lengthLabel)

        // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–ï¼ˆç›®æ ‡ï¼šå‘é€åˆ° viewModelï¼‰
        nameTextField.addTarget(self, action: #selector(nameChanged), for: .editingChanged)
    }

    @objc private func nameChanged() {
        viewModel.name = nameTextField.text ?? ""
    }

    private func bindViewModel() {
        // å°† viewModel çš„ nameLengthText æ˜¾ç¤ºåˆ°ç•Œé¢ä¸Š
        viewModel.$nameLengthText
            .receive(on: RunLoop.main)
            .sink { [weak self] lengthText in
                self?.lengthLabel.text = lengthText
            }
            .store(in: &cancellables)
    }
}
```

---

- **âœ… è¿è¡Œæ•ˆæœ**
	1. å¯åŠ¨åç•Œé¢æœ‰ä¸ªè¾“å…¥æ¡†å’Œä¸€ä¸ª labelã€‚
	2. è¾“å…¥ä»»æ„å­—ç¬¦ï¼Œlabel ä¼šå®æ—¶æ˜¾ç¤ºï¼š`åå­—é•¿åº¦ï¼š3`ã€`åå­—é•¿åº¦ï¼š5` ç­‰ã€‚
	3. æ‰€æœ‰æ•°æ®å˜åŒ–éƒ½åœ¨ ViewModel ä¸­å¤„ç†ï¼ŒUI å±‚ä»…ç»‘å®šå’Œæ˜¾ç¤ºã€‚

---

- **âœ… æ€»ç»“ï¼šå…³é”®ç‚¹è§£é‡Š**

| å…ƒç´                                            | ä½œç”¨           | å±äºå“ªä¸€å±‚                |
| -------------------------------------------- | ------------ | -------------------- |
| `@Published var name`                        | è¢«è¾“å…¥çš„åŸå§‹æ•°æ®     | ViewModel            |
| `@Published private(set) var nameLengthText` | UI æ˜¾ç¤ºçš„æ ¼å¼åŒ–æ•°æ®  | ViewModel            |
| `.map { ... } .assign(...)`                  | å°†è¾“å…¥æ•°æ®è½¬åŒ–ä¸ºè¾“å‡º   | Combineï¼ˆå“åº”å¼è½¬æ¢ï¼‰       |
| `UITextField.addTarget(...)`                 | æ•è·ç”¨æˆ·è¾“å…¥       | ViewControllerï¼ˆViewï¼‰ |
| `sink { ... }`                               | æ¥æ”¶å‘å¸ƒçš„å€¼å¹¶æ›´æ–° UI | ViewController       |

---

- **âœ… ä½¿ç”¨ Combine çš„å¥½å¤„**

* ä¸å†å†™é‡å¤çš„å›è°ƒä»£ç ï¼ˆKVO / delegateï¼‰
* è§£è€¦è¾“å…¥ã€è½¬æ¢ã€è¾“å‡ºé€»è¾‘
* é€»è¾‘é›†ä¸­åœ¨ ViewModelï¼Œä¾¿äºæµ‹è¯•å’Œç»´æŠ¤


***

æ¯”è¾ƒå®Œæ•´çš„é¡¹ç›®Demo:

**å¯¹å‰é¢çš„ UIKit + MVVM + Combine ç¤ºä¾‹è¿›è¡Œæ¨¡å—åŒ–å°è£…å’ŒåŠŸèƒ½å¢å¼ºï¼ŒåŒ…æ‹¬ï¼š**

- **âœ… æ”¹è¿›ç›®æ ‡**
	- æ¨¡å—æ¸…æ™°ï¼š æ‹†åˆ† Model / ViewModel / ViewController / NetworkService
	
	- é”™è¯¯å¤„ç†ï¼š æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ + é‡è¯•æœºåˆ¶
	
	- çŠ¶æ€ç®¡ç†ï¼š å¼•å…¥ enum LoadState { idle, loading, success, failure }
	
	- å¯æ‰©å±•æ€§ï¼š æ”¯æŒæœªæ¥æ·»åŠ å¤šä¸ªé¡µé¢æˆ–æ•°æ®æº

```text
ğŸ“ MVVMCombineNetworkModule
â”œâ”€â”€ Models/
â”‚   â””â”€â”€ RandomUser.swift
â”œâ”€â”€ Services/
â”‚   â””â”€â”€ RandomUserService.swift
â”œâ”€â”€ ViewModels/
â”‚   â””â”€â”€ RandomUserViewModel.swift
â””â”€â”€ Controllers/
    â””â”€â”€ RandomUserViewController.swift

```

```swift
// MARK: - Models/RandomUser.swift

import Foundation

struct RandomUserResponse: Decodable {
    struct User: Decodable {
        struct Name: Decodable {
            let first: String
            let last: String
        }
        let name: Name
    }
    let results: [User]
}


// MARK: - Services/RandomUserService.swift

import Foundation
import Combine
import SQLite3

protocol RandomUserServiceProtocol {
    func fetchUsers(page: Int) -> AnyPublisher<[String], Error>
    func getCachedUsers(page: Int) -> [String]?
    func cacheUsers(_ users: [String], page: Int)
    func clearExpiredCache()
}

class RandomUserService: RandomUserServiceProtocol {
    private var db: OpaquePointer?

    init() {
        let fileURL = FileManager.default.temporaryDirectory.appendingPathComponent("users.sqlite")
        if sqlite3_open(fileURL.path, &db) == SQLITE_OK {
            let createTableQuery = "CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY AUTOINCREMENT, page INTEGER, name TEXT, timestamp REAL)"
            sqlite3_exec(db, createTableQuery, nil, nil, nil)
        }
    }

    func getCachedUsers(page: Int) -> [String]? {
        var statement: OpaquePointer?
        let query = "SELECT name, timestamp FROM users WHERE page = ?"
        var names: [String] = []

        if sqlite3_prepare_v2(db, query, -1, &statement, nil) == SQLITE_OK {
            sqlite3_bind_int(statement, 1, Int32(page))
            while sqlite3_step(statement) == SQLITE_ROW {
                if let name = sqlite3_column_text(statement, 0) {
                    let timestamp = sqlite3_column_double(statement, 1)
                    let currentTime = Date().timeIntervalSince1970
                    let cacheAge = currentTime - timestamp
                    if cacheAge < 60 * 60 { // 1 å°æ—¶æœ‰æ•ˆ
                        names.append(String(cString: name))
                    }
                }
            }
        }
        sqlite3_finalize(statement)
        return names.isEmpty ? nil : names
    }

    func cacheUsers(_ users: [String], page: Int) {
        let insert = "INSERT INTO users (page, name, timestamp) VALUES (?, ?, ?)"
        for name in users {
            var statement: OpaquePointer?
            if sqlite3_prepare_v2(db, insert, -1, &statement, nil) == SQLITE_OK {
                sqlite3_bind_int(statement, 1, Int32(page))
                sqlite3_bind_text(statement, 2, name, -1, nil)
                sqlite3_bind_double(statement, 3, Date().timeIntervalSince1970)
                sqlite3_step(statement)
            }
            sqlite3_finalize(statement)
        }
    }

    func clearExpiredCache() {
        let expirationTime = Date().timeIntervalSince1970 - 60 * 60
        let deleteQuery = "DELETE FROM users WHERE timestamp < ?"
        var statement: OpaquePointer?
        if sqlite3_prepare_v2(db, deleteQuery, -1, &statement, nil) == SQLITE_OK {
            sqlite3_bind_double(statement, 1, expirationTime)
            sqlite3_step(statement)
        }
        sqlite3_finalize(statement)
    }

    func fetchUsers(page: Int) -> AnyPublisher<[String], Error> {
        let url = URL(string: "https://randomuser.me/api/?page=\(page)&results=10")!

        return URLSession.shared.dataTaskPublisher(for: url)
            .map(\.data)
            .decode(type: RandomUserResponse.self, decoder: JSONDecoder())
            .tryMap { response in
                let names = response.results.map { "\($0.name.first) \($0.name.last)" }
                if names.isEmpty {
                    throw URLError(.cannotParseResponse)
                }
                return names
            }
            .receive(on: DispatchQueue.main)
            .eraseToAnyPublisher()
    }
}


// MARK: - ViewModels/RandomUserViewModel.swift

import Foundation
import Combine

enum LoadState {
    case idle
    case loading
    case success
    case failure(String)
    case retry(() -> Void)
}

enum AppError: LocalizedError {
    case network
    case decode
    case unknown

    var errorDescription: String? {
        switch self {
        case .network: return "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®ã€‚"
        case .decode: return "æ•°æ®è§£æå¤±è´¥ã€‚"
        case .unknown: return "æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚"
        }
    }
}

class RandomUserViewModel {
    @Published private(set) var users: [String] = []
    @Published private(set) var state: LoadState = .idle

    private var cancellables = Set<AnyCancellable>()
    private let service: RandomUserServiceProtocol
    private var currentPage: Int = 1
    private var isFetching: Bool = false
    private var retryCount = 0

    init(service: RandomUserServiceProtocol = RandomUserService()) {
        self.service = service
        self.service.clearExpiredCache()
    }

    func loadUsers(reset: Bool = false) {
        guard !isFetching else { return }
        isFetching = true

        if reset {
            currentPage = 1
            users.removeAll()
        }

        if let cached = service.getCachedUsers(page: currentPage) {
            self.users.append(contentsOf: cached)
            self.state = .success
        } else {
            self.state = .loading
        }

        fetchWithRetry(page: currentPage)
    }

    private func fetchWithRetry(page: Int) {
        service.fetchUsers(page: page)
            .sink { [weak self] completion in
                guard let self = self else { return }
                self.isFetching = false
                switch completion {
                case .failure(let error):
                    let errorType: AppError
                    if let urlError = error as? URLError {
                        errorType = .network
                    } else if error is DecodingError {
                        errorType = .decode
                    } else {
                        errorType = .unknown
                    }

                    if self.retryCount < 2 {
                        self.retryCount += 1
                        self.fetchWithRetry(page: page)
                    } else {
                        self.state = .retry({ [weak self] in
                            self?.loadUsers(reset: false)
                        })
                        self.retryCount = 0
                    }
                case .finished:
                    self.retryCount = 0
                }
            } receiveValue: { [weak self] newUsers in
                guard let self = self else { return }
                self.users.append(contentsOf: newUsers)
                self.service.cacheUsers(newUsers, page: page)
                self.currentPage += 1
                self.state = .success
            }
            .store(in: &cancellables)
    }
}

```



<br/><br/>
> <h3 id="AnyPublisher"> AnyPublisher </h3>

- **ğŸ”¸ `AnyPublisher` æ˜¯ Combine ä¸­çš„æ³›å‹å‘å¸ƒè€…**

```swift
let publisher: AnyPublisher<String, Never>
```

* ç”¨äºéšè—å…·ä½“çš„ Publisher ç±»å‹
* å¯ä»¥è¿”å›ç»™å¤–éƒ¨è¿›è¡Œè®¢é˜…




<br/><br/><br/>

***
<br/>

> <h1 id="Combineç½‘ç»œè¯·æ±‚">Combineç½‘ç»œè¯·æ±‚</h1>

```swift
import Combine

var cancellables = Set<AnyCancellable>()

URLSession.shared.dataTaskPublisher(for: URL(string: "https://api.example.com/data")!)
    .map(\.data)
    .decode(type: MyModel.self, decoder: JSONDecoder())
    .receive(on: RunLoop.main)
    .sink(receiveCompletion: { completion in
        switch completion {
        case .finished:
            print("è¯·æ±‚å®Œæˆ")
        case .failure(let error):
            print("å‡ºé”™ï¼š\(error)")
        }
    }, receiveValue: { value in
        print("æ”¶åˆ°æ•°æ®ï¼š\(value)")
    })
    .store(in: &cancellables)
```

<br/>

**âœï¸ ç¤ºä¾‹ 2ï¼šç›‘å¬è¾“å…¥æ¡†å˜åŒ–**

```swift
import Combine
import UIKit

let textField = UITextField()
var cancellables = Set<AnyCancellable>()

NotificationCenter.default
    .publisher(for: UITextField.textDidChangeNotification, object: textField)
    .compactMap { ($0.object as? UITextField)?.text }
    .sink { text in
        print("æ–‡æœ¬å˜åŒ–ï¼š\(text)")
    }
    .store(in: &cancellables)
```

<br/>

**è®¡æ—¶å™¨**

```swift
import Combine

Timer.publish(every: 1, on: .main, in: .common)
    .autoconnect()
    .sink { time in
        print("å½“å‰æ—¶é—´ï¼š\(time)")
    }
    .store(in: &cancellables)
```

---

**ğŸ“Œ Combine vs ä¼ ç»Ÿå†™æ³•**

| ä¼ ç»Ÿæ–¹å¼                              | Combine                           |
| --------------------------------- | --------------------------------- |
| `NotificationCenter` + `selector` | `.publisher(for:)`                |
| `KVO`                             | `@Published` / `ObservableObject` |
| `URLSession` + completion handler | `.dataTaskPublisher()`            |
| å¤æ‚åµŒå¥—å›è°ƒ                            | é“¾å¼å“åº”                              |

---

**ğŸ§± Combine + SwiftUIï¼ˆæœ€ä½³æ‹æ¡£ï¼‰**

Combine åœ¨ SwiftUI ä¸­ä½¿ç”¨éå¸¸è‡ªç„¶ï¼Œæœ€å¸¸è§çš„æ˜¯ä½¿ç”¨ `@Published` å’Œ `@ObservedObject`ã€‚

```swift
class ViewModel: ObservableObject {
    @Published var count = 0
    
    init() {
        Timer.publish(every: 1, on: .main, in: .common)
            .autoconnect()
            .sink { _ in self.count += 1 }
            .store(in: &cancellables)
    }
    
    private var cancellables = Set<AnyCancellable>()
}
```

```swift
struct ContentView: View {
    @StateObject var viewModel = ViewModel()
    
    var body: some View {
        Text("è®¡æ•°ï¼š\(viewModel.count)")
    }
}
```



<br/><br/><br/>

***
<br/>
> <h1 id="çŠ¶æ€é©±åŠ¨ç™»å½•æµç¨‹">çŠ¶æ€é©±åŠ¨ç™»å½•æµç¨‹</h1>

- å¦‚ä½•ä½¿ç”¨ Frame å¸ƒå±€å’ŒçŠ¶æ€é©±åŠ¨æ–¹å¼å®ç°ä¸€ä¸ªä¸‰æ­¥ç™»å½•æµç¨‹ï¼Œæ”¯æŒï¼š
	* æ¬¢è¿é¡µ
	* ç”¨æˆ·åå¯†ç è¾“å…¥
	* ç™»å½•æˆåŠŸé¡µ
	* é”™è¯¯æç¤º
	* è§†å›¾çŠ¶æ€ç®¡ç† + ç§æœ‰åŒ–å†™å…¥é€»è¾‘

---

- **ğŸ”¹ `1. LoginStep.swift` â€” çŠ¶æ€æšä¸¾**

```swift
import Foundation

enum LoginStep {
    case welcome
    case enterCredentials
    case success
    case error(String)
}
```

---

- **ğŸ”¹ `2.LoginViewModel.swift` â€” çŠ¶æ€é©±åŠ¨é€»è¾‘**

```swift
import Foundation

class LoginViewModel {
    private(set) var step: LoginStep = .welcome

    var username: String = ""
    var password: String = ""

    // ç»‘å®šå›è°ƒ
    var onStateChange: ((LoginStep) -> Void)?

    func startLogin() {
        step = .enterCredentials
        onStateChange?(step)
    }

    func submit() {
        guard !username.isEmpty, !password.isEmpty else {
            step = .error("ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º")
            onStateChange?(step)
            return
        }

        // æ¨¡æ‹Ÿç™»å½•è¯·æ±‚
        DispatchQueue.main.asyncAfter(deadline: .now() + 1) {
            if self.username == "admin" && self.password == "123456" {
                self.step = .success
            } else {
                self.step = .error("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")
            }
            self.onStateChange?(self.step)
        }
    }

    func reset() {
        username = ""
        password = ""
        step = .welcome
        onStateChange?(step)
    }
}
```

---

- **ğŸ”¹ `3.LoginViewController.swift` â€” UIKit + Frame å¸ƒå±€**

```swift
import UIKit

class LoginViewController: UIViewController {

    let viewModel = LoginViewModel()

    // MARK: UI Components
    let welcomeLabel = UILabel()
    let startButton = UIButton(type: .system)

    let usernameField = UITextField()
    let passwordField = UITextField()
    let submitButton = UIButton(type: .system)

    let successLabel = UILabel()
    let resetButton = UIButton(type: .system)

    let errorLabel = UILabel()

    override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = .white
        setupSubviews()
        layoutForWelcome()

        viewModel.onStateChange = { [weak self] step in
            DispatchQueue.main.async {
                self?.updateUI(for: step)
            }
        }
    }

    // MARK: Setup
    func setupSubviews() {
        // æ¬¢è¿é¡µ
        welcomeLabel.text = "æ¬¢è¿ä½¿ç”¨"
        welcomeLabel.textAlignment = .center
        welcomeLabel.font = UIFont.systemFont(ofSize: 28, weight: .medium)
        view.addSubview(welcomeLabel)

        startButton.setTitle("å¼€å§‹ç™»å½•", for: .normal)
        startButton.addTarget(self, action: #selector(startLogin), for: .touchUpInside)
        view.addSubview(startButton)

        // ç™»å½•è¾“å…¥
        usernameField.placeholder = "ç”¨æˆ·å"
        usernameField.borderStyle = .roundedRect
        view.addSubview(usernameField)

        passwordField.placeholder = "å¯†ç "
        passwordField.borderStyle = .roundedRect
        passwordField.isSecureTextEntry = true
        view.addSubview(passwordField)

        submitButton.setTitle("ç™»å½•", for: .normal)
        submitButton.addTarget(self, action: #selector(submit), for: .touchUpInside)
        view.addSubview(submitButton)

        // æˆåŠŸé¡µ
        successLabel.text = "ğŸ‰ ç™»å½•æˆåŠŸ"
        successLabel.textAlignment = .center
        successLabel.font = UIFont.boldSystemFont(ofSize: 24)
        view.addSubview(successLabel)

        resetButton.setTitle("é‡æ–°å¼€å§‹", for: .normal)
        resetButton.addTarget(self, action: #selector(reset), for: .touchUpInside)
        view.addSubview(resetButton)

        // é”™è¯¯æç¤º
        errorLabel.textColor = .systemRed
        errorLabel.textAlignment = .center
        errorLabel.font = UIFont.systemFont(ofSize: 14)
        view.addSubview(errorLabel)
    }

    // MARK: UI æ›´æ–°
    func updateUI(for step: LoginStep) {
        // éšè—æ‰€æœ‰
        [welcomeLabel, startButton,
         usernameField, passwordField, submitButton,
         successLabel, resetButton, errorLabel
        ].forEach { $0.isHidden = true }

        switch step {
        case .welcome:
            layoutForWelcome()
        case .enterCredentials:
            layoutForCredentials()
        case .success:
            layoutForSuccess()
        case .error(let message):
            layoutForCredentials()
            errorLabel.text = message
            errorLabel.isHidden = false
        }
    }

    // MARK: å¸ƒå±€å‡½æ•°
    func layoutForWelcome() {
        let w = view.bounds.width
        welcomeLabel.frame = CGRect(x: 40, y: 180, width: w - 80, height: 50)
        startButton.frame = CGRect(x: 100, y: 250, width: w - 200, height: 44)

        welcomeLabel.isHidden = false
        startButton.isHidden = false
    }

    func layoutForCredentials() {
        let w = view.bounds.width
        usernameField.frame = CGRect(x: 40, y: 150, width: w - 80, height: 40)
        passwordField.frame = CGRect(x: 40, y: 200, width: w - 80, height: 40)
        submitButton.frame = CGRect(x: 100, y: 260, width: w - 200, height: 44)
        errorLabel.frame = CGRect(x: 40, y: 310, width: w - 80, height: 20)

        usernameField.isHidden = false
        passwordField.isHidden = false
        submitButton.isHidden = false
    }

    func layoutForSuccess() {
        let w = view.bounds.width
        successLabel.frame = CGRect(x: 40, y: 200, width: w - 80, height: 50)
        resetButton.frame = CGRect(x: 100, y: 270, width: w - 200, height: 44)

        successLabel.isHidden = false
        resetButton.isHidden = false
    }

    // MARK: Actions
    @objc func startLogin() {
        viewModel.startLogin()
    }

    @objc func submit() {
        viewModel.username = usernameField.text ?? ""
        viewModel.password = passwordField.text ?? ""
        viewModel.submit()
    }

    @objc func reset() {
        viewModel.reset()
    }
}
```

---

**âœ…  4. AppDelegate / SceneDelegate å¯åŠ¨ç•Œé¢**

åœ¨ `SceneDelegate.swift` ä¸­è®¾ç½®æ ¹æ§åˆ¶å™¨ï¼ˆå¦‚ä½¿ç”¨ Storyboard å¯è·³è¿‡è¿™æ­¥ï¼‰ï¼š

```swift
func scene(_ scene: UIScene, willConnectTo session: UISceneSession, options connectionOptions: UIScene.ConnectionOptions) {
    guard let windowScene = (scene as? UIWindowScene) else { return }
    window = UIWindow(windowScene: windowScene)
    window?.rootViewController = LoginViewController()
    window?.makeKeyAndVisible()
}
```

---

âœ… æ•ˆæœï¼š

| çŠ¶æ€                  | æ˜¾ç¤ºå†…å®¹            | äº¤äº’              |
| ------------------- | --------------- | --------------- |
| `.welcome`          | æ¬¢è¿é¡µ + â€œå¼€å§‹ç™»å½•â€æŒ‰é’®  | ç‚¹å‡»åè¿›å…¥è¾“å…¥é¡µé¢       |
| `.enterCredentials` | è¾“å…¥ç”¨æˆ·åå’Œå¯†ç  + ç™»å½•æŒ‰é’® | è¾“å…¥é”™è¯¯è§¦å‘ `.error` |
| `.success`          | æ˜¾ç¤ºæˆåŠŸæç¤º + é‡ç½®æŒ‰é’®   | ç‚¹å‡»é‡ç½®è¿”å›æ¬¢è¿é¡µ       |
| `.error`            | å½“å‰é¡µé¢ä¸Šæ–¹æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯    | ä¿æŒè¾“å…¥æ¡†ï¼Œä¸å½±å“æ“ä½œ     |









