
> <h1 id=""></h1>
- [**ä»‹ç»**](#ä»‹ç»)



<br/><br/><br/>

***
<br/>

> <h1 id="ä»‹ç»">ä»‹ç»</h1>


`Combine` æ˜¯ Apple è‡ªå®¶åœ¨ **Swift** ä¸­æ¨å‡ºçš„ **å“åº”å¼ç¼–ç¨‹æ¡†æ¶**ï¼Œè‡ª **iOS 13 / macOS 10.15 / watchOS 6 / tvOS 13** èµ·å¼•å…¥ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯è®©ä½ ç”¨ä¸€ç§**å£°æ˜å¼çš„æ–¹å¼**æ¥å¤„ç†æ•°æ®æµï¼Œæ¯”å¦‚å¼‚æ­¥äº‹ä»¶ã€ç”¨æˆ·è¾“å…¥ã€ç½‘ç»œè¯·æ±‚ã€å®šæ—¶å™¨ç­‰ç­‰ã€‚

---

**ğŸ§  Combine æ˜¯ä»€ä¹ˆï¼Ÿ**

ç®€å•è¯´ï¼š**Combine æ˜¯ç”¨æ¥å¤„ç†å¼‚æ­¥äº‹ä»¶æµçš„æ¡†æ¶**ï¼Œæ¯”å¦‚ï¼š

* ç½‘ç»œè¯·æ±‚è¿”å›çš„æ•°æ®
* ç”¨æˆ·è¾“å…¥æ–‡æœ¬æ¡†
* å®šæ—¶å™¨
* NotificationCenter äº‹ä»¶
* KVO (Key-Value Observing)

<br/>

- **å®ƒæä¾›äº†ä¸€æ•´å¥—å·¥å…·æ¥ï¼š**
	* è§‚å¯Ÿï¼ˆ`Publisher`ï¼‰
	* å˜æ¢ï¼ˆ`map`, `filter`, `flatMap` ç­‰ï¼‰
	* åˆå¹¶ï¼ˆ`merge`, `zip`, `combineLatest`ï¼‰
	* å“åº”ï¼ˆ`sink`, `assign`ï¼‰
	* å–æ¶ˆï¼ˆ`Cancellable`ï¼‰

---

- **ğŸ”§ Combine èƒ½åšä»€ä¹ˆï¼Ÿæ¯”å¦‚ï¼š**
	* æ›¿ä»£ `NotificationCenter` çš„ addObserver
	* æ›¿ä»£ `KVO` çš„è§‚å¯Ÿè€…
	* æ›¿ä»£ `URLSession` çš„ completion handler
	* ç”¨é“¾å¼æ“ä½œç»„åˆå¤æ‚é€»è¾‘
	* å“åº”ç”¨æˆ·ç•Œé¢äº‹ä»¶ï¼ˆé…åˆ SwiftUI æ›´å¼ºå¤§ï¼‰

---

**ğŸ§ª Combine çš„åŸºæœ¬æ¦‚å¿µ**

| æœ¯è¯­              | è¯´æ˜                          |
| --------------- | --------------------------- |
| **Publisher**   | å‘å¸ƒè€…ï¼Œå‘å¸ƒäº‹ä»¶æˆ–å€¼ï¼Œæ¯”å¦‚ä¸€ä¸ªç½‘ç»œè¯·æ±‚æˆ–è®¡æ—¶å™¨     |
| **Subscriber**  | è®¢é˜…è€…ï¼Œæ¥æ”¶å¹¶å¤„ç†äº‹ä»¶æˆ–å€¼               |
| **Operator**    | ä¸­é—´å˜æ¢é€»è¾‘ï¼Œæ¯”å¦‚ `.map`, `.filter` |
| **Cancellable** | è¿”å›çš„å¯¹è±¡ï¼Œç”¨äºå–æ¶ˆè®¢é˜…                |


***

- **âœ… æ€»ç»“ï¼šä»€ä¹ˆæ—¶å€™è¯¥ç”¨ Combineï¼Ÿ**
	* ä½ éœ€è¦å¤„ç†å¼‚æ­¥äº‹ä»¶æˆ–æ•°æ®æµ
	* æƒ³è¦æ›´ä¼˜é›…åœ°é“¾å¼ç»„åˆé€»è¾‘
	* é¡¹ç›®æ˜¯ iOS 13+ ä¸”æ˜¯ Swift é£æ ¼ï¼ˆç‰¹åˆ«æ˜¯é…åˆ SwiftUIï¼‰
	* æ›¿ä»£ä¼ ç»Ÿ KVOã€Notificationã€callback




<br/><br/><br/>

***
<br/>

> <h1 id="Combineç½‘ç»œè¯·æ±‚">Combineç½‘ç»œè¯·æ±‚</h1>

```swift
import Combine

var cancellables = Set<AnyCancellable>()

URLSession.shared.dataTaskPublisher(for: URL(string: "https://api.example.com/data")!)
    .map(\.data)
    .decode(type: MyModel.self, decoder: JSONDecoder())
    .receive(on: RunLoop.main)
    .sink(receiveCompletion: { completion in
        switch completion {
        case .finished:
            print("è¯·æ±‚å®Œæˆ")
        case .failure(let error):
            print("å‡ºé”™ï¼š\(error)")
        }
    }, receiveValue: { value in
        print("æ”¶åˆ°æ•°æ®ï¼š\(value)")
    })
    .store(in: &cancellables)
```

<br/>

**âœï¸ ç¤ºä¾‹ 2ï¼šç›‘å¬è¾“å…¥æ¡†å˜åŒ–**

```swift
import Combine
import UIKit

let textField = UITextField()
var cancellables = Set<AnyCancellable>()

NotificationCenter.default
    .publisher(for: UITextField.textDidChangeNotification, object: textField)
    .compactMap { ($0.object as? UITextField)?.text }
    .sink { text in
        print("æ–‡æœ¬å˜åŒ–ï¼š\(text)")
    }
    .store(in: &cancellables)
```

<br/>

**è®¡æ—¶å™¨**

```swift
import Combine

Timer.publish(every: 1, on: .main, in: .common)
    .autoconnect()
    .sink { time in
        print("å½“å‰æ—¶é—´ï¼š\(time)")
    }
    .store(in: &cancellables)
```

---

**ğŸ“Œ Combine vs ä¼ ç»Ÿå†™æ³•**

| ä¼ ç»Ÿæ–¹å¼                              | Combine                           |
| --------------------------------- | --------------------------------- |
| `NotificationCenter` + `selector` | `.publisher(for:)`                |
| `KVO`                             | `@Published` / `ObservableObject` |
| `URLSession` + completion handler | `.dataTaskPublisher()`            |
| å¤æ‚åµŒå¥—å›è°ƒ                            | é“¾å¼å“åº”                              |

---

## ğŸ§± Combine + SwiftUIï¼ˆæœ€ä½³æ‹æ¡£ï¼‰

Combine åœ¨ SwiftUI ä¸­ä½¿ç”¨éå¸¸è‡ªç„¶ï¼Œæœ€å¸¸è§çš„æ˜¯ä½¿ç”¨ `@Published` å’Œ `@ObservedObject`ã€‚

```swift
class ViewModel: ObservableObject {
    @Published var count = 0
    
    init() {
        Timer.publish(every: 1, on: .main, in: .common)
            .autoconnect()
            .sink { _ in self.count += 1 }
            .store(in: &cancellables)
    }
    
    private var cancellables = Set<AnyCancellable>()
}
```

```swift
struct ContentView: View {
    @StateObject var viewModel = ViewModel()
    
    var body: some View {
        Text("è®¡æ•°ï¼š\(viewModel.count)")
    }
}
```



å¦‚æœä½ å¸Œæœ›æˆ‘æä¾›ä¸€ä¸ªå®Œæ•´å°é¡¹ç›®æˆ–è€…æ›´å¤æ‚çš„ç”¨æ³•ï¼ˆæ¯”å¦‚ `combineLatest`, `flatMap`, `retry`, è‡ªå®šä¹‰ Publisher ç­‰ï¼‰ï¼Œä¹Ÿå¯ä»¥ç»§ç»­é—®æˆ‘ï¼
