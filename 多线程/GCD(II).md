>## <h2 id=""></h2>
- [读写锁实现](#读写锁实现)
- **参考资料：**
	
	



<br/>

***
<br/>


># <h1 id="读写锁实现">读写锁实现</h1>

- **读写锁场景：**
     
	-  同一时间，只能有1个线程进行写的操作

	-  同一时间，允许有多个线程进行读的操作

	-  同一时间，不允许既有写的操作，又有读的操作


<br/>

上面的场景就是典型的“多读单写”，经常用于文件等数据的读写操作，iOS中的实现方案用**‌dispatch_barrier_async**：

```

@property (nonatomic, copy) NSString *text;
@property (nonatomic, strong) dispatch_queue_t concurrentQueue;



- (void) testAction {
    
    [self testMethod2];
    
}


//读写锁测试
- (void) testMethod2 {
    NSLog(@"读写锁测试------------------------------------>");
    
    /**
     读写锁场景：
     
     同一时间，只能有1个线程进行写的操作
     
     同一时间，允许有多个线程进行读的操作
     
     同一时间，不允许既有写的操作，又有读的操作
     上面的场景就是典型的“多读单写”，经常用于文件等数据的读写操作，iOS中的实现方案有：
     */
    
    self.concurrentQueue = dispatch_queue_create("aaa", DISPATCH_QUEUE_CONCURRENT);
    // 测试代码,模拟多线程情况下的读写
    for (int i = 0; i<10; i++) {
        NSLog(@"🍎 🍎 🍎 写操作1");
        dispatch_async(dispatch_get_global_queue(0, 0), ^{
            self.text = [NSString stringWithFormat:@"噼里啪啦--%d",i];
        });
        
    }
    
    for (int i = 0; i<50; i++) {

        dispatch_async(dispatch_get_global_queue(0, 0), ^{
            NSLog(@"读 %@ %@",[self text],[NSThread currentThread]);
        });
        
    }
    
    
    for (int i = 10; i<20; i++) {
        NSLog(@"🍐 🍐 🍐 写操作2");

        dispatch_async(dispatch_get_global_queue(0, 0), ^{
            self.text = [NSString stringWithFormat:@"噼里啪啦--%d",i];
        });
        
    }
}

// 写操作,栅栏函数是不允许并发的,所以"写操作"是单线程进入的,根据log可以看出来
- (void)setText:(NSString *)text {
    
    __weak typeof(self) weakSelf = self;
    NSLog(@"🌰 🌰 🌰 ------》〉写操作");

    dispatch_barrier_sync(self.concurrentQueue, ^{
        __strong typeof(weakSelf) strongSelf = weakSelf;
        strongSelf->_text = text;
        NSLog(@"写操作 %@ %@",text,[NSThread currentThread]);
        // 模拟耗时操作,1个1个执行,没有并发
        sleep(1);
    });
}
// 读操作,这个是可以并发的,log在很快时间打印完
- (NSString *)text {
    
    __block NSString * t = nil ;
    __weak typeof(self) weakSelf = self;
    NSLog(@"🍊 🍊 🍊 读操作1");

    dispatch_sync(self.concurrentQueue, ^{
        __strong typeof(weakSelf) strongSelf = weakSelf;
        NSLog(@"🍍 🍍 🍍 读操作1");

        t = strongSelf->_text;
        // 模拟耗时操作,瞬间执行完,说明是多个线程并发的进入的
        sleep(1);
        
    });
    return t;
    
}


```

打印：

```
2021-06-01 21:23:42.050578+0800 OCTest[49150:1874181] 读写锁测试------------------------------------>
2021-06-01 21:23:42.050872+0800 OCTest[49150:1874181] 🍎 🍎 🍎 写操作1
2021-06-01 21:23:42.051131+0800 OCTest[49150:1874181] 🍎 🍎 🍎 写操作1
2021-06-01 21:23:42.051168+0800 OCTest[49150:1875102] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.051374+0800 OCTest[49150:1874181] 🍎 🍎 🍎 写操作1
2021-06-01 21:23:42.051447+0800 OCTest[49150:1875240] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.051493+0800 OCTest[49150:1875102] 写操作 噼里啪啦--0 <NSThread: 0x600002005680>{number = 4, name = (null)}
2021-06-01 21:23:42.051602+0800 OCTest[49150:1874181] 🍎 🍎 🍎 写操作1
2021-06-01 21:23:42.051671+0800 OCTest[49150:1875241] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.052223+0800 OCTest[49150:1874181] 🍎 🍎 🍎 写操作1
2021-06-01 21:23:42.052290+0800 OCTest[49150:1875242] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.052553+0800 OCTest[49150:1874181] 🍎 🍎 🍎 写操作1
2021-06-01 21:23:42.052642+0800 OCTest[49150:1875243] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.052926+0800 OCTest[49150:1874181] 🍎 🍎 🍎 写操作1
2021-06-01 21:23:42.052992+0800 OCTest[49150:1875244] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.053249+0800 OCTest[49150:1874181] 🍎 🍎 🍎 写操作1
2021-06-01 21:23:42.053349+0800 OCTest[49150:1875245] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.059369+0800 OCTest[49150:1874181] 🍎 🍎 🍎 写操作1
2021-06-01 21:23:42.059459+0800 OCTest[49150:1875246] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.059518+0800 OCTest[49150:1874181] 🍎 🍎 🍎 写操作1
2021-06-01 21:23:42.059570+0800 OCTest[49150:1875247] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.059764+0800 OCTest[49150:1874181] 🍐 🍐 🍐 写操作2
2021-06-01 21:23:42.059770+0800 OCTest[49150:1875248] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.059808+0800 OCTest[49150:1875249] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.059899+0800 OCTest[49150:1874181] 🍐 🍐 🍐 写操作2
2021-06-01 21:23:42.059919+0800 OCTest[49150:1875251] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.059938+0800 OCTest[49150:1875250] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.059977+0800 OCTest[49150:1875252] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060023+0800 OCTest[49150:1875253] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060034+0800 OCTest[49150:1875254] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060085+0800 OCTest[49150:1874181] 🍐 🍐 🍐 写操作2
2021-06-01 21:23:42.060098+0800 OCTest[49150:1875255] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060133+0800 OCTest[49150:1875256] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060181+0800 OCTest[49150:1875257] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060220+0800 OCTest[49150:1875258] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060282+0800 OCTest[49150:1875259] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060295+0800 OCTest[49150:1875260] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060346+0800 OCTest[49150:1875261] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060403+0800 OCTest[49150:1874181] 🍐 🍐 🍐 写操作2
2021-06-01 21:23:42.060405+0800 OCTest[49150:1875263] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060413+0800 OCTest[49150:1875262] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060456+0800 OCTest[49150:1875264] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060489+0800 OCTest[49150:1875265] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060584+0800 OCTest[49150:1875266] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060644+0800 OCTest[49150:1875267] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060683+0800 OCTest[49150:1874181] 🍐 🍐 🍐 写操作2
2021-06-01 21:23:42.060689+0800 OCTest[49150:1875268] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060719+0800 OCTest[49150:1875269] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060760+0800 OCTest[49150:1875270] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060799+0800 OCTest[49150:1875271] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060826+0800 OCTest[49150:1875272] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060879+0800 OCTest[49150:1875273] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060910+0800 OCTest[49150:1875274] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.060941+0800 OCTest[49150:1874181] 🍐 🍐 🍐 写操作2
2021-06-01 21:23:42.060959+0800 OCTest[49150:1875275] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061002+0800 OCTest[49150:1875276] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061048+0800 OCTest[49150:1875277] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061077+0800 OCTest[49150:1875278] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061115+0800 OCTest[49150:1875279] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061187+0800 OCTest[49150:1874181] 🍐 🍐 🍐 写操作2
2021-06-01 21:23:42.061221+0800 OCTest[49150:1875281] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061320+0800 OCTest[49150:1875282] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061327+0800 OCTest[49150:1875283] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061156+0800 OCTest[49150:1875280] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061346+0800 OCTest[49150:1875284] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061405+0800 OCTest[49150:1875285] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061434+0800 OCTest[49150:1875286] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061474+0800 OCTest[49150:1875287] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061510+0800 OCTest[49150:1875288] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061574+0800 OCTest[49150:1875290] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061547+0800 OCTest[49150:1875289] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061636+0800 OCTest[49150:1875291] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061671+0800 OCTest[49150:1875292] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061755+0800 OCTest[49150:1875293] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061819+0800 OCTest[49150:1875294] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061645+0800 OCTest[49150:1874181] 🍐 🍐 🍐 写操作2
2021-06-01 21:23:42.061802+0800 OCTest[49150:1875295] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061935+0800 OCTest[49150:1875297] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.061899+0800 OCTest[49150:1875296] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.062126+0800 OCTest[49150:1875298] 🍊 🍊 🍊 读操作1
2021-06-01 21:23:42.062160+0800 OCTest[49150:1875299] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.062192+0800 OCTest[49150:1874181] 🍐 🍐 🍐 写操作2
2021-06-01 21:23:42.062200+0800 OCTest[49150:1875300] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.062247+0800 OCTest[49150:1875301] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.062274+0800 OCTest[49150:1875302] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:42.062444+0800 OCTest[49150:1874181] 🍐 🍐 🍐 写操作2
2021-06-01 21:23:43.055129+0800 OCTest[49150:1875102] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:43.055269+0800 OCTest[49150:1875240] 写操作 噼里啪啦--1 <NSThread: 0x600002042a80>{number = 7, name = (null)}
2021-06-01 21:23:44.059101+0800 OCTest[49150:1875240] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:44.059136+0800 OCTest[49150:1875244] 写操作 噼里啪啦--5 <NSThread: 0x600002000e80>{number = 8, name = (null)}
2021-06-01 21:23:45.062779+0800 OCTest[49150:1875244] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:45.062808+0800 OCTest[49150:1875243] 写操作 噼里啪啦--4 <NSThread: 0x60000200aa40>{number = 9, name = (null)}
2021-06-01 21:23:46.066867+0800 OCTest[49150:1875243] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:46.066941+0800 OCTest[49150:1875241] 写操作 噼里啪啦--2 <NSThread: 0x60000201ba80>{number = 10, name = (null)}
2021-06-01 21:23:47.072205+0800 OCTest[49150:1875241] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:47.072235+0800 OCTest[49150:1875242] 写操作 噼里啪啦--3 <NSThread: 0x600002052400>{number = 11, name = (null)}
2021-06-01 21:23:48.075550+0800 OCTest[49150:1875242] 🌰 🌰 🌰 ------》〉写操作
2021-06-01 21:23:48.075615+0800 OCTest[49150:1875245] 写操作 噼里啪啦--6 <NSThread: 0x60000200d840>{number = 12, name = (null)}
2021-06-01 21:23:49.079437+0800 OCTest[49150:1875246] 写操作 噼里啪啦--7 <NSThread: 0x60000200ad40>{number = 13, name = (null)}
2021-06-01 21:23:50.083392+0800 OCTest[49150:1875247] 写操作 噼里啪啦--8 <NSThread: 0x60000200d840>{number = 14, name = (null)}
2021-06-01 21:23:51.084361+0800 OCTest[49150:1875268] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:52.085362+0800 OCTest[49150:1875268] 读 噼里啪啦--8 <NSThread: 0x60000200ab40>{number = 15, name = (null)}
2021-06-01 21:23:52.085422+0800 OCTest[49150:1875301] 写操作 噼里啪啦--12 <NSThread: 0x60000200d040>{number = 16, name = (null)}
2021-06-01 21:23:53.086301+0800 OCTest[49150:1875302] 写操作 噼里啪啦--13 <NSThread: 0x600002051e00>{number = 17, name = (null)}
2021-06-01 21:23:54.087017+0800 OCTest[49150:1875253] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:54.087032+0800 OCTest[49150:1875251] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:55.092658+0800 OCTest[49150:1875251] 读 噼里啪啦--13 <NSThread: 0x6000020533c0>{number = 18, name = (null)}
2021-06-01 21:23:55.092658+0800 OCTest[49150:1875253] 读 噼里啪啦--13 <NSThread: 0x60000200d8c0>{number = 19, name = (null)}
2021-06-01 21:23:55.092684+0800 OCTest[49150:1875248] 写操作 噼里啪啦--9 <NSThread: 0x60000200acc0>{number = 20, name = (null)}
2021-06-01 21:23:56.096441+0800 OCTest[49150:1875276] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:56.096442+0800 OCTest[49150:1875278] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:56.096441+0800 OCTest[49150:1875275] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:56.096438+0800 OCTest[49150:1875249] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:57.101096+0800 OCTest[49150:1875276] 读 噼里啪啦--9 <NSThread: 0x60000207a100>{number = 23, name = (null)}
2021-06-01 21:23:57.101100+0800 OCTest[49150:1875249] 读 噼里啪啦--9 <NSThread: 0x600002043900>{number = 22, name = (null)}
2021-06-01 21:23:57.101108+0800 OCTest[49150:1875278] 读 噼里啪啦--9 <NSThread: 0x60000201b580>{number = 24, name = (null)}
2021-06-01 21:23:57.101100+0800 OCTest[49150:1875275] 读 噼里啪啦--9 <NSThread: 0x60000200acc0>{number = 21, name = (null)}
2021-06-01 21:23:57.101141+0800 OCTest[49150:1875300] 写操作 噼里啪啦--11 <NSThread: 0x60000200d880>{number = 25, name = (null)}
2021-06-01 21:23:58.102176+0800 OCTest[49150:1875299] 写操作 噼里啪啦--10 <NSThread: 0x60000201a540>{number = 26, name = (null)}
2021-06-01 21:23:59.104168+0800 OCTest[49150:1875292] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104179+0800 OCTest[49150:1875274] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104169+0800 OCTest[49150:1875277] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104234+0800 OCTest[49150:1875293] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104235+0800 OCTest[49150:1875294] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104239+0800 OCTest[49150:1875295] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104240+0800 OCTest[49150:1875259] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104251+0800 OCTest[49150:1875298] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104262+0800 OCTest[49150:1875260] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104280+0800 OCTest[49150:1875267] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104294+0800 OCTest[49150:1875258] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104301+0800 OCTest[49150:1875266] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104313+0800 OCTest[49150:1875291] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104171+0800 OCTest[49150:1875261] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104345+0800 OCTest[49150:1875289] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104348+0800 OCTest[49150:1875265] 🍍 🍍 2021-06-01 21:23:59.104423+0800 OCTest[49150:1875257] 🍍 🍍 🍍 读操作1
🍍 读操作1
2021-06-01 21:23:59.104382+0800 OCTest[49150:1875272] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104388+0800 OCTest[49150:1875263] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104427+0800 OCTest[49150:1875262] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104427+0800 OCTest[49150:1875296] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104435+0800 OCTest[49150:1875288] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104464+0800 OCTest[49150:1875264] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104497+0800 OCTest[49150:1875297] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104504+0800 OCTest[49150:1875256] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104507+0800 OCTest[49150:1875255] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104510+0800 OCTest[49150:1875269] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104551+0800 OCTest[49150:1875273] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104569+0800 OCTest[49150:1875250] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104573+0800 OCTest[49150:1875287] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104572+0800 OCTest[49150:1875252] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104584+0800 OCTest[49150:1875270] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104607+0800 OCTest[49150:1875254] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104608+0800 OCTest[49150:1875285] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104619+0800 OCTest[49150:1875286] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104664+0800 OCTest[49150:1875280] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104619+0800 OCTest[49150:1875282] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104675+0800 OCTest[49150:1875271] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104667+0800 OCTest[49150:1875283] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104732+0800 OCTest[49150:1875279] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104683+0800 OCTest[49150:1875281] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104712+0800 OCTest[49150:1875284] 🍍 🍍 🍍 读操作1
2021-06-01 21:23:59.104682+0800 OCTest[49150:1875290] 🍍 🍍 🍍 读操作1
2021-06-01 21:24:00.105580+0800 OCTest[49150:1875293] 读 噼里啪啦--10 <NSThread: 0x6000020075c0>{number = 28, name = (null)}
2021-06-01 21:24:00.105592+0800 OCTest[49150:1875292] 读 噼里啪啦--10 <NSThread: 0x60000201c680>{number = 27, name = (null)}
2021-06-01 21:24:00.105594+0800 OCTest[49150:1875294] 读 噼里啪啦--10 <NSThread: 0x600002053ec0>{number = 29, name = (null)}
2021-06-01 21:24:00.105626+0800 OCTest[49150:1875259] 读 噼里啪啦--10 <NSThread: 0x60000200d8c0>{number = 30, name = (null)}
2021-06-01 21:24:00.105657+0800 OCTest[49150:1875295] 读 噼里啪啦--10 <NSThread: 0x60000201e380>{number = 31, name = (null)}
2021-06-01 21:24:00.105678+0800 OCTest[49150:1875277] 读 噼里啪啦--10 <NSThread: 0x600002078a00>{number = 32, name = (null)}
2021-06-01 21:24:00.105699+0800 OCTest[49150:1875274] 读 噼里啪啦--10 <NSThread: 0x600002000e40>{number = 33, name = (null)}
2021-06-01 21:24:00.106405+0800 OCTest[49150:1875298] 读 噼里啪啦--10 <NSThread: 0x60000201e240>{number = 34, name = (null)}
2021-06-01 21:24:00.106839+0800 OCTest[49150:1875260] 读 噼里啪啦--10 <NSThread: 0x60000200d5c0>{number = 35, name = (null)}
2021-06-01 21:24:00.107150+0800 OCTest[49150:1875258] 读 噼里啪啦--10 <NSThread: 0x60000201aa00>{number = 36, name = (null)}
2021-06-01 21:24:00.107471+0800 OCTest[49150:1875289] 读 噼里啪啦--10 <NSThread: 0x600002007a00>{number = 37, name = (null)}
2021-06-01 21:24:00.107824+0800 OCTest[49150:1875291] 读 噼里啪啦--10 <NSThread: 0x600002007800>{number = 38, name = (null)}
2021-06-01 21:24:00.107992+0800 OCTest[49150:1875261] 读 噼里啪啦--10 <NSThread: 0x60000201abc0>{number = 39, name = (null)}
2021-06-01 21:24:00.108320+0800 OCTest[49150:1875252] 读 噼里啪啦--10 <NSThread: 0x60000201be80>{number = 40, name = (null)}
2021-06-01 21:24:00.108564+0800 OCTest[49150:1875287] 读 噼里啪啦--10 <NSThread: 0x600002007a00>{number = 41, name = (null)}
2021-06-01 21:24:00.109351+0800 OCTest[49150:1875266] 读 噼里啪啦--10 <NSThread: 0x60000200c400>{number = 44, name = (null)}
2021-06-01 21:24:00.109350+0800 OCTest[49150:1875256] 读 噼里啪啦--10 <NSThread: 0x600002000cc0>{number = 42, name = (null)}
2021-06-01 21:24:00.109361+0800 OCTest[49150:1875269] 读 噼里啪啦--10 <NSThread: 0x60000201b340>{number = 43, name = (null)}
2021-06-01 21:24:00.109727+0800 OCTest[49150:1875297] 读 噼里啪啦--10 <NSThread: 0x60000201b0c0>{number = 45, name = (null)}
2021-06-01 21:24:00.110234+0800 OCTest[49150:1875288] 读 噼里啪啦--10 <NSThread: 0x60000200d600>{number = 48, name = (null)}
2021-06-01 21:24:00.109838+0800 OCTest[49150:1875264] 读 噼里啪啦--10 <NSThread: 0x600002007640>{number = 46, name = (null)}
2021-06-01 21:24:00.110236+0800 OCTest[49150:1875296] 读 噼里啪啦--10 <NSThread: 0x60000201bcc0>{number = 47, name = (null)}
2021-06-01 21:24:00.110339+0800 OCTest[49150:1875255] 读 噼里啪啦--10 <NSThread: 0x60000200d780>{number = 49, name = (null)}
2021-06-01 21:24:00.110921+0800 OCTest[49150:1875273] 读 噼里啪啦--10 <NSThread: 0x600002000dc0>{number = 51, name = (null)}
2021-06-01 21:24:00.110915+0800 OCTest[49150:1875250] 读 噼里啪啦--10 <NSThread: 0x600002051fc0>{number = 50, name = (null)}
2021-06-01 21:24:00.110934+0800 OCTest[49150:1875257] 读 噼里啪啦--10 <NSThread: 0x6000020077c0>{number = 52, name = (null)}
2021-06-01 21:24:00.113876+0800 OCTest[49150:1875263] 读 噼里啪啦--10 <NSThread: 0x6000020074c0>{number = 55, name = (null)}
2021-06-01 21:24:00.113849+0800 OCTest[49150:1875265] 读 噼里啪啦--10 <NSThread: 0x600002052940>{number = 54, name = (null)}
2021-06-01 21:24:00.113963+0800 OCTest[49150:1875272] 读 噼里啪啦--10 <NSThread: 0x600002000d40>{number = 57, name = (null)}
2021-06-01 21:24:00.113920+0800 OCTest[49150:1875262] 读 噼里啪啦--10 <NSThread: 0x600002079f40>{number = 56, name = (null)}
2021-06-01 21:24:00.113849+0800 OCTest[49150:1875267] 读 噼里啪啦--10 <NSThread: 0x60000207a6c0>{number = 53, name = (null)}
2021-06-01 21:24:00.119015+0800 OCTest[49150:1875285] 读 噼里啪啦--10 <NSThread: 0x60000201e480>{number = 59, name = (null)}
2021-06-01 21:24:00.119016+0800 OCTest[49150:1875271] 读 噼里啪啦--10 <NSThread: 0x60000200d740>{number = 60, name = (null)}
2021-06-01 21:24:00.119015+0800 OCTest[49150:1875286] 读 噼里啪啦--10 <NSThread: 0x600002051d00>{number = 58, name = (null)}
2021-06-01 21:24:00.119033+0800 OCTest[49150:1875280] 读 噼里啪啦--10 <NSThread: 0x600002079f80>{number = 61, name = (null)}
2021-06-01 21:24:00.119056+0800 OCTest[49150:1875270] 读 噼里啪啦--10 <NSThread: 0x600002001540>{number = 62, name = (null)}
2021-06-01 21:24:00.119073+0800 OCTest[49150:1875282] 读 噼里啪啦--10 <NSThread: 0x60000200d800>{number = 63, name = (null)}
2021-06-01 21:24:00.119088+0800 OCTest[49150:1875254] 读 噼里啪啦--10 <NSThread: 0x60000207a0c0>{number = 64, name = (null)}
2021-06-01 21:24:00.119491+0800 OCTest[49150:1875283] 读 噼里啪啦--10 <NSThread: 0x60000201c6c0>{number = 65, name = (null)}
2021-06-01 21:24:00.119494+0800 OCTest[49150:1875281] 读 噼里啪啦--10 <NSThread: 0x600002000dc0>{number = 66, name = (null)}
2021-06-01 21:24:00.119555+0800 OCTest[49150:1875290] 读 噼里啪啦--10 <NSThread: 0x60000201ad00>{number = 67, name = (null)}
2021-06-01 21:24:00.119707+0800 OCTest[49150:1875279] 读 噼里啪啦--10 <NSThread: 0x600002002040>{number = 68, name = (null)}
2021-06-01 21:24:00.119911+0800 OCTest[49150:1875102] 写操作 噼里啪啦--14 <NSThread: 0x600002005680>{number = 4, name = (null)}
2021-06-01 21:24:00.119914+0800 OCTest[49150:1875284] 读 噼里啪啦--10 <NSThread: 0x60000201b580>{number = 69, name = (null)}
2021-06-01 21:24:01.121618+0800 OCTest[49150:1875240] 写操作 噼里啪啦--15 <NSThread: 0x600002042a80>{number = 7, name = (null)}
2021-06-01 21:24:02.122389+0800 OCTest[49150:1875244] 写操作 噼里啪啦--16 <NSThread: 0x600002000e80>{number = 8, name = (null)}
2021-06-01 21:24:03.124373+0800 OCTest[49150:1875243] 写操作 噼里啪啦--17 <NSThread: 0x60000200aa40>{number = 9, name = (null)}
2021-06-01 21:24:04.125953+0800 OCTest[49150:1875241] 写操作 噼里啪啦--18 <NSThread: 0x60000201ba80>{number = 10, name = (null)}
2021-06-01 21:24:05.131037+0800 OCTest[49150:1875242] 写操作 噼里啪啦--19 <NSThread: 0x600002052400>{number = 11, name = (null)}


```

![读写序列图](https://raw.githubusercontent.com/harleyGit/StudyNotes/master/Pictures/multithread1.png)


根据上面的打印，我们重点关注写的打印：写操作 噼里啪啦--1 和 🍍 字样，其他的都是烟雾弹。我们再结合上面的线程时序图可以看到，一般都是等到栅栏都完成后再执行其他的。所以一般都是先写前10个，再是读，然后接着写。


<br/>

下面贴上一个AFN的实现 , requestHeaderModificationQueue是一个由AFHTTPRequestSerializer创建的并发队列, 使用这个并发队列对一个NSMutableDictionary实现了多读单写的锁.



```
self.requestHeaderModificationQueue = dispatch_queue_create("requestHeaderModificationQueue", DISPATCH_QUEUE_CONCURRENT);

```

![](https://raw.githubusercontent.com/harleyGit/StudyNotes/master/Pictures/multithread0.png)



<br/>

**使用pthread_rwlock 互斥锁（会休眠）**

![](https://raw.githubusercontent.com/harleyGit/StudyNotes/master/Pictures/multithread2.png)

<br/>

```
#import <pthread.h>

@property (assign, nonatomic) pthread_rwlock_t lock;


- (void) testAction {
    
    [self testMethod3];
    
}


//读写互斥锁测试
- (void) testMethod3 {
    // 初始化锁
        pthread_rwlock_init(&_lock, NULL);
        
        dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
        
        for (int i = 0; i < 5; i++) {
            dispatch_async(queue, ^{
                [self read];
            });
            dispatch_async(queue, ^{
                [self write];
            });
        }
}

- (void)read {
    //读锁
    pthread_rwlock_rdlock(&_lock);
    
    sleep(1);
    NSLog(@"🍎 🍎 %s", __func__);
    
    pthread_rwlock_unlock(&_lock);
}

- (void)write
{
    //写锁
    pthread_rwlock_wrlock(&_lock);
    
    sleep(1);
    NSLog(@"🍊 🍊 %s", __func__);
    
    pthread_rwlock_unlock(&_lock);
}
```

打印：

```
021-06-01 22:30:57.268204+0800 OCTest[50381:1928202] 🍎 🍎 -[ViewController read]
2021-06-01 22:30:58.272268+0800 OCTest[50381:1928423] 🍊 🍊 -[ViewController write]
2021-06-01 22:30:59.275954+0800 OCTest[50381:1928424] 🍎 🍎 -[ViewController read]
2021-06-01 22:31:00.280702+0800 OCTest[50381:1928425] 🍊 🍊 -[ViewController write]
2021-06-01 22:31:01.283694+0800 OCTest[50381:1928426] 🍎 🍎 -[ViewController read]
2021-06-01 22:31:02.284539+0800 OCTest[50381:1928427] 🍊 🍊 -[ViewController write]
2021-06-01 22:31:03.285518+0800 OCTest[50381:1928428] 🍎 🍎 -[ViewController read]
2021-06-01 22:31:04.286463+0800 OCTest[50381:1928429] 🍊 🍊 -[ViewController write]
2021-06-01 22:31:05.287468+0800 OCTest[50381:1928430] 🍎 🍎 -[ViewController read]
2021-06-01 22:31:06.288403+0800 OCTest[50381:1928431] 🍊 🍊 -[ViewController write]
```



<br/>

***
<br/>